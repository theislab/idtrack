<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>idtrack._database_manager &mdash; idtrack 0.0.3 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom_cookietemple.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/dark_mode_css/general.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/dark_mode_css/dark.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="../../_static/dark_mode_js/default_light.js"></script>
        <script src="../../_static/dark_mode_js/theme_switcher.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> idtrack
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code_of_conduct.html">Contributor Covenant Code of Conduct</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">idtrack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>idtrack._database_manager</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for idtrack._database_manager</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># Kemal Inecik</span>
<span class="c1"># k.inecik@gmail.com</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pymysql.cursors</span>

<span class="kn">from</span> <span class="nn">._db</span> <span class="kn">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">._external_databases</span> <span class="kn">import</span> <span class="n">ExternalDatabases</span>


<div class="viewcode-block" id="DatabaseManager"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager">[docs]</a><span class="k">class</span> <span class="nc">DatabaseManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Downloads, preprocesses, and stores the necessary source files for the program.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">organism</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ensembl_release</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">form</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">local_repository</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ignore_before</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_after</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">compress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">store_raw_always</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">genome_assembly</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class initialization.</span>

<span class="sd">        Args:</span>
<span class="sd">            organism: Formal organism name. The output provided by :py:class:`VerifyOrganism` would be</span>
<span class="sd">                a perfect choice.</span>
<span class="sd">            ensembl_release: Ensembl release of interest. The object will work on only given Ensembl release, but some</span>
<span class="sd">                methods does not care which form the DatabaseManager is defined to.</span>
<span class="sd">                The latest possible Ensembl release is the best choice for graph building with no drawbacks.</span>
<span class="sd">            form: Either &#39;gene&#39;, &#39;transcript&#39; or &#39;translation&#39;. The object will work on only given form, but some</span>
<span class="sd">                methods does not care which form the DatabaseManager is defined to.</span>
<span class="sd">            local_repository: An absolute path in local machine to store downloaded and preprocessed content.</span>
<span class="sd">            ignore_before: Ensembl release as the lower limit to include in the downloaded contents. The object will</span>
<span class="sd">                ignore all Ensembl release lower than this integer.</span>
<span class="sd">            ignore_after: Similar to &#39;ignore_before&#39; but as the upper limit as the name suggest.</span>
<span class="sd">            compress: If ``True``, the resulting content will be compressed to take less space in the disk.</span>
<span class="sd">            store_raw_always: If ``True``, the raw MySQL tables will be also saved in the disk.</span>
<span class="sd">            genome_assembly: Genome assembly of interest. The selection should be one of the keys in the</span>
<span class="sd">                :py:attr:`DB.assembly_mysqlport_priority` dictionary. The object will work on only given assembly.</span>
<span class="sd">                The default is the latest genome assembly (also called highest priority assembly).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: When the input parameters are not in the specified format.</span>
<span class="sd">            NotImplementedError: Currently only supports &#39;homo_sapiens&#39; as the organism name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">organism</span> <span class="o">!=</span> <span class="s2">&quot;homo_sapiens&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Organisms other than human is not implemented. In theory, it should work but &quot;</span>
                <span class="s2">&quot;no tests have been conducted yet. In the next version of the package, other &quot;</span>
                <span class="s2">&quot;organisms will be available. Please note that adding new organisms necessitates &quot;</span>
                <span class="s2">&quot;to determine which external databases to include using ExternalDatabase class.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">genome_assembly</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Set default genome assembly when not specified specifically.</span>
            <span class="n">genome_assembly</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Priority&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">][</span>
                <span class="mi">1</span>
            <span class="p">]</span>  <span class="c1"># Have the most important priority genome assembly as the default value.</span>

        <span class="c1"># MYSQL Settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span> <span class="o">=</span> <span class="n">genome_assembly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mysql_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">DB</span><span class="o">.</span><span class="n">mysql_host</span><span class="p">,</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">DB</span><span class="o">.</span><span class="n">myqsl_user</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">DB</span><span class="o">.</span><span class="n">mysql_togo</span><span class="p">,</span>
            <span class="c1"># Port depends on which genome assembly is of interest. Refer to the following link.</span>
            <span class="c1"># https://www.ensembl.org/info/data/mysql.html</span>
            <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="p">][</span><span class="s2">&quot;Port&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># The logger for informing the user about the progress.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;database_manager&quot;</span><span class="p">)</span>

        <span class="c1"># Instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span> <span class="o">=</span> <span class="n">local_repository</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ensembl_release</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">organism</span> <span class="o">=</span> <span class="n">organism</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="n">form</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="n">compress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span> <span class="o">=</span> <span class="n">store_raw_always</span>
        <span class="c1"># If ignore_before is not specified clearly, than use the lowest possible priority defined by the MySQL server.</span>
        <span class="n">default_min_er</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;MinRelease&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">ignore_before</span> <span class="k">if</span> <span class="n">ignore_before</span> <span class="k">else</span> <span class="n">default_min_er</span>
        <span class="c1"># If ignore_after is not specified, than set it to infinite.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignore_after</span> <span class="k">if</span> <span class="n">ignore_after</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="c1"># Protected attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_form_of_interests</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">forms_in_order</span><span class="p">)</span>  <span class="c1"># Warning: the order is important.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_version_info</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;add_version&quot;</span><span class="p">,</span> <span class="s2">&quot;without_version&quot;</span><span class="p">,</span> <span class="s2">&quot;with_version&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_hdf5</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;complevel&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;complib&quot;</span><span class="p">:</span> <span class="s2">&quot;blosc:zlib&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column_sep</span> <span class="o">=</span> <span class="s2">&quot;_COL_&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]</span>

        <span class="c1"># Check if it seems ok.</span>
        <span class="n">checkers</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1"># In very early releases, there are floating ensembl releases like &quot;18.2&quot;. This package does not support.</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">ensembl_release</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">ensembl_release</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_releases</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_form_of_interests</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="o">&lt;</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="p">][</span><span class="s2">&quot;MinRelease&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">checkers</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;DatabaseManager&#39; could not pass the &#39;checkers&#39;: </span><span class="si">{</span><span class="n">checkers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Makes the instance status to be inspected by the user easily.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;DatabaseManager instance:</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Organism: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Form: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Ensembl Release: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Genome Assembly: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Ignore Before: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Ignore After: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Local Repository: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Compress: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Store Raw Always: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">external_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExternalDatabases</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create an instance of :py:class:`ExternalDatabases` and set as a property.</span>

<span class="sd">        The parameters of the DatabaseManager instance will be directly passed in the creation of the</span>
<span class="sd">        `ExternalDatabases` instance so they will be consistent with each other.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An ExternalDatabases instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ExternalDatabases</span><span class="p">(</span>
            <span class="n">organism</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="p">,</span>
            <span class="n">ensembl_release</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
            <span class="n">local_repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span>
            <span class="n">genome_assembly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">available_releases</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Define available Ensembl releases for the DatabaseManager instance to work on.</span>

<span class="sd">        It looks on the MySQL server results to determine which Ensembl releases are available. The method does not</span>
<span class="sd">        return directly the Ensembl releases defined by &#39;ignore_after&#39; and &#39;ignore_before&#39; parameters, and looks on the</span>
<span class="sd">        server as a verification.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of integers indicating which Ensembl releases are available.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Unexpected error in regex functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all possible ensembl releases for a given organism</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;availabledatabases&quot;</span><span class="p">)</span>  <span class="c1"># Obtain the databases dataframe</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">_core_([0-9]+)_.+$&quot;</span><span class="p">)</span>
        <span class="c1"># Search organism name in a specified format. Extract ensembl release number</span>
        <span class="n">releases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dbs_i</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">dbs_i</span><span class="p">):</span>
                <span class="n">dbs_ps</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">dbs_i</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dbs_ps</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="n">releases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dbs_ps</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Get rid of floating ensembl releases if exists: In very early releases, there are floating releases</span>
        <span class="c1"># like &quot;18.2&quot;. This Python package does not support those.</span>
        <span class="n">floating_ensembl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">releases_final</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">releases_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">floating_ensembl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">floating_ensembl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Some ensembl releases are included for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;There are floating ensembl releases: </span><span class="si">{</span><span class="n">floating_ensembl</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Sort in ascending order and return the result.</span>
        <span class="n">releases_final</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">releases_final</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span> <span class="o">&gt;=</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span>  <span class="c1"># Filter out the releases that are not of interest.</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">releases_final</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">mysql_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The program has to choose a &#39;MySQL database&#39; based on ensembl release and organism name in the MYSQL server.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The string specifying the &#39;MySQL database&#39; in the format determined by the regex pattern.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If there is more than one such match.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;availabledatabases&quot;</span><span class="p">)</span>  <span class="c1"># Obtain the databases dataframe</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">_core_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="p">)</span><span class="si">}</span><span class="s2">_.+$&quot;</span><span class="p">)</span>
        <span class="n">located</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dbs</span> <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="c1"># Search database in a specified format. Extract ensembl release number</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">located</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;There are more than one &#39;MySQL database&#39; in the server &quot;</span>
                <span class="s2">&quot;satisfying given ensembl release and organism name.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Make sure there are only one database in the server satisfying given ensembl release and organism name.</span>

        <span class="k">return</span> <span class="n">located</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="DatabaseManager.change_form"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.change_form">[docs]</a>    <span class="k">def</span> <span class="nf">change_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DatabaseManager&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Changes the form of DatabaseManager instance with passing all other variables unchanged.</span>

<span class="sd">        Args:</span>
<span class="sd">            form: New form of interest. Refer to :py:attr:`DatabaseManager.__init__.form`</span>

<span class="sd">        Returns:</span>
<span class="sd">            New instance of DatabaseManager with only &#39;form&#39; is changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DatabaseManager</span><span class="p">(</span>
            <span class="n">organism</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="p">,</span>
            <span class="n">ensembl_release</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
            <span class="n">local_repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span>
            <span class="n">ignore_before</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">,</span>
            <span class="n">ignore_after</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span><span class="p">,</span>
            <span class="n">compress</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">,</span>
            <span class="n">store_raw_always</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">,</span>
            <span class="n">genome_assembly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager.change_release"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.change_release">[docs]</a>    <span class="k">def</span> <span class="nf">change_release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ensembl_release</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DatabaseManager&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Changes the Ensembl release of DatabaseManager instance with passing all other variables unchanged.</span>

<span class="sd">        Args:</span>
<span class="sd">            ensembl_release: New Ensembl release of interest.</span>
<span class="sd">                Refer to :py:attr:`DatabaseManager.__init__.ensembl_release`</span>

<span class="sd">        Returns:</span>
<span class="sd">            New instance of DatabaseManager with only &#39;ensembl_release&#39; is changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DatabaseManager</span><span class="p">(</span>
            <span class="n">organism</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="p">,</span>
            <span class="n">ensembl_release</span><span class="o">=</span><span class="n">ensembl_release</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
            <span class="n">local_repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span>
            <span class="n">ignore_before</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">,</span>
            <span class="n">ignore_after</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span><span class="p">,</span>
            <span class="n">compress</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">,</span>
            <span class="n">store_raw_always</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">,</span>
            <span class="n">genome_assembly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager.change_assembly"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.change_assembly">[docs]</a>    <span class="k">def</span> <span class="nf">change_assembly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genome_assembly</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DatabaseManager&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Changes the genome assembly of DatabaseManager instance with passing all other variables unchanged.</span>

<span class="sd">        Args:</span>
<span class="sd">            genome_assembly: New genome assembly of interest.</span>
<span class="sd">                Refer to :py:attr:`DatabaseManager.__init__.genome_assembly`</span>

<span class="sd">        Returns:</span>
<span class="sd">            New instance of DatabaseManager with only &#39;genome_assembly&#39; is changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DatabaseManager</span><span class="p">(</span>
            <span class="n">organism</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="p">,</span>
            <span class="n">ensembl_release</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
            <span class="n">local_repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span>
            <span class="n">ignore_before</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">,</span>
            <span class="n">ignore_after</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span><span class="p">,</span>
            <span class="n">compress</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">,</span>
            <span class="n">store_raw_always</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">,</span>
            <span class="n">genome_assembly</span><span class="o">=</span><span class="n">genome_assembly</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager.create_available_databases"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_available_databases">[docs]</a>    <span class="k">def</span> <span class="nf">create_available_databases</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetches all the databases in the MySQL server of the instance.</span>

<span class="sd">        Filters out the query ``SHOW databases`` based on matching to a specific regex string</span>
<span class="sd">        ``f&quot;^{self.organism}_core_[0-9]+_.+$&quot;``</span>

<span class="sd">        Returns:</span>
<span class="sd">            All available &#39;MySQL databases&#39; in the server for given assembly (which is a parameter in the</span>
<span class="sd">            `DatabaseManager` instance).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the response has unexpected format or length.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Available MySQL databases for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;assembly and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="si">}</span><span class="s2"> release is being fetched.&quot;</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mysql_settings</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SHOW databases&quot;</span><span class="p">)</span>
                <span class="n">results_query</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results_query</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The result is in unexpected format.&quot;</span><span class="p">)</span>
        <span class="n">results_query</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results_query</span><span class="p">]</span>  <span class="c1"># Get the relevant portion.</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">_core_[0-9]+_.+$&quot;</span><span class="p">)</span>
        <span class="n">accepted_databases</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results_query</span> <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">accepted_databases</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="DatabaseManager.get_table"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.get_table">[docs]</a>    <span class="k">def</span> <span class="nf">get_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">usecols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_even_if_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_after_calculation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">overwrite_even_if_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Master method for MySQL processes. Downloads, stores, or retrieves the database of raw MySQL results.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_key: The raw MySQL database (table) of interest. For example `mapping_session`, `xref`, `gene`.</span>
<span class="sd">            usecols: The column of interest in the specified table. Short for &#39;use columns&#39;.</span>
<span class="sd">            create_even_if_exist: If ``True``, independent of the status in the disk, the table will be downloaded.</span>
<span class="sd">            save_after_calculation: If ``True``, the downloaded table will be stored in the disk, under a `h5` file at</span>
<span class="sd">                the local directory specified in init method.</span>
<span class="sd">            overwrite_even_if_exist: If ``True``, regardless of whether it is already saved in the disk, the program</span>
<span class="sd">                re-saves removing the previous table with the same name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Raw table as a pandas DataFrame.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the &#39;usecols&#39; is not specified correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">usecols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">usecols</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">usecols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Empty &#39;usecols&#39; parameter, or &#39;usecols&#39; is not a list.&quot;</span><span class="p">)</span>

        <span class="c1"># Get the file name associated with table_key and columns of interest.</span>
        <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="n">table_key</span><span class="p">,</span> <span class="n">usecols</span><span class="p">)</span>

        <span class="c1"># If the file name is not accessible for reading, or if the hdf5 file does not contain the table,</span>
        <span class="c1"># or explicitly prompt to do so, then download the table.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">create_even_if_exist</span>
            <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">check_h5_key</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_table</span><span class="p">(</span><span class="n">table_key</span><span class="p">,</span> <span class="n">usecols</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise, just read the file that is already in the directory.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_exported</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># If prompt, save the dataframe in requested format.</span>
        <span class="k">if</span> <span class="n">save_after_calculation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_disk</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">overwrite_even_if_exist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DatabaseManager.download_table"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.download_table">[docs]</a>    <span class="k">def</span> <span class="nf">download_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">usecols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Downloads the raw table from MySQL server and extracts requested columns.</span>

<span class="sd">        The method is not generally expected to be used by the user. User is expected to use &#39;get_table&#39; instead.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_key: The raw MySQL database (table) of interest. For example `mapping_session`, `xref`, `gene`.</span>
<span class="sd">            usecols: The column of interest in the specified table. Short for &#39;use columns&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Raw table as a pandas DataFrame.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If there is no column in the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Base settings for MYSQL server.</span>
        <span class="n">which_mysql_server</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mysql_settings</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_database</span><span class="p">})</span>

        <span class="c1"># Connect to the MYSQL server, close the connection after the code block</span>
        <span class="k">with</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">which_mysql_server</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>

            <span class="c1"># Create a cursor to be able to make some queries: First get the associated column names.</span>
            <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur1</span><span class="p">:</span>
                <span class="n">cur1</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHOW columns FROM </span><span class="si">{</span><span class="n">table_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">column_names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cur1</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There is no column in the table&quot;</span><span class="p">)</span>

                <span class="c1"># The MYSQL sever before &#39;DB.mysql_port_min_version&#39; gives the result as bytes, but</span>
                <span class="c1"># the one after gives as string.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c1"># Convert everything to string to be consistent.</span>
                    <span class="n">column_names</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="c1"># Just to make sure conversion is successful, no problem is expected to arise afterwards.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_sep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>

            <span class="c1"># Create a cursor to be able to make some queries: Second get the associated table content.</span>
            <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur2</span><span class="p">:</span>
                <span class="c1"># Convert the list of column names into string to be used in MYSQL query</span>
                <span class="n">usecol_sql</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">usecols</span><span class="p">)</span> <span class="k">if</span> <span class="n">usecols</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">cur2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">usecols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">usecol_sql</span><span class="si">}</span><span class="s2"> FROM </span><span class="si">{</span><span class="n">table_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Fetch all the content and save as a tuple file.</span>
                <span class="n">results_content</span> <span class="o">=</span> <span class="n">cur2</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="c1"># Create a dataframe using the columns fetched.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results_content</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_names</span> <span class="k">if</span> <span class="n">usecols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">usecols</span><span class="p">)</span>
            <span class="c1"># Make sure the content does not contain any bytes object.</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">))):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>

            <span class="n">info_usecols</span> <span class="o">=</span> <span class="s2">&quot; for following columns: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">usecols</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="k">if</span> <span class="n">usecols</span> <span class="k">else</span> <span class="s2">&quot;.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Raw table for &#39;</span><span class="si">{</span><span class="n">table_key</span><span class="si">}</span><span class="s2">&#39; on ensembl release &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;was downloaded</span><span class="si">{</span><span class="n">info_usecols</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DatabaseManager.available_tables_mysql"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.available_tables_mysql">[docs]</a>    <span class="k">def</span> <span class="nf">available_tables_mysql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetches all the tables in the MySQL database of the instance.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Not implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="DatabaseManager.get_release_date"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.get_release_date">[docs]</a>    <span class="k">def</span> <span class="nf">get_release_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the associated date of release for each Ensembl release.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Note implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="DatabaseManager._determine_usecols_ids"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager._determine_usecols_ids">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_determine_usecols_ids</span><span class="p">(</span><span class="n">form</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Helper method to guide which columns are interesting for each form.</span>

<span class="sd">        Args:</span>
<span class="sd">            form: Form of interest</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of lists to be used further in the main methods.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If form is not either &#39;gene&#39;, &#39;transcript&#39;, or &#39;translation&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stable_id_version</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">form</span> <span class="o">==</span> <span class="s2">&quot;gene&quot;</span><span class="p">:</span>
            <span class="n">usecols_core</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gene_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stable_id_version</span>
            <span class="n">usecols_asso</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gene_id&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">form</span> <span class="o">==</span> <span class="s2">&quot;transcript&quot;</span><span class="p">:</span>
            <span class="n">usecols_core</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;transcript_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stable_id_version</span>
            <span class="n">usecols_asso</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;transcript_id&quot;</span><span class="p">,</span> <span class="s2">&quot;gene_id&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">form</span> <span class="o">==</span> <span class="s2">&quot;translation&quot;</span><span class="p">:</span>
            <span class="n">usecols_core</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;translation_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stable_id_version</span>
            <span class="n">usecols_asso</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;translation_id&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript_id&quot;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Form has to be one of </span><span class="si">{</span><span class="n">DB</span><span class="o">.</span><span class="n">forms_in_order</span><span class="si">}</span><span class="s2">. Input form is &#39;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stable_id_version</span><span class="p">,</span> <span class="n">usecols_core</span><span class="p">,</span> <span class="n">usecols_asso</span></div>

<div class="viewcode-block" id="DatabaseManager.create_ids"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_ids">[docs]</a>    <span class="k">def</span> <span class="nf">create_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieves the Ensembl IDs.</span>

<span class="sd">        Args:</span>
<span class="sd">            form: Form of interest, either &#39;gene&#39;, &#39;transcript&#39;, or &#39;translation&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dataframe of three columns: `gene_id`, `gene_stable_id`, and `gene_version`. The &#39;ID&#39; and &#39;Version&#39; need to</span>
<span class="sd">            be concatanated afterwards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine which columns are interesting for each form.</span>
        <span class="n">stable_id_version</span><span class="p">,</span> <span class="n">usecols_core</span><span class="p">,</span> <span class="n">usecols_asso</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">_determine_usecols_ids</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># In order to have the same column order with below exception code block.</span>
            <span class="n">usecols</span> <span class="o">=</span> <span class="n">usecols_core</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">usecols_asso</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usecols_core</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">usecols</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
            <span class="c1"># Earlier versions has different table for stable_id.</span>
            <span class="c1"># When there is no associated column for a given table, the following error will be raised.</span>

        <span class="k">except</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">usecols_core</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
            <span class="n">df_2</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">usecols_asso</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">form</span> <span class="o">!=</span> <span class="s2">&quot;gene&quot;</span>
                <span class="k">else</span> <span class="n">df</span><span class="p">[</span><span class="n">usecols_asso</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;one_to_one&quot;</span><span class="p">)</span>

        <span class="c1"># Remove rows with NaN stable_id if exists</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
        <span class="c1"># Convert all IDs to int except stable_id and version.</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">usecols_asso</span> <span class="o">+</span> <span class="n">usecols_core</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stable_id_version</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stable_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>  <span class="c1"># Convert stable_ids to string</span>

        <span class="c1"># Rename to prevent any conflicts in the package</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;stable_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Remove duplicates if exists</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_uniformize</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">version_str</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager.create_relation_current"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_relation_current">[docs]</a>    <span class="k">def</span> <span class="nf">create_relation_current</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieves the relationship between different forms of Ensembl IDs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dataframe of three columns: `gene`, `transcript`, and `translation`. Note that there are some empty cells</span>
<span class="sd">            in `translation` column as not all transcripts has translations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get required gene, transcript and translation IDs</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;idsraw_gene&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;idsraw_transcript&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;idsraw_translation&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>

        <span class="c1"># Combine them into one</span>
        <span class="n">tgp</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">g</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;gene_id&quot;</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_one&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;transcript_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;one_to_one&quot;</span><span class="p">)</span>
        <span class="n">tgp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gene_id&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript_id&quot;</span><span class="p">,</span> <span class="s2">&quot;translation_id&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_relation_helper</span><span class="p">(</span><span class="n">tgp</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager.create_relation_archive"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_relation_archive">[docs]</a>    <span class="k">def</span> <span class="nf">create_relation_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieves the relationship between different forms of Ensembl IDs for all Ensembl releases.</span>

<span class="sd">        It is not recommended as there are some missing rows. Instead use</span>
<span class="sd">        :py:meth:`DatabaseManager.create_relation_current` for all Ensembl releases separately, and</span>
<span class="sd">        concatanate the resulting data frames.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dataframe of three columns: `gene`, `transcript`, and `translation`. Note that there are some empty cells</span>
<span class="sd">            in `translation` column as not all transcripts has translations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not recommended method: Use &#39;create_relation_current&#39; instead.&quot;</span><span class="p">)</span>
        <span class="c1"># Get the table from the server</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;gene_archive&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
        <span class="c1"># Remove unnecessary columns and return.</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;peptide_archive_id&quot;</span><span class="p">,</span> <span class="s2">&quot;mapping_session_id&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_relation_helper</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager._create_relation_helper"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager._create_relation_helper">[docs]</a>    <span class="k">def</span> <span class="nf">_create_relation_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper method for creating &#39;relationship&#39; dataframes for two methods.</span>

<span class="sd">        The two methods is :py:meth:`DatabaseManager.create_relation_current` and</span>
<span class="sd">        :py:meth:`DatabaseManager.create_relation_archive`. The method is not expected to be used by</span>
<span class="sd">        the user.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Output of these two methods mentioned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dataframe of three columns `gene`, `transcript`, and `translation`. Note that there are some empty</span>
<span class="sd">            cells in `translation` column as not all transcripts has translations.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the input dataframe is not with the correct number of columns or column names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure there are correct number and name of columns</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;gene_stable_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gene_version&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transcript_stable_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transcript_version&quot;</span><span class="p">,</span>
            <span class="s2">&quot;translation_stable_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;translation_version&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span> <span class="o">==</span> <span class="mi">6</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># Process the dataframe</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript&quot;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
            <span class="c1"># Transcript may have different version info than gene.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_form</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">version_fix</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">]:</span>
            <span class="c1"># Translation may have different version info than gene/transcript.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_form</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">version_fix_incomplete</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>  <span class="c1"># due to np.nans</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gene_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;translation_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript_stable_id&quot;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript&quot;</span><span class="p">,</span> <span class="s2">&quot;translation&quot;</span><span class="p">]:</span>
            <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_form</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">id_ver_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]])</span>

        <span class="c1"># Drop duplicates if exists and return.</span>
        <span class="n">res</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="DatabaseManager.create_id_history"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_id_history">[docs]</a>    <span class="k">def</span> <span class="nf">create_id_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">narrow</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieves historical releationship between Ensembl IDs of a given form.</span>

<span class="sd">        Args:</span>
<span class="sd">            narrow:  Determine whether a some more information should be added between Ensembl gene IDs. For example,</span>
<span class="sd">                which genome assembly is used, or when was the connection is established. For usual uses, no need to</span>
<span class="sd">                set it ``True``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dataframe of following columns; `old_stable_id`, `old_version`, `new_stable_id`, `new_version`, `score`,</span>
<span class="sd">            `old_release`, `new_release`. Note that there are some empty cells in new and old Ensembl IDs, since</span>
<span class="sd">            there are &#39;retirement&#39; events or &#39;birth&#39; events of IDs.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the delimiter :py:attr:`DB.id_ver_delimiter` is in Ensembl IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the tables from the server</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;stable_id_event&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;mapping_session&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>

        <span class="c1"># Combine them into one and filter only the form of interest.</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;mapping_session_id&quot;</span><span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="n">sm</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">narrow</span><span class="p">:</span>
            <span class="c1"># Remove some unnecessary columns if prompt so.</span>
            <span class="n">sm</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;mapping_session_id&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;old_db_name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;new_db_name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;old_assembly&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;new_assembly&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;created&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Correct the version based on version_info for each old_stable_id and new_stable_id columns.</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_fix_incomplete</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_fix_incomplete</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="s2">&quot;old_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;old_version&quot;</span><span class="p">),</span> <span class="s2">&quot;new_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;new_version&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Convert np.nan&#39;s to &quot;&quot; so that saving to hdf5 file is not a problem.</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;new_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;old_stable_id&quot;</span><span class="p">]:</span>
            <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="s2">&quot;old_release&quot;</span><span class="p">,</span> <span class="s2">&quot;new_release&quot;</span><span class="p">]:</span>
            <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">sm</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># 0 means no information according to ensembl.</span>

        <span class="c1"># Check the delimiter is not in the ID.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="s2">&quot;new_stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">id_ver_delimiter</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="s2">&quot;old_stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">id_ver_delimiter</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1"># No need to check for version as it can be already float or int by fix_stable_events</span>

        <span class="n">sm</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span> <span class="o">&gt;=</span> <span class="n">sm</span><span class="p">[</span><span class="s2">&quot;old_release&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="s2">&quot;old_release&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">)]</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Remove duplicates if exists</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sm</span></div>

<div class="viewcode-block" id="DatabaseManager.create_id_history_fixed"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_id_history_fixed">[docs]</a>    <span class="k">def</span> <span class="nf">create_id_history_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">narrow</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">inspect</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Depracated method alternative for &#39;create_id_history&#39;, which also corrects the resulting dataframe.</span>

<span class="sd">        This method created a fixed version of idhistory. It fixes the problems seen in some exceptional cases like</span>
<span class="sd">        Homo sapiens ``ENSG00000232423`` at release 105. Raw version gives the order of versions as follows: 1-2, 2-3,</span>
<span class="sd">        1-2, 2-3 and so on. However, after second connection, version 1 should be already lost, the last active version</span>
<span class="sd">        should be 3. For this reason, 1-2 connection should be corrected as 3-2. This method does this.</span>

<span class="sd">        Args:</span>
<span class="sd">            narrow: The same parameter in :py:attr:`DatabaseManager.create_id_history.narrow`.</span>
<span class="sd">            inspect: If inspect is ``True``, then add the newly created columns as new ones into the existing one.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dataframe of following columns: `old_stable_id`, `old_version`, `new_stable_id`, `new_version`, `score`,</span>
<span class="sd">            `old_release`, `new_release`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the raw version of idhistory first, and sort.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;idhistory&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">narrow</span> <span class="k">else</span> <span class="s2">&quot;idhistory_narrow&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;new_release&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Initialize some temp variables</span>
        <span class="n">extinct_version</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">last_active_version</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">corrected_entries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">changed_old</span><span class="p">,</span> <span class="n">changed_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="c1"># If old_stable_id and new_stable_id is different, then we are not interested in those; because extinction</span>
            <span class="c1"># of specific version does not have to exist. For example, it can basically branch.</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_stable_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;new_stable_id&quot;</span><span class="p">]:</span>  <span class="c1"># not of interested</span>
                <span class="k">continue</span>

            <span class="c1"># Self-loops are also not of interest, because it does not cause a specific version of an ID to be extinct.</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;new_version&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">row_key</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_stable_id&quot;</span><span class="p">]</span>
                <span class="c1"># If old_stable_id not seen before in the temp dictionaries, then basically add.</span>
                <span class="k">if</span> <span class="n">row_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extinct_version</span><span class="p">:</span>
                    <span class="n">extinct_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">last_active_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Add the version into the set.</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_version&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extinct_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]:</span>
                    <span class="n">extinct_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_version&quot;</span><span class="p">])</span>
                    <span class="c1"># Save the last active version</span>
                    <span class="n">last_active_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># If old_version is already seen before.</span>
                    <span class="c1"># Replace the value in the database with the last_active_version&#39;s associated rows.</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="s2">&quot;old_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_active_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">][</span><span class="s2">&quot;new_version&quot;</span><span class="p">]</span>
                    <span class="n">changed_old</span><span class="p">,</span> <span class="n">changed_new</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_version&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;new_version&quot;</span><span class="p">]</span>

                <span class="c1"># If new_version is seen, then basically remove it.</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;new_version&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">extinct_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]:</span>
                    <span class="n">extinct_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span> <span class="o">-=</span> <span class="p">{</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;new_version&quot;</span><span class="p">]}</span>

            <span class="c1"># If inspect is on, then add the changed parameters.</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="p">:</span>
                <span class="n">corrected_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">changed_old</span><span class="p">,</span> <span class="n">changed_new</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="c1"># If inspect is on, then add these columns as new ones into the existing one.</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="p">:</span>
            <span class="n">ce</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">corrected_entries</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;unfixed_old_version&quot;</span><span class="p">,</span> <span class="s2">&quot;unfixed_new_version&quot;</span><span class="p">])</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">ce</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DatabaseManager.create_external_db"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_external_db">[docs]</a>    <span class="k">def</span> <span class="nf">create_external_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieves External identifier relationship. Returns the connections or databases only.</span>

<span class="sd">        The method actually based on a rationele to the following MySQL query, not exactly but quite close to the</span>
<span class="sd">        following query.</span>

<span class="sd">        .. code-block:: sql</span>

<span class="sd">            SELECT g.stable_id, t.stable_id, tr.stable_id, x.dbprimary_acc, edb.db_name, es.synonym, ix.*</span>
<span class="sd">            FROM gene g</span>
<span class="sd">            JOIN transcript t USING (gene_id)</span>
<span class="sd">            JOIN translation tr USING (transcript_id)</span>
<span class="sd">            JOIN object_xref ox ON (g.gene_id = ox.ensembl_id AND ox.ensembl_object_type = &quot;Gene&quot;)</span>
<span class="sd">            JOIN xref x ON (ox.xref_id = x.xref_id)</span>
<span class="sd">            LEFT JOIN external_db edb ON (x.external_db_id = edb.external_db_id)</span>
<span class="sd">            LEFT JOIN identity_xref ix ON (ox.object_xref_id = ix.object_xref_id)</span>
<span class="sd">            LEFT JOIN external_synonym es ON (x.xref_id = es.xref_id)</span>
<span class="sd">            LIMIT 10;</span>

<span class="sd">        Instead of ``FROM gene g``, it is possible to be a bit more specific by replacing the following:</span>

<span class="sd">        .. code-block:: sql</span>

<span class="sd">            FROM coord_system cs</span>
<span class="sd">            JOIN seq_region sr USING (coord_system_id)</span>
<span class="sd">            JOIN gene g USING (seq_region_id)</span>

<span class="sd">        The MySQL server can be following for the experimentation purpose.</span>

<span class="sd">        .. code-block:: bash</span>

<span class="sd">            mysql --user=anonymous --host=ensembldb.ensembl.org -D homo_sapiens_core_105_38 -A</span>
<span class="sd">            # As written in the following link.</span>
<span class="sd">            # https://m.ensembl.org/info/docs/api/core/core_schema.html</span>

<span class="sd">        Args:</span>
<span class="sd">            filter_mode: Determine what to return after retrieving the data.</span>
<span class="sd">                One of the followings: `relevant`, `all`, `database`, `relevant-database`.</span>

<span class="sd">                - `relevant` and `all`:</span>
<span class="sd">                  Returns the relationship information. &#39;all&#39; returns all relationships while</span>
<span class="sd">                  &#39;relevant&#39; returns only those indicated by ``ExternalDatabases`` class.</span>
<span class="sd">                  The result is a dataframe with &#39;release&#39;, &#39;graph_id&#39;, &#39;id_db&#39;, &#39;name_db&#39;, &#39;ensembl_identity&#39;, and</span>
<span class="sd">                  &#39;xref_identity&#39;.</span>
<span class="sd">                - `database` and `relevant-database`:</span>
<span class="sd">                  Returns the a dataframe indicating databases. The resulting dataframe</span>
<span class="sd">                  contain two columns: &#39;name_db&#39; and &#39;count&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dataframe of specifified type via ``filter_mode``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If incorrect entry for ``filter_mode`` parameter, or if there is an inconsistency between</span>
<span class="sd">                external `yaml` file and current state of ``DatabaseManager``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the necessary tables from the server</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;save_after_calculation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">}</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;idsraw_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
        <span class="n">ox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span>
            <span class="s2">&quot;object_xref&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ensembl_object_type&quot;</span><span class="p">,</span> <span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="s2">&quot;object_xref_id&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">m</span>
        <span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;xref&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="s2">&quot;external_db_id&quot;</span><span class="p">,</span> <span class="s2">&quot;dbprimary_acc&quot;</span><span class="p">,</span> <span class="s2">&quot;display_label&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">m</span><span class="p">)</span>
        <span class="n">ed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;external_db&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;external_db_id&quot;</span><span class="p">,</span> <span class="s2">&quot;db_name&quot;</span><span class="p">,</span> <span class="s2">&quot;db_display_name&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">m</span><span class="p">)</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;identity_xref&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ensembl_identity&quot;</span><span class="p">,</span> <span class="s2">&quot;xref_identity&quot;</span><span class="p">,</span> <span class="s2">&quot;object_xref_id&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">m</span><span class="p">)</span>
        <span class="n">es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;external_synonym&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="s2">&quot;synonym&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">m</span><span class="p">)</span>

        <span class="c1"># Make entities in synonyms table appended to the xref file as additional lines</span>
        <span class="n">es</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_one&quot;</span><span class="p">)</span>
        <span class="n">es</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;display_label&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">es</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;synonym&quot;</span><span class="p">:</span> <span class="s2">&quot;display_label&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">es</span><span class="p">[</span><span class="s2">&quot;display_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">synonym_id_nodes_prefix</span> <span class="o">+</span> <span class="n">es</span><span class="p">[</span><span class="s2">&quot;display_label&quot;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">es</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Merge the tables as requested</span>
        <span class="n">comb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">a</span><span class="p">,</span>
            <span class="n">ox</span><span class="p">[</span><span class="n">ox</span><span class="p">[</span><span class="s2">&quot;ensembl_object_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">lower</span><span class="p">()],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_id&quot;</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;one_to_many&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">comb</span> <span class="o">=</span> <span class="n">comb</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_many&quot;</span><span class="p">)</span>
        <span class="n">comb</span> <span class="o">=</span> <span class="n">comb</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ed</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;external_db_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_one&quot;</span><span class="p">)</span>
        <span class="n">comb</span> <span class="o">=</span> <span class="n">comb</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;object_xref_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_one&quot;</span><span class="p">)</span>

        <span class="c1"># Remove unnecessary columns and reset the index.</span>
        <span class="n">stable_id_version</span><span class="p">,</span> <span class="n">usecols_core</span><span class="p">,</span> <span class="n">usecols_asso</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">_determine_usecols_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="n">ids_only</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">usecols_asso</span> <span class="o">+</span> <span class="n">usecols_core</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">stable_id_version</span><span class="p">))</span>
        <span class="n">comb</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">,</span> <span class="s2">&quot;object_xref_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ensembl_object_type&quot;</span><span class="p">,</span> <span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="s2">&quot;external_db_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ids_only</span><span class="p">,</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">comb</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Processing the merged dataframe</span>

        <span class="c1"># Constants for the processing</span>
        <span class="n">identities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ensembl_identity&quot;</span><span class="p">,</span> <span class="s2">&quot;xref_identity&quot;</span><span class="p">]</span>
        <span class="n">db_id</span> <span class="o">=</span> <span class="s2">&quot;id_db&quot;</span>
        <span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;name_db&quot;</span>
        <span class="n">id_graph</span> <span class="o">=</span> <span class="s2">&quot;graph_id&quot;</span>
        <span class="n">count_col</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>

        <span class="k">def</span> <span class="nf">comb_renamer</span><span class="p">(</span><span class="n">col_list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">col_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">db_id</span><span class="p">,</span> <span class="n">col_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">db_name</span><span class="p">}</span>

        <span class="c1"># Create &quot;ID.Version&quot;</span>
        <span class="c1"># No need for version_uniformize as the gene_ids are obtained from create_id</span>
        <span class="n">comb_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_ver_from_df</span><span class="p">(</span><span class="n">comb</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">]))</span>
        <span class="c1"># Basically split below columns as separate rows and rename the columns.</span>
        <span class="n">comb_3_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;display_label&quot;</span><span class="p">,</span> <span class="s2">&quot;db_display_name&quot;</span><span class="p">]</span>
        <span class="n">comb_4_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dbprimary_acc&quot;</span><span class="p">,</span> <span class="s2">&quot;db_name&quot;</span><span class="p">]</span>
        <span class="n">comb_3</span><span class="p">,</span> <span class="n">comb_4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">comb_3</span><span class="p">[</span><span class="n">id_graph</span><span class="p">],</span> <span class="n">comb_4</span><span class="p">[</span><span class="n">id_graph</span><span class="p">]</span> <span class="o">=</span> <span class="n">comb_temp</span><span class="p">,</span> <span class="n">comb_temp</span>
        <span class="n">comb_3</span><span class="p">[</span><span class="n">comb_3_columns</span> <span class="o">+</span> <span class="n">identities</span><span class="p">]</span> <span class="o">=</span> <span class="n">comb</span><span class="p">[</span><span class="n">comb_3_columns</span> <span class="o">+</span> <span class="n">identities</span><span class="p">]</span>
        <span class="n">comb_4</span><span class="p">[</span><span class="n">comb_4_columns</span> <span class="o">+</span> <span class="n">identities</span><span class="p">]</span> <span class="o">=</span> <span class="n">comb</span><span class="p">[</span><span class="n">comb_4_columns</span> <span class="o">+</span> <span class="n">identities</span><span class="p">]</span>
        <span class="n">comb_3</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">comb_renamer</span><span class="p">(</span><span class="n">comb_3_columns</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
        <span class="n">comb_4</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">comb_renamer</span><span class="p">(</span><span class="n">comb_4_columns</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
        <span class="n">comb_3</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">comb_4</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">comb_3</span><span class="p">,</span> <span class="n">comb_4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">id_graph</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="n">res</span><span class="p">[</span><span class="n">db_id</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">db_name</span><span class="p">,</span> <span class="n">id_graph</span><span class="p">,</span> <span class="n">db_id</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Add the release information at the leftmost place</span>
        <span class="n">res</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;release&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">))))</span>

        <span class="c1"># Convert some columns type for convenience.</span>
        <span class="n">res</span><span class="p">[</span><span class="n">identities</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">identities</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="n">identities</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">identities</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;release&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;release&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>

        <span class="c1"># Drop duplicates if exists. Note that it is not trivial, there are many duplicated lines after adding</span>
        <span class="c1"># these columns as rows. Because, for some of them, comb_X_columns are actually the same.</span>
        <span class="n">res</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Change the synonym IDs&#39; database name</span>
        <span class="n">to_add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">DB</span><span class="o">.</span><span class="n">synonym_id_nodes_prefix</span> <span class="k">if</span> <span class="n">i</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">db_id</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">synonym_id_nodes_prefix</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_add</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span>
        <span class="c1"># Unless you specifically look at synonyms, they will not mean the same thing as the counterparts.</span>
        <span class="c1"># They will be used as the bridging point in the pathfinder algorithm only.</span>

        <span class="k">if</span> <span class="n">filter_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;relevant&quot;</span><span class="p">,</span> <span class="s2">&quot;relevant-database&quot;</span><span class="p">]:</span>
            <span class="c1"># In order to prevent the search space to be too big and to prevent unnecessary data to be kept in the disk</span>
            <span class="c1"># and in the memory.</span>
            <span class="n">isin_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_inst</span><span class="o">.</span><span class="n">give_list_for_case</span><span class="p">(</span><span class="n">give_type</span><span class="o">=</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>
            <span class="n">available_databases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">il</span> <span class="ow">in</span> <span class="n">available_databases</span> <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="n">isin_list</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inconsistency between external yaml file and current state of DatabaseManager.&quot;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">isin_list</span><span class="p">)]</span>

        <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;relevant&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">elif</span> <span class="n">filter_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;relevant-database&quot;</span><span class="p">]:</span>
            <span class="n">databases</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">])</span><span class="o">.</span><span class="n">most_common</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">db_name</span><span class="p">,</span> <span class="n">count_col</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">databases</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span></div>

<div class="viewcode-block" id="DatabaseManager.create_database_content"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_database_content">[docs]</a>    <span class="k">def</span> <span class="nf">create_database_content</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrives all External database information from the server to feed the ``ExternalDatabase`` class.</span>

<span class="sd">        It is quite costly operation, potentially takes time to be completed. It helps ``ExternalDatabase`` class to</span>
<span class="sd">        create the ``yaml`` file mentioned. It downloads for all assemblies, all Ensembl releases and all forms</span>
<span class="sd">        available.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The output of ``create_external_db`` when `filter_mode` `relevant-database`. Adds `assembly`, `release`,</span>
<span class="sd">            and `form` columns to the resulting dataframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># For all assemblies possible.</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_form_of_interests</span><span class="p">:</span>  <span class="c1"># For all assemblies possible.</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_releases</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Database content is being created for &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">&#39;, assembly &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, form &#39;</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&#39;, ensembl release &#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>
                    <span class="n">df_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_assembly</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">change_release</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">change_form</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;external_database&quot;</span><span class="p">)</span>
                    <span class="n">df_temp</span><span class="p">[</span><span class="s2">&quot;assembly&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="n">df_temp</span><span class="p">[</span><span class="s2">&quot;release&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">df_temp</span><span class="p">[</span><span class="s2">&quot;form&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_temp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;organism&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">organism</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DatabaseManager.create_release_id"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_release_id">[docs]</a>    <span class="k">def</span> <span class="nf">create_release_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieves the Ensembl IDs and applies `version_fix` method to refine it.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dataframe with ``f&#39;{form}_stable_id&#39;`` and ``f&#39;{form}_version&#39;``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the delimiter :py:attr:`DB.id_ver_delimiter` is in Ensembl IDs, or if the stable IDs are</span>
<span class="sd">                not unique.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbm_the_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;idsraw_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dbm_the_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_fix</span><span class="p">(</span><span class="n">dbm_the_ids</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">)</span>
        <span class="n">dbm_the_ids</span> <span class="o">=</span> <span class="n">dbm_the_ids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dbm_the_ids</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">id_ver_delimiter</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The delimiter is in Ensembl IDs.&quot;</span><span class="p">)</span>

        <span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbm_the_ids</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The stable IDs are not unique&quot;</span><span class="p">)</span>

        <span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dbm_the_ids</span></div>

<div class="viewcode-block" id="DatabaseManager.create_external_all"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_external_all">[docs]</a>    <span class="k">def</span> <span class="nf">create_external_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Download external databases for all assemblies.</span>

<span class="sd">        The method considers the &#39;priority&#39; of the assemblies indicated in</span>
<span class="sd">        :py:attr:`DB.assembly_mysqlport_priority`. The method is not found in &#39;get_db&#39; so the result is not saved.</span>

<span class="sd">        Args:</span>
<span class="sd">            return_mode: Either one of three choices `all`, `unique`, `duplicated`. There is currently no use case for</span>
<span class="sd">                `unique`, `duplicated` by the program.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Returns the relationship information indicated by ``ExternalDatabases`` class.</span>
<span class="sd">            The result is a dataframe with &#39;release&#39;, &#39;graph_id&#39;, &#39;id_db&#39;, &#39;name_db&#39;, &#39;ensembl_identity&#39;, and</span>
<span class="sd">            &#39;xref_identity&#39;, and also &#39;assembly&#39;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `return_mode` is not among the possible ones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_inst</span><span class="o">.</span><span class="n">give_list_for_case</span><span class="p">(</span><span class="n">give_type</span><span class="o">=</span><span class="s2">&quot;assembly&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">assembly_priority</span> <span class="o">=</span> <span class="p">[</span><span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Priority&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ass</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">assembly_priority</span><span class="p">,</span> <span class="n">ass</span><span class="p">))]:</span>  <span class="c1"># sort according to priority</span>
            <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_assembly</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">df_temp</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;external_relevant&quot;</span><span class="p">)</span>
            <span class="n">df_temp</span><span class="p">[</span><span class="s2">&quot;assembly&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_temp</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">compare_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s2">&quot;assembly&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_identity&quot;</span><span class="p">)</span>
        <span class="p">]</span>  <span class="c1"># &#39;ensembl_identity&#39;, &#39;xref_identity&#39;</span>
        <span class="n">compare_columns_2</span> <span class="o">=</span> <span class="n">compare_columns</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;assembly&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">return_mode</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="c1"># Drop duplicate rows that have all the columns the same with another row in the dataframe.</span>
            <span class="c1"># This also looks for &#39;assembly&#39; columns so it is possible to say assemlies are evaluated separately.</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">compare_columns_2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">elif</span> <span class="n">return_mode</span> <span class="o">==</span> <span class="s2">&quot;unique&quot;</span><span class="p">:</span>
            <span class="c1"># Unlike above, this does not also look for &#39;assembly&#39; columns, so an entry found in the higher priority</span>
            <span class="c1"># assembly will be kept but the others will be removed.</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">compare_columns</span><span class="p">)</span>
            <span class="c1"># Note that: after transition to new assembly. ensembl does not assign new versions etc to the older</span>
            <span class="c1"># keep the most priority one.</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">elif</span> <span class="n">return_mode</span> <span class="o">==</span> <span class="s2">&quot;duplicated&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">compare_columns</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
            <span class="n">dfg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">compare_columns</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dfg</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Undefined parameter for &#39;return_mode&#39;: </span><span class="si">{</span><span class="n">return_mode</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager.create_version_info"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_version_info">[docs]</a>    <span class="k">def</span> <span class="nf">create_version_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check whether all Ensembl release has Ensembl IDs with versions or without versions.</span>

<span class="sd">        Some organisms such as S. cerevisiae has Ensembl identifiers that has no &#39;Version&#39;, but only &#39;ID&#39;. The method</span>
<span class="sd">        looks whether this is the case for all the Ensembl releases for a given organism.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dataframe with two columns as `ensembl_release`, `version_info`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If some Ensembl identifiers without versions, some are not.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ver</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_releases</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">db_manager_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_release</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">df_ids</span> <span class="o">=</span> <span class="n">db_manager_temp</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;idsraw_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
            <span class="n">_vv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df_ids</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_vv</span><span class="p">):</span>
                <span class="n">with_version</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">_vv</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Some identifiers with versions that are NaN, some are not.&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">with_version</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">ver</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">with_version</span><span class="p">])</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ver</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ensembl_release&quot;</span><span class="p">,</span> <span class="s2">&quot;version_info&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DatabaseManager.get_db"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.get_db">[docs]</a>    <span class="k">def</span> <span class="nf">get_db</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df_indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">create_even_if_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_after_calculation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">overwrite_even_if_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;For saving, exporting, and naming convention. Main method to retrieve the data sources.</span>

<span class="sd">        Args:</span>
<span class="sd">            df_indicator: A string indicating which dataframe the user is requested to access.</span>
<span class="sd">                It should contain only one or zero &#39;_&#39; character.</span>
<span class="sd">            create_even_if_exist: If ``True``, independent of the status in the disk, the table will be downloaded.</span>
<span class="sd">            save_after_calculation: If ``True``, the downloaded table will be stored in the disk, under a `h5` file at</span>
<span class="sd">                the local directory specified in init method.</span>
<span class="sd">            overwrite_even_if_exist: If ``True``, regardless of whether it is already saved in the disk, the program</span>
<span class="sd">                re-saves removing the previous table with the same name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The data of interest depending on `df_indicator` parameter.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `df_indicator` parameter is not in specified format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">check_exist_as_diff_release</span><span class="p">(</span><span class="n">_df_type</span><span class="p">,</span> <span class="n">_df_indicator</span><span class="p">):</span>

            <span class="c1"># Get the file name associated with table_key and columns of interest.</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="n">_df_type</span><span class="p">,</span> <span class="n">_df_indicator</span><span class="p">)</span>

            <span class="c1"># The below pattern is based on file_name function with some modifications.</span>
            <span class="c1"># Organism name and form is excluded as it does not change the resulting file.</span>
            <span class="n">_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ens([0-9]+)_</span><span class="si">{</span><span class="n">_df_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">_df_indicator</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">_file_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">_file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">_keys</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">_downloaded_rels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="nb">int</span><span class="p">(</span><span class="n">_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_keys</span> <span class="k">if</span> <span class="n">_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">i</span><span class="p">)})</span>

            <span class="k">for</span> <span class="n">_dr</span> <span class="ow">in</span> <span class="n">_downloaded_rels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_dr</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_dr</span><span class="p">,</span> <span class="n">_downloaded_rels</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_downloaded_rels</span>

        <span class="k">def</span> <span class="nf">remove_redundant_exist</span><span class="p">(</span><span class="n">_df_type</span><span class="p">,</span> <span class="n">_df_indicator</span><span class="p">,</span> <span class="n">_keep_rel</span><span class="p">,</span> <span class="n">_all_rel_lst</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">_arl</span> <span class="ow">in</span> <span class="n">_all_rel_lst</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_arl</span> <span class="o">!=</span> <span class="n">_keep_rel</span><span class="p">:</span>
                    <span class="n">_hi</span><span class="p">,</span> <span class="n">_fi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="n">_df_type</span><span class="p">,</span> <span class="n">_df_indicator</span><span class="p">,</span> <span class="n">ensembl_release</span><span class="o">=</span><span class="n">_arl</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">_fi</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Following file is being removed: &#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">_fi</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; with key &#39;</span><span class="si">{</span><span class="n">_hi</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;This could cause hdf5 file to not reclaim the emptied disk space.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_hi</span><span class="p">)</span>

        <span class="c1"># Split the df_indicator with &quot;_&quot;, to get the extra parameters.</span>
        <span class="c1"># Main point of naming and df_indicator is to include the paramters in the file_names</span>
        <span class="c1"># for exporting and importing without writing explicit methods of read/write for each case.</span>
        <span class="n">split_ind</span> <span class="o">=</span> <span class="n">df_indicator</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">main_ind</span> <span class="o">=</span> <span class="n">split_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">param1_ind</span> <span class="o">=</span> <span class="n">split_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># For &#39;availabledatabases&#39; accept different files explained in the below functions.</span>
        <span class="k">if</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;availabledatabases&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xr1</span><span class="p">,</span> <span class="n">xr1_a</span> <span class="o">=</span> <span class="n">check_exist_as_diff_release</span><span class="p">(</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">)</span>
            <span class="n">remove_redundant_exist</span><span class="p">(</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">,</span> <span class="n">xr1</span><span class="p">,</span> <span class="n">xr1_a</span><span class="p">)</span>
            <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">,</span> <span class="n">ensembl_release</span><span class="o">=</span><span class="n">xr1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;versioninfo&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xr1</span><span class="p">,</span> <span class="n">xr1_a</span> <span class="o">=</span> <span class="n">check_exist_as_diff_release</span><span class="p">(</span><span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">)</span>
            <span class="n">remove_redundant_exist</span><span class="p">(</span><span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">,</span> <span class="n">xr1</span><span class="p">,</span> <span class="n">xr1_a</span><span class="p">)</span>
            <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">,</span> <span class="n">ensembl_release</span><span class="o">=</span><span class="n">xr1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">main_ind</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;relationarchive&quot;</span><span class="p">,</span> <span class="s2">&quot;relationcurrent&quot;</span><span class="p">):</span>
            <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get the file name associated with table_key and columns of interest.</span>
            <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">)</span>

        <span class="c1"># If the file name is not accessible for reading, or if the hdf5 file does not contain the table,</span>
        <span class="c1"># or explicitly prompt to do so, then download the table.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">create_even_if_exist</span>
            <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">check_h5_key</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">))</span>
        <span class="p">):</span>

            <span class="k">if</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;external&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_external_db</span><span class="p">(</span><span class="n">filter_mode</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;external&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;relevant&quot;</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;relevant-database&quot;</span><span class="p">]:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_external_db</span><span class="p">(</span><span class="n">filter_mode</span><span class="o">=</span><span class="n">param1_ind</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;idsraw&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">param1_ind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_form_of_interests</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;idsraw&#39; should be used together with one &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;of followings: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_form_of_interests</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_ids</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">param1_ind</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;ids&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_release_id</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;externalcontent&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_database_content</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;relationcurrent&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_relation_current</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;relationarchive&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_relation_archive</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;idhistory&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_id_history</span><span class="p">(</span><span class="n">narrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;idhistory&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="o">==</span> <span class="s2">&quot;narrow&quot;</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_id_history</span><span class="p">(</span><span class="n">narrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;versioninfo&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_version_info</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;availabledatabases&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_available_databases</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected entry for &#39;df_indicator&#39;.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise, just read the file that is already in the directory.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_exported</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># If prompt, save the dataframe in requested format.</span>
        <span class="k">if</span> <span class="n">save_after_calculation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_disk</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">overwrite_even_if_exist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DatabaseManager.read_exported"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.read_exported">[docs]</a>    <span class="k">def</span> <span class="nf">read_exported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Read the data souces saved previously given h5 file path and the &#39;h5 key&#39;.</span>

<span class="sd">        The method is not expected to be used by the user.</span>

<span class="sd">        Args:</span>
<span class="sd">            hierarchy: The key to retrieve the associated table in h5 file.</span>
<span class="sd">            file_path: Absolute path for h5 file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The table of interest as a pandas object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If the file indicated by `file_path` is not exist or not readable.</span>
<span class="sd">            KeyError: If there is no key `hierarchy` in the ``h5`` file defined by `file_path`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;The file is not exist or not readable.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">check_h5_key</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">hierarchy</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DatabaseManager.file_name"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.file_name">[docs]</a>    <span class="k">def</span> <span class="nf">file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ensembl_release</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Determine file name for reading/writing into h5 file based on dataframe type.</span>

<span class="sd">        The method is not expected to be used by the user.</span>

<span class="sd">        Args:</span>
<span class="sd">            df_type: Either `processed`, `mysql`, `common`.</span>
<span class="sd">            args: Arguments to pass into the functions, which are specific to each ``df_type``.</span>
<span class="sd">            ensembl_release: Associated Ensembl release of the file of interest.</span>
<span class="sd">            kwargs: Keyword arguments to pass into the functions, which are specific to each ``df_type``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The file name for h5 file and the key to be used inside.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the parameter `df_type` is not in specified format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ensembl_release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ensembl_release</span> <span class="k">else</span> <span class="n">ensembl_release</span>

        <span class="k">def</span> <span class="nf">file_name_processed</span><span class="p">(</span><span class="n">df_indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ens</span><span class="si">{</span><span class="n">ensembl_release</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_indicator</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">def</span> <span class="nf">file_name_mysql</span><span class="p">(</span><span class="n">table_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">usecols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">col_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_sep</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">usecols</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">usecols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ens</span><span class="si">{</span><span class="n">ensembl_release</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">table_key</span><span class="si">}{</span><span class="n">col_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">def</span> <span class="nf">file_name_noform</span><span class="p">(</span><span class="n">df_indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ens</span><span class="si">{</span><span class="n">ensembl_release</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_indicator</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">df_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="s2">&quot;common&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter is not in specified format: df_type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;processed&quot;</span><span class="p">:</span>
            <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">file_name_processed</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span><span class="p">:</span>
            <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">file_name_noform</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">file_name_mysql</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hierarchy</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">_assembly-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="si">}</span><span class="s2">.h5&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager.export_disk"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.export_disk">[docs]</a>    <span class="k">def</span> <span class="nf">export_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span> <span class="n">hierarchy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stored the pandas object into the given h5 file with specified key.</span>

<span class="sd">        The method is not expected to be used by the user.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: The table to stor into the disk.</span>
<span class="sd">            hierarchy: The key to retrieve the associated table in h5 file.</span>
<span class="sd">            file_path: Absolute path for h5 file.</span>
<span class="sd">            overwrite: If ``True``, regardless of whether it is already saved in the disk, the program</span>
<span class="sd">                re-saves removing the previous table with the same name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span> <span class="ow">or</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">check_h5_key</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">)):</span>

            <span class="c1"># Remove the file first to prevent hdf5 file to go arbitrarily larger after writing.</span>
            <span class="k">if</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">check_h5_key</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">)</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">hierarchy</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Following file is being removed: &#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;with key &#39;</span><span class="si">{</span><span class="n">hierarchy</span><span class="si">}</span><span class="s2">&#39;. This could cause hdf5 file to not reclaim the &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;newly emptied disk space.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">)</span>
            <span class="c1"># Then save the dataframe under the root, compressed.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Exporting to the following file &#39;</span><span class="si">{</span><span class="n">base_file_path</span><span class="si">}</span><span class="s2">&#39; with key &#39;</span><span class="si">{</span><span class="n">hierarchy</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="k">else</span> <span class="s1">&#39;, uncompressed&#39;</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">hierarchy</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_comp_hdf5</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager.check_h5_key"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.check_h5_key">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_h5_key</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check whether the given key is in the h5 file.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: Absolute path for h5 file.</span>
<span class="sd">            key: The key to retrieve the associated table in h5 file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            If there is such  a key ``True``, else ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span></div>

<div class="viewcode-block" id="DatabaseManager.repack_hdf5"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.repack_hdf5">[docs]</a>    <span class="k">def</span> <span class="nf">repack_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remove_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Repack h5 file.</span>

<span class="sd">        When a table is removed by the h5 file, the associated space is not reclaimed by the operating system. The</span>
<span class="sd">        method here circumvents the problem by removing h5 files completely and re-writing all the tables.</span>

<span class="sd">        Args:</span>
<span class="sd">            remove_list: Table keys to exclude from re-writing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="s2">&quot;place_holder&quot;</span><span class="p">)</span>
        <span class="n">old_name</span> <span class="o">=</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_to_delete_temp&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">old_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Repacking the h5 file: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">all_keys</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">remove_list</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">all_keys</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_keys</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remove_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_exported</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">old_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">export_disk</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager.tables_in_disk"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.tables_in_disk">[docs]</a>    <span class="k">def</span> <span class="nf">tables_in_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Retrieves the keys in the h5 file, which is associated with the DatabaseManager instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of keys (also called hierarchy) in the h5 file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="s2">&quot;place_holder&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="DatabaseManager.id_ver_from_df"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.id_ver_from_df">[docs]</a>    <span class="k">def</span> <span class="nf">id_ver_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbm_the_ids</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates node names given the dataframe of IDs, which has different columns for &#39;ID&#39; and &#39;Version&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            dbm_the_ids: Dataframe of IDs, typically the output of ``db_manager.get_db(&quot;ids&quot;)``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Node name as &quot;ID.Version&quot; if there is &#39;Version&#39;, else only &quot;ID&quot;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If column names of the `dbm_the_ids` is not as expected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Column names of the &#39;dbm_the_ids&#39; is not as expected. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">gri_generator</span> <span class="o">=</span> <span class="p">(</span><span class="n">DatabaseManager</span><span class="o">.</span><span class="n">node_dict_maker</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">DatabaseManager</span><span class="o">.</span><span class="n">node_name_maker</span><span class="p">,</span> <span class="n">gri_generator</span><span class="p">))</span></div>

<div class="viewcode-block" id="DatabaseManager.node_name_maker"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.node_name_maker">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">node_name_maker</span><span class="p">(</span><span class="n">node_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function creates ID-Version.</span>

<span class="sd">        If the Version information is not there, it only uses ID, which is necessary for some organisms which</span>
<span class="sd">        does not have versioned IDs.</span>

<span class="sd">        Args:</span>
<span class="sd">            node_dict: The output of :py:meth:`DatabaseManager.node_dict_maker`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Node name as &quot;ID.Version&quot; if there is &#39;Version&#39;, else only &quot;ID&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_dict</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">node_dict</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">node_dict</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">DB</span><span class="o">.</span><span class="n">id_ver_delimiter</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_dict</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node_dict</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="DatabaseManager.node_dict_maker"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.node_dict_maker">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">node_dict_maker</span><span class="p">(</span><span class="n">id_entry</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version_entry</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create a dict for ID and Version.</span>

<span class="sd">        Args:</span>
<span class="sd">            id_entry: For example, the first part of (`ENSG00000000001`) in `ENSG00000000001.1` before delimiter.</span>
<span class="sd">            version_entry: For example, the second part of (`1`) in `ENSG00000000001.1` before delimiter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary in the format of ``{&quot;ID&quot;: id_entry, &quot;Version&quot;: version_entry}``</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If &#39;Version&#39; is not floating number (cannot be converted into integer).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">version_entry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">version_entry</span><span class="p">)</span> <span class="ow">and</span> <span class="n">version_entry</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">alternative_versions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_entry</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="n">version_entry</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version is floating: </span><span class="si">{</span><span class="p">(</span><span class="n">id_entry</span><span class="p">,</span> <span class="n">version_entry</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version_entry</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_entry</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="n">id_entry</span><span class="p">,</span> <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="n">version_entry</span><span class="p">}</span></div>

<div class="viewcode-block" id="DatabaseManager.version_uniformize"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.version_uniformize">[docs]</a>    <span class="k">def</span> <span class="nf">version_uniformize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">version_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Final operation for :py:meth:`DatabaseManager.create_ids`.</span>

<span class="sd">        The method is not expected to be used by the user.</span>

<span class="sd">        Make the &#39;Version&#39; column, integer if there is &#39;Version&#39; information, else, make put ``np.nan`` instead. The</span>
<span class="sd">        operation is in line with :py:meth:`DatabaseManager.create_version_info` method.</span>
<span class="sd">        Note that ``np.nan`` values will be used by `node_name_maker` and `node_name_maker` methods.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Input dataframe, see the `create_ids` method for more detail.</span>
<span class="sd">            version_str: Which column contain the &#39;Version&#39; information</span>

<span class="sd">        Returns:</span>
<span class="sd">            Corrected version of the dataframe in terms of &#39;Version&#39; information.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If some Ensembl identifiers without versions, some are not.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contains_na</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">contains_na</span><span class="p">):</span>
            <span class="c1"># If there is no version information associated with stable_ids. For some organisms like S. cerevisiae</span>
            <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">contains_na</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Some identifiers with versions that are NaN, some are not.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DatabaseManager.version_fix_incomplete"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.version_fix_incomplete">[docs]</a>    <span class="k">def</span> <span class="nf">version_fix_incomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_fx</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">id_col_fx</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ver_col_fx</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The same logic with ``version_fix`` method, but do different process if associated &#39;ID&#39; is ``np.nan``.</span>

<span class="sd">        Args:</span>
<span class="sd">            df_fx: Input dataframe to fix the version information.</span>
<span class="sd">            id_col_fx: Which column contain the &#39;ID&#39; information.</span>
<span class="sd">            ver_col_fx: Which column contain the &#39;Version&#39; information.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Modified dataframe in terms of version information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the columns that do not have any id</span>
        <span class="n">na_cols_fx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df_fx</span><span class="p">[</span><span class="n">id_col_fx</span><span class="p">])</span>

        <span class="c1"># Split the dataframe to process separately</span>
        <span class="n">df_fm1</span><span class="p">,</span> <span class="n">df_fm2</span> <span class="o">=</span> <span class="n">df_fx</span><span class="p">[</span><span class="n">na_cols_fx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">df_fx</span><span class="p">[</span><span class="o">~</span><span class="n">na_cols_fx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">version_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_version_info</span><span class="p">()</span>
        <span class="n">df_fm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_fix</span><span class="p">(</span><span class="n">df_fm1</span><span class="p">,</span> <span class="n">ver_col_fx</span><span class="p">,</span> <span class="n">version_info</span><span class="o">=</span><span class="s2">&quot;without_version&quot;</span><span class="p">)</span>
        <span class="n">df_fm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_fix</span><span class="p">(</span><span class="n">df_fm2</span><span class="p">,</span> <span class="n">ver_col_fx</span><span class="p">,</span> <span class="n">version_info</span><span class="o">=</span><span class="n">version_info</span><span class="p">)</span>

        <span class="c1"># Concatenate the results and return.</span>
        <span class="n">df_fx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_fm1</span><span class="p">,</span> <span class="n">df_fm2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_fx</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_fx</span></div>

<div class="viewcode-block" id="DatabaseManager.version_fix"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.version_fix">[docs]</a>    <span class="k">def</span> <span class="nf">version_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">version_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version_info</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Depending the version information of the organism, uniformize the identifiers.</span>

<span class="sd">        The method is not expected to be used by the user.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Input dataframe to fix the version information.</span>
<span class="sd">            version_str: Which column contain the &#39;Version&#39; information.</span>
<span class="sd">            version_info: The program parameter obtained somehow by ``check_version_info`` method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Modified dataframe in terms of version information.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `version_info` is not one of the output of `check_version_info` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If version_info is not entered, just re-calculate.</span>
        <span class="n">version_info</span> <span class="o">=</span> <span class="n">version_info</span> <span class="k">if</span> <span class="n">version_info</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_version_info</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">version_info</span> <span class="o">==</span> <span class="s2">&quot;add_version&quot;</span><span class="p">:</span>
            <span class="c1"># Set the constant value of DB.first_version as the Version.</span>
            <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">first_version</span>

        <span class="k">elif</span> <span class="n">version_info</span> <span class="o">==</span> <span class="s2">&quot;without_version&quot;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">elif</span> <span class="n">version_info</span> <span class="o">==</span> <span class="s2">&quot;with_version&quot;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Undefined choice for &#39;version_info&#39;.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DatabaseManager.check_version_info"><a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.check_version_info">[docs]</a>    <span class="k">def</span> <span class="nf">check_version_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Look at across all Ensembl releases and decide the &#39;version_info&#39; variable to be used in the program.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Either `without_version` when all Ensembl releases has identifiers without &#39;Versions&#39;,</span>
<span class="sd">            `with_version` when all Ensembl releases has identifiers with &#39;Versions&#39;,</span>
<span class="sd">            or `add_version` when some Ensembl releases has identifiers with &#39;Versions&#39;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the dataframe obtained by ``self.get_db(&quot;versioninfo&quot;)`` has a problematic column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vi_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;versioninfo&quot;</span><span class="p">)</span>
        <span class="n">narrowed</span> <span class="o">=</span> <span class="n">vi_df</span><span class="p">[</span><span class="s2">&quot;version_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">narrowed</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data type of &#39;version_info&#39; column must be boolean.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">narrowed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">narrowed</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;without_version&quot;</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">narrowed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;with_version&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;add_version&quot;</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Kemal Inecik.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>