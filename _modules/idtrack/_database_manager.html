

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>idtrack._database_manager &mdash; idtrack 0.0.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom_settings.css?v=15bcc2cf" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8c5712d9"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            idtrack
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code_of_conduct.html">Contributor Covenant Code of Conduct</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">idtrack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">idtrack._database_manager</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for idtrack._database_manager</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># Kemal Inecik</span>
<span class="c1"># k.inecik@gmail.com</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pymysql</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">idtrack._utils_hdf5</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">hs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">idtrack._db</span><span class="w"> </span><span class="kn">import</span> <span class="n">DB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">idtrack._external_databases</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExternalDatabases</span>


<div class="viewcode-block" id="DatabaseManager">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DatabaseManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manage retrieval, preprocessing, and storage of Ensembl Core and related external datasets.</span>

<span class="sd">    The *DatabaseManager* centralizes all low-level operations required for ID-track analyses, including</span>
<span class="sd">    discovering which Ensembl releases are available for a given organism/assembly, downloading the</span>
<span class="sd">    corresponding MySQL tables, normalizing column names, persisting raw and processed files under a</span>
<span class="sd">    local cache directory, and orchestrating auxiliary look-ups to third-party resources via</span>
<span class="sd">    :py:class:`ExternalDatabases`.  By funnelling every data-access path through a single object the</span>
<span class="sd">    wider package gains:</span>

<span class="sd">    * **Stable, reproducible builds** - every graph, lookup table, or ID-history file is anchored to</span>
<span class="sd">      the exact *Ensembl release*, *genome assembly*, and *form* (gene, transcript, translation, …)</span>
<span class="sd">      with which the manager was configured.</span>
<span class="sd">    * **Transparent caching** - expensive downloads happen once; subsequent requests are served from</span>
<span class="sd">      disk, making large iterative analyses feasible on modest hardware.</span>
<span class="sd">    * **Unified version logic** - helper methods such as</span>
<span class="sd">      :py:meth:`~DatabaseManager.version_uniformize` and</span>
<span class="sd">      :py:meth:`~DatabaseManager.check_version_info` guarantee that cross-release identifier changes</span>
<span class="sd">      are captured and resolved consistently across the codebase.</span>

<span class="sd">    Key public methods/attributes</span>
<span class="sd">    -----------------------------</span>
<span class="sd">    * :py:meth:`available_releases` — list releases that can be queried *and* saved locally.</span>
<span class="sd">    * :py:meth:`change_release` — switch the manager to another Ensembl release in-place.</span>
<span class="sd">    * :py:meth:`download_table` — fetch a single MySQL table and write it to ``local_repository``.</span>
<span class="sd">    * :py:meth:`create_external_all` — pull every supported external resource (UniProt, RefSeq, …).</span>
<span class="sd">    * :py:attr:`organism`, :py:attr:`form`, :py:attr:`ensembl_release`,</span>
<span class="sd">      :py:attr:`genome_assembly` — core configuration knobs, surfaced for quick inspection.</span>

<span class="sd">    The class is **stateful**: change-mutating helpers update internal cached properties so that the</span>
<span class="sd">    instance always reflects its current configuration.  Use the built-in :py:meth:`__str__` for a</span>
<span class="sd">    concise, human-readable dump of that state.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">organism</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">form</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">local_repository</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ensembl_release</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_before</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">store_raw_always</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">genome_assembly</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a :py:class:`DatabaseManager` for a specific organism, release, and assembly.</span>

<span class="sd">        Args:</span>
<span class="sd">            organism (str): Canonical species name in Ensembl schema (e.g. ``&quot;homo_sapiens&quot;`` or</span>
<span class="sd">                ``&quot;mus_musculus&quot;``). Anything else raises :py:class:`NotImplementedError`.</span>
<span class="sd">            form (str): Biological entity level of interest—one of ``&quot;gene&quot;``, ``&quot;transcript&quot;``,</span>
<span class="sd">                ``&quot;translation&quot;``, …—governing which stable-ID columns will be expected downstream.</span>
<span class="sd">            local_repository (str): Absolute or relative path to a writable directory that will hold</span>
<span class="sd">                all downloaded MySQL dumps, intermediate parquet/Feather files, and ready-to-use</span>
<span class="sd">                artefacts. The directory must already exist and be both readable and writable.</span>
<span class="sd">            ensembl_release (Optional[int]): Target Ensembl release number. If ``None`` the most</span>
<span class="sd">                recent release available for *genome_assembly* is selected automatically.</span>
<span class="sd">            ignore_before (Optional[int]): Earliest release to include when building cross-release ID</span>
<span class="sd">                histories. Defaults to the minimum release supported by the selected assembly.</span>
<span class="sd">            ignore_after (Optional[int | float]): Latest release to include when building histories.</span>
<span class="sd">                ``np.inf`` (the default) disables the upper bound and includes all newer releases.</span>
<span class="sd">            store_raw_always (bool): When ``True`` raw MySQL tables are *always* copied to</span>
<span class="sd">                ``local_repository`` before conversion; when ``False`` they are kept only in memory.</span>
<span class="sd">            genome_assembly (Optional[int]): NCBI assembly version (e.g. ``38`` for GRCh38). If</span>
<span class="sd">                omitted, the assembly with the highest priority for *organism* is used.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *form* is not in the supported list or *local_repository* fails basic</span>
<span class="sd">                path/read/write checks.</span>
<span class="sd">            NotImplementedError: If *organism* is not yet supported by the package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">organism</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;homo_sapiens&quot;</span><span class="p">,</span> <span class="s2">&quot;mus_musculus&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Organisms other than human and mouse is not implemented. In theory, it should work but &quot;</span>
                <span class="s2">&quot;no tests have been conducted yet. In the next version of the package, other &quot;</span>
                <span class="s2">&quot;organisms will be available. Please note that adding new organisms necessitates &quot;</span>
                <span class="s2">&quot;to determine which external databases to include using ExternalDatabase class.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">genome_assembly</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Set default genome assembly when not specified specifically.</span>
            <span class="n">genome_assembly</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Priority&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">][</span>
                <span class="mi">1</span>
            <span class="p">]</span>  <span class="c1"># Have the most important priority genome assembly as the default value.</span>

        <span class="c1"># MYSQL Settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span> <span class="o">=</span> <span class="n">genome_assembly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mysql_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">DB</span><span class="o">.</span><span class="n">mysql_host</span><span class="p">,</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">DB</span><span class="o">.</span><span class="n">myqsl_user</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">DB</span><span class="o">.</span><span class="n">mysql_togo</span><span class="p">,</span>
            <span class="c1"># Port depends on which genome assembly is of interest. Refer to the following link.</span>
            <span class="c1"># https://www.ensembl.org/info/data/mysql.html</span>
            <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="p">][</span><span class="s2">&quot;Port&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># The logger for informing the user about the progress.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;database_manager&quot;</span><span class="p">)</span>

        <span class="c1"># Instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span> <span class="o">=</span> <span class="n">local_repository</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">organism</span> <span class="o">=</span> <span class="n">organism</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="n">form</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span> <span class="o">=</span> <span class="n">store_raw_always</span>
        <span class="c1"># If ignore_before is not specified clearly, than use the lowest possible priority defined by the MySQL server.</span>
        <span class="n">default_min_er</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;MinRelease&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">ignore_before</span> <span class="k">if</span> <span class="n">ignore_before</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_min_er</span>
        <span class="c1"># If ignore_after is not specified, than set it to infinite.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignore_after</span> <span class="k">if</span> <span class="n">ignore_after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="c1"># Protected attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_form_of_interests</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">forms_in_order</span><span class="p">)</span>  <span class="c1"># Warning: the order is important.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_version_info</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;add_version&quot;</span><span class="p">,</span> <span class="s2">&quot;without_version&quot;</span><span class="p">,</span> <span class="s2">&quot;with_version&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column_sep</span> <span class="o">=</span> <span class="s2">&quot;_COL_&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ensembl_release</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Set last possible Ensembl release for given genome assembly.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># placeholder value for for file naming method, it is not gonna be saved anyway.</span>
            <span class="n">ensembl_release</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_releases_no_save</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ensembl_release</span><span class="p">)</span>
        <span class="c1"># _ = self.external_inst.load_modified_yaml()</span>

        <span class="c1"># Check if it seems ok.</span>
        <span class="n">checkers</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1"># In very early releases, there are floating ensembl releases like &quot;18.2&quot;. This package does not support.</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">ensembl_release</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">ensembl_release</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_releases</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_form_of_interests</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="o">&lt;</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="p">][</span><span class="s2">&quot;MinRelease&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">checkers</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;DatabaseManager&#39; could not pass the &#39;checkers&#39;: </span><span class="si">{</span><span class="n">checkers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a multi-line snapshot of the manager&#39;s current configuration.</span>

<span class="sd">        The string lists organism, form, Ensembl release, genome assembly, ignore range,</span>
<span class="sd">        repository path, and caching mode, making it convenient to embed in logs or console output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Readable status summary, one attribute per line, ending with a newline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;DatabaseManager instance:</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Organism: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Form: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Ensembl Release: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Genome Assembly: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Ignore Before: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Ignore After: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Local Repository: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    Store Raw Always: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">external_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExternalDatabases</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate and cache an :py:class:`ExternalDatabases` helper for this manager.</span>

<span class="sd">        The instance mirrors the configuration of the surrounding :py:class:`DatabaseManager`—organism,</span>
<span class="sd">        Ensembl release, identifier form, local repository path, and genome assembly—so that all</span>
<span class="sd">        interactions with external data sources remain consistent throughout the session.  Because the</span>
<span class="sd">        property is backed by :py:data:`functools.cached_property`, the helper is created exactly once</span>
<span class="sd">        and reused on subsequent accesses, eliminating redundant network or file-system look-ups.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ExternalDatabases: A lazily created, configuration-matched helper object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ExternalDatabases</span><span class="p">(</span>
            <span class="n">organism</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="p">,</span>
            <span class="n">ensembl_release</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
            <span class="n">local_repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span>
            <span class="n">genome_assembly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">available_releases</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return Ensembl releases that are both reachable and within the ignore window.</span>

<span class="sd">        The set is discovered via :py:meth:`available_releases_versions`, filtered against</span>
<span class="sd">        ``ignore_before`` / ``ignore_after``, sorted in ascending order, and cached for the lifetime of</span>
<span class="sd">        this :py:class:`DatabaseManager` instance.  The resulting list represents releases that can</span>
<span class="sd">        safely be queried **and** cached locally, guaranteeing reproducible downstream analyses.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[int]: Sorted release numbers satisfying reachability and ignore-window constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_releases_versions</span><span class="p">()</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">available_releases_no_save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return reachable Ensembl releases without persisting the discovery to disk.</span>

<span class="sd">        Functionally identical to :py:meth:`available_releases`, except that the discovered list is **not**</span>
<span class="sd">        written to the on-disk YAML cache. This helper is useful when users want a quick, read-only view</span>
<span class="sd">        of server availability—e.g., inside CI pipelines—without contaminating the persistent cache.</span>
<span class="sd">        The value is still memoized in memory for the current :py:class:`DatabaseManager` instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[int]: Sorted release numbers reachable on the remote MySQL server and compliant with the</span>
<span class="sd">            ignore window.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_releases_versions</span><span class="p">(</span><span class="n">save_after_calculation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="DatabaseManager.available_releases_versions">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.available_releases_versions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">available_releases_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover valid Ensembl releases for the configured organism and assembly.</span>

<span class="sd">        A ``SHOW DATABASES`` query is issued against the configured MySQL mirror.  Results are matched</span>
<span class="sd">        against the pattern ``^{organism}_core_&lt;release&gt;_.*$``; the captured ``&lt;release&gt;`` component is</span>
<span class="sd">        converted to ``int`` (floating-point labels are rejected), range-checked against the manager&#39;s</span>
<span class="sd">        ``ignore_before`` / ``ignore_after`` bounds, and finally sorted. Optional keyword arguments are</span>
<span class="sd">        forwarded verbatim to :py:meth:`DatabaseManager.get_db`, allowing callers to tweak connection or</span>
<span class="sd">        caching behaviour.</span>

<span class="sd">        Args:</span>
<span class="sd">            kwargs: Arbitrary keyword arguments passed straight through to</span>
<span class="sd">                :py:meth:`DatabaseManager.get_db` (e.g., ``mysql_conn``, ``force_refresh``).</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[int]: Sorted list of release numbers that exist on the mirror and comply with the ignore window.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If a database name does not match the expected regex, if floating-point release</span>
<span class="sd">                labels are encountered, or if other inconsistencies arise while parsing server results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all possible ensembl releases for a given organism</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;availabledatabases&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="s2">&quot;available_databases&quot;</span><span class="p">]</span>  <span class="c1"># Obtain the databases dataframe</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">_core_([0-9]+)_.+$&quot;</span><span class="p">)</span>
        <span class="c1"># Search organism name in a specified format. Extract ensembl release number</span>
        <span class="n">releases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dbs_i</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">dbs_i</span><span class="p">):</span>
                <span class="n">dbs_ps</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">dbs_i</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dbs_ps</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="n">releases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dbs_ps</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Get rid of floating ensembl releases if exists: In very early releases, there are floating releases</span>
        <span class="c1"># like &quot;18.2&quot;. This Python package does not support those.</span>
        <span class="n">floating_ensembl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">releases_final</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">releases_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">floating_ensembl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">floating_ensembl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Some ensembl releases are included for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;There are floating ensembl releases: </span><span class="si">{</span><span class="n">floating_ensembl</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Sort in ascending order and return the result.</span>
        <span class="n">releases_final</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">releases_final</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span> <span class="o">&gt;=</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span>  <span class="c1"># Filter out the releases that are not of interest.</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">releases_final</span></div>


    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mysql_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the canonical Ensembl Core schema name for the current organism, release, and assembly.</span>

<span class="sd">        The manager must resolve exactly one MySQL schema on the remote Ensembl server whose name encodes the</span>
<span class="sd">        *organism* (e.g. ``homo_sapiens``), *release* (e.g. ``111``), and *genome assembly* (e.g. ``38``).  This</span>
<span class="sd">        helper centralises that lookup, guaranteeing that downstream calls—such as :py:meth:`download_table`—always</span>
<span class="sd">        talk to the correct database.  The search relies on :py:meth:`get_db` to fetch the server&#39;s catalogue and</span>
<span class="sd">        then filters it by a strict regular expression; any ambiguity is treated as fatal because it would break</span>
<span class="sd">        reproducibility.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A single schema name like ``&quot;homo_sapiens_core_111_38&quot;`` that uniquely matches the manager&#39;s</span>
<span class="sd">                configuration.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If zero **or** more than one schema satisfies the search criteria, signalling server</span>
<span class="sd">                misconfiguration or an invalid combination of *organism* and *ensembl_release*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;availabledatabases&quot;</span><span class="p">)[</span><span class="s2">&quot;available_databases&quot;</span><span class="p">]</span>  <span class="c1"># Obtain the databases dataframe</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">_core_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="p">)</span><span class="si">}</span><span class="s2">_.+$&quot;</span><span class="p">)</span>
        <span class="n">located</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dbs</span> <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="c1"># Search database in a specified format. Extract ensembl release number</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">located</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;There are more than one &#39;MySQL database&#39; in the server &quot;</span>
                <span class="s2">&quot;satisfying given ensembl release and organism name.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Make sure there are only one database in the server satisfying given ensembl release and organism name.</span>

        <span class="k">return</span> <span class="n">located</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="DatabaseManager.change_form">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.change_form">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DatabaseManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clone the manager while switching the biological form of interest.</span>

<span class="sd">        A “form” denotes the identifier namespace to track—``gene``, ``transcript``, ``translation``, etc.  This</span>
<span class="sd">        method preserves every other configuration knob (organism, release, assembly, cache directory, ignore</span>
<span class="sd">        windows, …) and returns a brand-new instance so that the original object remains unaffected.</span>

<span class="sd">        Args:</span>
<span class="sd">            form (str): Target form/namespace recognised by :py:meth:`~DatabaseManager.__init__`.  Typical values</span>
<span class="sd">                are ``&quot;gene&quot;``, ``&quot;transcript&quot;``, or ``&quot;translation&quot;``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DatabaseManager: An independent manager identical to *self* except for :py:attr:`form`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DatabaseManager</span><span class="p">(</span>
            <span class="n">organism</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="p">,</span>
            <span class="n">ensembl_release</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
            <span class="n">local_repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span>
            <span class="n">ignore_before</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">,</span>
            <span class="n">ignore_after</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span><span class="p">,</span>
            <span class="n">store_raw_always</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">,</span>
            <span class="n">genome_assembly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseManager.change_release">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.change_release">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ensembl_release</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DatabaseManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a new manager that targets a different Ensembl release.</span>

<span class="sd">        The returned instance inherits organism, form, assembly, and all caching parameters, but points every</span>
<span class="sd">        subsequent query (MySQL, FTP, or REST) to *ensembl_release*.  This is the recommended way to traverse</span>
<span class="sd">        releases in scripted analyses without mutating objects in-place.</span>

<span class="sd">        Args:</span>
<span class="sd">            ensembl_release (int): Desired Ensembl release number (e.g. ``111``).  Must be available for the</span>
<span class="sd">                current genome assembly or a :py:data:`NotImplementedError` may be raised further down the call</span>
<span class="sd">                stack when data retrieval is attempted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DatabaseManager: Fresh manager initialised for *ensembl_release*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DatabaseManager</span><span class="p">(</span>
            <span class="n">organism</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="p">,</span>
            <span class="n">ensembl_release</span><span class="o">=</span><span class="n">ensembl_release</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
            <span class="n">local_repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span>
            <span class="n">ignore_before</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">,</span>
            <span class="n">ignore_after</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span><span class="p">,</span>
            <span class="n">store_raw_always</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">,</span>
            <span class="n">genome_assembly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseManager.change_assembly">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.change_assembly">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_assembly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genome_assembly</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">last_possible_ensembl_release</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DatabaseManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clone the manager while targeting a new genome assembly (e.g. GRCh38 → GRCh37).</span>

<span class="sd">        Genome assemblies are encoded as integers in Ensembl&#39;s schema naming (``38`` for *GRCh38*,</span>
<span class="sd">        ``37`` for *GRCh37*, ``102`` for *GRCm39*, …).  When *last_possible_ensembl_release* is ``True`` the</span>
<span class="sd">        method automatically picks the most recent Ensembl release that **still** provides MySQL dumps for the</span>
<span class="sd">        requested assembly, ensuring compatibility.  All other settings are copied verbatim.</span>

<span class="sd">        Args:</span>
<span class="sd">            genome_assembly (int): Key from :py:data:`DB.assembly_mysqlport_priority` mapping—see Ensembl</span>
<span class="sd">                documentation for valid values.</span>
<span class="sd">            last_possible_ensembl_release (bool): When ``True`` override *ensembl_release* with the</span>
<span class="sd">                newest version available for *genome_assembly*.  Defaults to ``False``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DatabaseManager: New manager tied to the requested assembly (and possibly a recalculated release).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DatabaseManager</span><span class="p">(</span>
            <span class="n">organism</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="p">,</span>
            <span class="n">ensembl_release</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">last_possible_ensembl_release</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
            <span class="n">local_repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span>
            <span class="n">ignore_before</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">,</span>
            <span class="n">ignore_after</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span><span class="p">,</span>
            <span class="n">store_raw_always</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">,</span>
            <span class="n">genome_assembly</span><span class="o">=</span><span class="n">genome_assembly</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseManager.create_available_databases">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_available_databases">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_available_databases</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover MySQL databases for the configured organism/assembly.</span>

<span class="sd">        The manager issues a ``SHOW DATABASES`` query against the Ensembl public MySQL mirror and filters</span>
<span class="sd">        names that match ``^{organism}_core_[0-9]+_.*$``.  The resulting list is returned as a single-column</span>
<span class="sd">        dataframe so that callers can seamlessly chain further pandas operations or persist the result.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: One column named ``&quot;available_databases&quot;`` listing all databases that match</span>
<span class="sd">                the organism, irrespective of Ensembl release or genome assembly.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the server response is not a sequence of single-field tuples **or** if any tuple</span>
<span class="sd">                element is not a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Available MySQL databases for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;assembly and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="si">}</span><span class="s2"> release is being fetched.&quot;</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mysql_settings</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SHOW databases&quot;</span><span class="p">)</span>
                <span class="n">results_query</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results_query</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The result is in unexpected format.&quot;</span><span class="p">)</span>
        <span class="n">results_query</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results_query</span><span class="p">]</span>  <span class="c1"># Get the relevant portion.</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">_core_[0-9]+_.+$&quot;</span><span class="p">)</span>
        <span class="n">accepted_databases</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results_query</span> <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">accepted_databases</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;available_databases&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="DatabaseManager.get_table">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.get_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">usecols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_even_if_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_after_calculation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">overwrite_even_if_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download, cache, or read a raw MySQL table for the current release.</span>

<span class="sd">        A high-level wrapper that coordinates three steps:</span>

<span class="sd">        1. **Path resolution** - determines the HDF5 file and internal key under the local repository that</span>
<span class="sd">           belong to *table_key* (and *usecols*, if provided).</span>
<span class="sd">        2. **Fetch or reuse** - if the target key is absent, unreadable, or forcibly refreshed, delegates to</span>
<span class="sd">           :py:meth:`download_table` to query the MySQL server; otherwise loads the dataframe from disk.</span>
<span class="sd">        3. **Persistence** - optionally stores the freshly downloaded dataframe back to disk, shrinking the</span>
<span class="sd">           number of future network calls.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_key (str): Name of the MySQL table (e.g. ``&quot;gene&quot;``, ``&quot;xref&quot;``, ``&quot;mapping_session&quot;``).</span>
<span class="sd">            usecols (list[str] | None): Column subset to retrieve. ``None`` (default) selects *all* columns.</span>
<span class="sd">            create_even_if_exist (bool): Ignore any on-disk cache and re-download the table unconditionally.</span>
<span class="sd">            save_after_calculation (bool): Persist the dataframe to the computed HDF5 path when ``True``.</span>
<span class="sd">            overwrite_even_if_exist (bool): Replace an existing HDF5 key even when it is already present.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: The requested raw table with column order mirroring *usecols* when supplied,</span>
<span class="sd">                otherwise the server&#39;s natural order.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *usecols* is an empty list, not a list, or otherwise fails basic validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">usecols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">usecols</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">usecols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Empty &#39;usecols&#39; parameter, or &#39;usecols&#39; is not a list.&quot;</span><span class="p">)</span>

        <span class="c1"># Get the file name associated with table_key and columns of interest.</span>
        <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="n">table_key</span><span class="p">,</span> <span class="n">usecols</span><span class="p">)</span>

        <span class="c1"># If the file name is not accessible for reading, or if the hdf5 file does not contain the table,</span>
        <span class="c1"># or explicitly prompt to do so, then download the table.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span> <span class="ow">or</span> <span class="n">create_even_if_exist</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">hs</span><span class="o">.</span><span class="n">check_h5_key</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">)):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_table</span><span class="p">(</span><span class="n">table_key</span><span class="p">,</span> <span class="n">usecols</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise, just read the file that is already in the directory.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">read_exported</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># If prompt, save the dataframe in requested format.</span>
        <span class="k">if</span> <span class="n">save_after_calculation</span><span class="p">:</span>
            <span class="n">hs</span><span class="o">.</span><span class="n">export_disk</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">overwrite_even_if_exist</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="DatabaseManager.tables_in_disk">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.tables_in_disk">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tables_in_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all dataframes cached for this manager on local disk.</span>

<span class="sd">        The helper inspects the HDF5 file located at the path generated by</span>
<span class="sd">        :py:meth:`file_name` (``df_type=&quot;common&quot;``) and returns every key it contains.</span>
<span class="sd">        When the file does not exist yet, an empty list is returned instead of raising.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str]: Sorted HDF5 keys corresponding to dataframes already materialised for this manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="s2">&quot;place_holder&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">hs</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<div class="viewcode-block" id="DatabaseManager.download_table">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.download_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">usecols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download a raw Ensembl MySQL table and return it as a DataFrame.</span>

<span class="sd">        The method forms the low-level backbone of all table acquisition in *IDTrackDocs*.  It opens a</span>
<span class="sd">        direct connection to the Ensembl Core (or comparable) MySQL schema configured on the current</span>
<span class="sd">        :py:class:`DatabaseManager` instance, issues a `SELECT` statement against *table_key*, converts</span>
<span class="sd">        the results into a :py:class:`pandas.DataFrame`, and performs a minimal sanitisation pass</span>
<span class="sd">        (bytes-to-string decoding, column subset validation, logging).  Public code is expected to call</span>
<span class="sd">        :py:meth:`DatabaseManager.get_table`, which wraps this helper with caching and post-processing,</span>
<span class="sd">        but keeping this routine separate allows fine-grained testing, mocking, and reuse in advanced</span>
<span class="sd">        workflows.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_key (str): Name of the raw table as it appears in the remote Ensembl database</span>
<span class="sd">                (e.g. ``&#39;gene&#39;``, ``&#39;mapping_session&#39;``, ``&#39;xref&#39;``).  Must exist in the schema</span>
<span class="sd">                returned by :py:meth:`DatabaseManager.mysql_database`.</span>
<span class="sd">            usecols (Optional[list[str]]): Sequence of column names to project; *None* retrieves the</span>
<span class="sd">                entire table.  Column order is preserved.  An empty list is treated the same as *None*.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: A frame containing the requested columns in the exact order supplied via</span>
<span class="sd">                *usecols* (or all columns if *usecols* is *None*).  Index is monotonic and zero-based.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any element of *usecols* is missing from *table_key*, or if the query returns</span>
<span class="sd">                binary payloads that cannot be coerced into native Python types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Base settings for MYSQL server.</span>
        <span class="n">which_mysql_server</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mysql_settings</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_database</span><span class="p">})</span>

        <span class="c1"># Connect to the MYSQL server, close the connection after the code block</span>
        <span class="k">with</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">which_mysql_server</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="c1"># Create a cursor to be able to make some queries: First get the associated column names.</span>
            <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur1</span><span class="p">:</span>
                <span class="n">cur1</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHOW columns FROM </span><span class="si">{</span><span class="n">table_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">column_names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cur1</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There is no column in the table&quot;</span><span class="p">)</span>

                <span class="c1"># The MYSQL sever before &#39;DB.mysql_port_min_version&#39; gives the result as bytes, but</span>
                <span class="c1"># the one after gives as string.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c1"># Convert everything to string to be consistent.</span>
                    <span class="n">column_names</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="c1"># Just to make sure conversion is successful, no problem is expected to arise afterwards.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_sep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>

            <span class="c1"># Create a cursor to be able to make some queries: Second get the associated table content.</span>
            <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur2</span><span class="p">:</span>
                <span class="c1"># Convert the list of column names into string to be used in MYSQL query</span>
                <span class="n">usecol_sql</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">usecols</span><span class="p">)</span> <span class="k">if</span> <span class="n">usecols</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">cur2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">usecols</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">usecol_sql</span><span class="si">}</span><span class="s2"> FROM </span><span class="si">{</span><span class="n">table_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Fetch all the content and save as a tuple file.</span>
                <span class="n">results_content</span> <span class="o">=</span> <span class="n">cur2</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="c1"># Create a dataframe using the columns fetched.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results_content</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_names</span> <span class="k">if</span> <span class="n">usecols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">usecols</span><span class="p">)</span>
            <span class="c1"># Make sure the content does not contain any bytes object.</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">))):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>

            <span class="n">info_usecols</span> <span class="o">=</span> <span class="s2">&quot; for following columns: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">usecols</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="k">if</span> <span class="n">usecols</span> <span class="k">else</span> <span class="s2">&quot;.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Raw table for `</span><span class="si">{</span><span class="n">table_key</span><span class="si">}</span><span class="s2">` on ensembl release `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="si">}</span><span class="s2">` &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;was downloaded</span><span class="si">{</span><span class="n">info_usecols</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="DatabaseManager.available_tables_mysql">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.available_tables_mysql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">available_tables_mysql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enumerate tables present in the selected Ensembl MySQL schema.</span>

<span class="sd">        Intended to complement :py:meth:`available_databases_mysql`: while that</span>
<span class="sd">        method lists *databases* (one per organism/release/assembly), this one will</span>
<span class="sd">        drill into the active database and return the table names themselves, such</span>
<span class="sd">        as ``&quot;gene&quot;``, ``&quot;transcript&quot;``, ``&quot;xref&quot;``, and so on.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always - the table enumeration logic has not yet been written.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="DatabaseManager.get_release_date">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.get_release_date">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_release_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a mapping of Ensembl release numbers to their publication dates.</span>

<span class="sd">        The future implementation will query the ``meta`` table of each reachable</span>
<span class="sd">        release—or fall back to the Ensembl REST API—to build a dictionary such as</span>
<span class="sd">        ``{105: date(2022, 11, 1), 106: date(2023, 2, 7), …}``.  Down-stream</span>
<span class="sd">        routines can then translate between absolute dates and release numbers,</span>
<span class="sd">        enabling chronology-aware analyses and reporting.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: Always - date discovery is not yet implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="DatabaseManager._determine_usecols_ids">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager._determine_usecols_ids">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_usecols_ids</span><span class="p">(</span><span class="n">form</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine column subsets needed to fetch identifier tables for a given Ensembl molecular form.</span>

<span class="sd">        The helper translates a user-facing *form* string (``&quot;gene&quot;``, ``&quot;transcript&quot;``, or</span>
<span class="sd">        ``&quot;translation&quot;``) into three ordered lists that drive low-level SQL selects throughout</span>
<span class="sd">        *ID-track*.  Splitting the information this way lets public routines such as</span>
<span class="sd">        :py:meth:`DatabaseManager.create_ids` assemble the minimal column set required for each</span>
<span class="sd">        organism/release while still keeping associated keys available for later joins.</span>

<span class="sd">        Args:</span>
<span class="sd">            form (str): Molecular form whose identifier columns are requested. Must be one of</span>
<span class="sd">                :py:data:`idtrack._db.DB.forms_in_order` (``&quot;gene&quot;``, ``&quot;transcript&quot;``, or</span>
<span class="sd">                ``&quot;translation&quot;``).</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[str], list[str], list[str]]:</span>
<span class="sd">                * **stable_id_version** - always ``[&quot;stable_id&quot;, &quot;version&quot;]``; the canonical ID and its</span>
<span class="sd">                  version counter.</span>
<span class="sd">                * **usecols_core** - primary-key column for *form* plus ``stable_id_version``.</span>
<span class="sd">                * **usecols_asso** - foreign-key columns linking *form* to upstream forms, enabling</span>
<span class="sd">                  later joins (e.g., ``[&quot;transcript_id&quot;, &quot;gene_id&quot;]`` for transcripts).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *form* is not in ``{&quot;gene&quot;, &quot;transcript&quot;, &quot;translation&quot;}``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stable_id_version</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">form</span> <span class="o">==</span> <span class="s2">&quot;gene&quot;</span><span class="p">:</span>
            <span class="n">usecols_core</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gene_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stable_id_version</span>
            <span class="n">usecols_asso</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gene_id&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">form</span> <span class="o">==</span> <span class="s2">&quot;transcript&quot;</span><span class="p">:</span>
            <span class="n">usecols_core</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;transcript_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stable_id_version</span>
            <span class="n">usecols_asso</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;transcript_id&quot;</span><span class="p">,</span> <span class="s2">&quot;gene_id&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">form</span> <span class="o">==</span> <span class="s2">&quot;translation&quot;</span><span class="p">:</span>
            <span class="n">usecols_core</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;translation_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stable_id_version</span>
            <span class="n">usecols_asso</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;translation_id&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript_id&quot;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Form has to be one of </span><span class="si">{</span><span class="n">DB</span><span class="o">.</span><span class="n">forms_in_order</span><span class="si">}</span><span class="s2">. Input form is `</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">`.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stable_id_version</span><span class="p">,</span> <span class="n">usecols_core</span><span class="p">,</span> <span class="n">usecols_asso</span></div>


<div class="viewcode-block" id="DatabaseManager.create_ids">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_ids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve and normalise raw Ensembl identifier records for the requested molecular form.</span>

<span class="sd">        This method pulls the appropriate MySQL table(s) for *form*, copes with schema differences</span>
<span class="sd">        across Ensembl releases (e.g. the historical ``*_stable_id`` split tables), coerces data</span>
<span class="sd">        types, and standardises column names so that downstream graph-building steps all consume the</span>
<span class="sd">        same shape.  It finishes by delegating to :py:meth:`DatabaseManager.version_uniformize` to</span>
<span class="sd">        ensure the *Version* field is either a proper integer or ``NaN`` across the entire DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            form (str): Target molecular form - ``&quot;gene&quot;``, ``&quot;transcript&quot;``, or ``&quot;translation&quot;``.</span>
<span class="sd">                Anything else triggers a :py:class:`ValueError`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: A de-duplicated, index-reset table whose columns depend on *form*:</span>

<span class="sd">                * **gene** - ``gene_id``, ``gene_stable_id``, ``gene_version``</span>
<span class="sd">                * **transcript** - ``transcript_id``, ``gene_id``, ``transcript_stable_id``,</span>
<span class="sd">                  ``transcript_version``</span>
<span class="sd">                * **translation** - ``translation_id``, ``transcript_id``, ``translation_stable_id``,</span>
<span class="sd">                  ``translation_version``</span>

<span class="sd">                All ID columns are ``int64`` except the ``*_stable_id`` strings; version columns are</span>
<span class="sd">                ``int64`` or ``float64`` (with ``NaN`` when absent).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine which columns are interesting for each form.</span>
        <span class="n">stable_id_version</span><span class="p">,</span> <span class="n">usecols_core</span><span class="p">,</span> <span class="n">usecols_asso</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">_determine_usecols_ids</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># In order to have the same column order with below exception code block.</span>
            <span class="n">usecols</span> <span class="o">=</span> <span class="n">usecols_core</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">usecols_asso</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usecols_core</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">usecols</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
            <span class="c1"># Earlier versions has different table for stable_id.</span>
            <span class="c1"># When there is no associated column for a given table, the following error will be raised.</span>

        <span class="k">except</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">usecols_core</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
            <span class="n">df_2</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">usecols_asso</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">form</span> <span class="o">!=</span> <span class="s2">&quot;gene&quot;</span>
                <span class="k">else</span> <span class="n">df</span><span class="p">[</span><span class="n">usecols_asso</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;one_to_one&quot;</span><span class="p">)</span>

        <span class="c1"># Remove rows with NaN stable_id if exists</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
        <span class="c1"># Convert all IDs to int except stable_id and version.</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">usecols_asso</span> <span class="o">+</span> <span class="n">usecols_core</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stable_id_version</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stable_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>  <span class="c1"># Convert stable_ids to string</span>

        <span class="c1"># Rename to prevent any conflicts in the package</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;stable_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Remove duplicates if exists</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_uniformize</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">version_str</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseManager.create_relation_current">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_relation_current">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_relation_current</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a current-release gene-transcript-translation mapping table.</span>

<span class="sd">        The routine fetches the *raw* stable-ID/​version tables for genes,</span>
<span class="sd">        transcripts and translations via :py:meth:`DatabaseManager.get_db`, merges</span>
<span class="sd">        them into a single wide frame, and then delegates to</span>
<span class="sd">        :py:meth:`DatabaseManager._create_relation_helper` to harmonise version</span>
<span class="sd">        columns and compress the information into three canonical node labels</span>
<span class="sd">        (``&quot;&lt;stable_id&gt;.&lt;version&gt;&quot;``).  The resulting mapping is the authoritative</span>
<span class="sd">        per-release link between molecular forms and is consumed by downstream</span>
<span class="sd">        graph-building utilities such as :py:meth:`DatabaseManager.create_graph`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Three columns—``gene``, ``transcript``, and</span>
<span class="sd">            ``translation``—with one row per transcript.  The ``translation`` column</span>
<span class="sd">            may contain empty strings where non-coding transcripts have no</span>
<span class="sd">            peptide.  All data are UTF-8 strings; duplicates are removed and the</span>
<span class="sd">            index is reset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get required gene, transcript and translation IDs</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;idsraw_gene&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;idsraw_transcript&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;idsraw_translation&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>

        <span class="c1"># Combine them into one</span>
        <span class="n">tgp</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">g</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;gene_id&quot;</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_one&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;transcript_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;one_to_one&quot;</span><span class="p">)</span>
        <span class="n">tgp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gene_id&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript_id&quot;</span><span class="p">,</span> <span class="s2">&quot;translation_id&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_relation_helper</span><span class="p">(</span><span class="n">tgp</span><span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseManager.create_relation_archive">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_relation_archive">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_relation_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a cross-release gene-transcript-translation mapping table.</span>

<span class="sd">        This legacy helper pulls the Ensembl ``gene_archive`` table—spanning *all*</span>
<span class="sd">        releases for the current organism—via</span>
<span class="sd">        :py:meth:`DatabaseManager.get_table`, drops columns unrelated to identifier</span>
<span class="sd">        mapping, and passes the result to</span>
<span class="sd">        :py:meth:`DatabaseManager._create_relation_helper`.  **Because the archive</span>
<span class="sd">        contains known gaps, the preferred workflow is to call**</span>
<span class="sd">        :py:meth:`DatabaseManager.create_relation_current` **once per release and</span>
<span class="sd">        concatenate the outputs.**</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Same schema as</span>
<span class="sd">                :py:meth:`DatabaseManager.create_relation_current`—``gene``,</span>
<span class="sd">                ``transcript``, ``translation``—but potentially with missing rows</span>
<span class="sd">                because Ensembl did not always back-populate older releases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not recommended method: Use &#39;create_relation_current&#39; instead.&quot;</span><span class="p">)</span>
        <span class="c1"># Get the table from the server</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;gene_archive&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
        <span class="c1"># Remove unnecessary columns and return.</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;peptide_archive_id&quot;</span><span class="p">,</span> <span class="s2">&quot;mapping_session_id&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_relation_helper</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseManager._create_relation_helper">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager._create_relation_helper">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_relation_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert an ID/version matrix into the canonical three-column relationship table.</span>

<span class="sd">        The helper is shared by :py:meth:`DatabaseManager.create_relation_current`</span>
<span class="sd">        and :py:meth:`DatabaseManager.create_relation_archive` and is not intended</span>
<span class="sd">        for direct use.  It validates the incoming frame, fixes inconsistent</span>
<span class="sd">        version numbers (via :py:meth:`DatabaseManager.version_fix` and</span>
<span class="sd">        :py:meth:`DatabaseManager.version_fix_incomplete`), converts missing</span>
<span class="sd">        translations to ``NaN``-compatible floats, casts all stable-ID columns to</span>
<span class="sd">        string, and finally compresses each *ID + version* pair into the compact</span>
<span class="sd">        node label used throughout *ID-track* graphs.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): A six-column frame with exactly the following</span>
<span class="sd">                names (order irrelevant): ``gene_stable_id``, ``gene_version``,</span>
<span class="sd">                ``transcript_stable_id``, ``transcript_version``,</span>
<span class="sd">                ``translation_stable_id``, ``translation_version``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Three columns—``gene``, ``transcript``,</span>
<span class="sd">                ``translation``—deduplicated and index-reset, ready for graph</span>
<span class="sd">                construction.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *df* does not contain the required six columns or if</span>
<span class="sd">                version columns cannot be coerced to the expected numeric dtype.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure there are correct number and name of columns</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;gene_stable_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gene_version&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transcript_stable_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transcript_version&quot;</span><span class="p">,</span>
            <span class="s2">&quot;translation_stable_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;translation_version&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span> <span class="o">==</span> <span class="mi">6</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># Process the dataframe</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript&quot;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
            <span class="c1"># Transcript may have different version info than gene.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_form</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">version_fix</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">]:</span>
            <span class="c1"># Translation may have different version info than gene/transcript.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_form</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">version_fix_incomplete</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>  <span class="c1"># due to np.nans</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gene_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;translation_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript_stable_id&quot;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;transcript&quot;</span><span class="p">,</span> <span class="s2">&quot;translation&quot;</span><span class="p">]:</span>
            <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_form</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">id_ver_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">]])</span>

        <span class="c1"># Drop duplicates if exists and return.</span>
        <span class="n">res</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="DatabaseManager.create_id_history">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_id_history">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_id_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">narrow</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve historical relationships between successive Ensembl stable IDs.</span>

<span class="sd">        Build a cross-release lineage table mapping every obsolete ID version to its immediate successor for the</span>
<span class="sd">        configured *organism*, *form*, and release window.  The information is assembled from the Core tables</span>
<span class="sd">        ``stable_id_event`` and ``mapping_session`` and then normalised so that all identifiers follow the canonical</span>
<span class="sd">        ``&lt;stable_id&gt;.&lt;version&gt;`` convention.  Downstream graph-construction utilities depend on this table to</span>
<span class="sd">        reconstruct how genes, transcripts, or translations evolve across Ensembl releases.</span>

<span class="sd">        Args:</span>
<span class="sd">            narrow (bool): If ``True`` drop auxiliary columns (mapping session metadata, assembly labels, creation</span>
<span class="sd">                timestamps, etc.) to minimise on-disk footprint; otherwise return the full schema for exploratory</span>
<span class="sd">                analyses.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Seven-column table with the following fields, ordered as listed—</span>

<span class="sd">                * ``old_stable_id`` - obsolete identifier (empty string for “birth” events).</span>
<span class="sd">                * ``old_version``   - version number paired with *old_stable_id*.</span>
<span class="sd">                * ``new_stable_id`` - successor identifier (empty string for “retirement” events).</span>
<span class="sd">                * ``new_version``   - version paired with *new_stable_id*.</span>
<span class="sd">                * ``score``         - homology score reported by Ensembl (``NaN`` if unavailable).</span>
<span class="sd">                * ``old_release``   - Ensembl release where the *old* identifier last appeared.</span>
<span class="sd">                * ``new_release``   - release where the *new* identifier first appeared.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the identifier delimiter</span>
<span class="sd">                :py:data:`idtrack._db.DB.id_ver_delimiter` is found inside any ``*_stable_id`` field, indicating</span>
<span class="sd">                malformed input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the tables from the server</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;stable_id_event&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;mapping_session&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>

        <span class="c1"># Combine them into one and filter only the form of interest.</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;mapping_session_id&quot;</span><span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="n">sm</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">narrow</span><span class="p">:</span>
            <span class="c1"># Remove some unnecessary columns if prompt so.</span>
            <span class="n">sm</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;mapping_session_id&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;old_db_name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;new_db_name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;old_assembly&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;new_assembly&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;created&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Correct the version based on version_info for each old_stable_id and new_stable_id columns.</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_fix_incomplete</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_fix_incomplete</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="s2">&quot;old_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;old_version&quot;</span><span class="p">),</span> <span class="s2">&quot;new_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;new_version&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Convert np.nan&#39;s to &quot;&quot; so that saving to hdf5 file is not a problem.</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;new_stable_id&quot;</span><span class="p">,</span> <span class="s2">&quot;old_stable_id&quot;</span><span class="p">]:</span>
            <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="s2">&quot;old_release&quot;</span><span class="p">,</span> <span class="s2">&quot;new_release&quot;</span><span class="p">]:</span>
            <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">sm</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># 0 means no information according to ensembl.</span>

        <span class="c1"># Check the delimiter is not in the ID.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="s2">&quot;new_stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">id_ver_delimiter</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="s2">&quot;old_stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">id_ver_delimiter</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1"># No need to check for version as it can be already float or int by fix_stable_events</span>

        <span class="n">sm</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_after</span> <span class="o">&gt;=</span> <span class="n">sm</span><span class="p">[</span><span class="s2">&quot;old_release&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="s2">&quot;old_release&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_before</span><span class="p">)]</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Remove duplicates if exists</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sm</span></div>


<div class="viewcode-block" id="DatabaseManager.create_id_history_fixed">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_id_history_fixed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_id_history_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">narrow</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">inspect</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a corrected ID-history table that repairs cyclic or duplicated version transitions (deprecated).</span>

<span class="sd">        Certain edge cases in the raw ``idhistory`` extraction—e.g. *Homo sapiens* ``ENSG00000232423`` at release 105—</span>
<span class="sd">        produce sequences like ``1 → 2, 2 → 3, 1 → 2`` where an already retired version resurfaces later on.</span>
<span class="sd">        Such cycles violate the monotonic version semantics assumed by graph algorithms.  This helper rewrites the</span>
<span class="sd">        offending rows so that once a version is superseded it never reappears, transforming the above sequence into</span>
<span class="sd">        the logically consistent ``3 → 2``.  The routine is retained for reproducibility but superseded by</span>
<span class="sd">        :py:meth:`DatabaseManager.create_id_history`.</span>

<span class="sd">        Args:</span>
<span class="sd">            narrow (bool): Propagated to the underlying data fetch—when ``True`` start from the column-reduced</span>
<span class="sd">                ``idhistory_narrow`` view instead of the full table.</span>
<span class="sd">            inspect (bool): When ``True`` add diagnostic columns (e.g. ``changed_old`` and ``changed_new``) to aid</span>
<span class="sd">                manual auditing of the corrections; when ``False`` return only the cleaned canonical schema.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Corrected seven-column table ``old_stable_id``, ``old_version``, ``new_stable_id``,</span>
<span class="sd">                ``new_version``, ``score``, ``old_release``, ``new_release``—ready for serialization and downstream use.</span>

<span class="sd">        Note:</span>
<span class="sd">            This function is deprecated and will be removed in a future major release once the core extractor fully</span>
<span class="sd">            addresses the ordering anomaly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the raw version of idhistory first, and sort.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;idhistory&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">narrow</span> <span class="k">else</span> <span class="s2">&quot;idhistory_narrow&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;new_release&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Initialize some temp variables</span>
        <span class="n">extinct_version</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">last_active_version</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">corrected_entries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">changed_old</span><span class="p">,</span> <span class="n">changed_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="c1"># If old_stable_id and new_stable_id is different, then we are not interested in those; because extinction</span>
            <span class="c1"># of specific version does not have to exist. For example, it can basically branch.</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_stable_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;new_stable_id&quot;</span><span class="p">]:</span>  <span class="c1"># not of interested</span>
                <span class="k">continue</span>

            <span class="c1"># Self-loops are also not of interest, because it does not cause a specific version of an ID to be extinct.</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;new_version&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">row_key</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_stable_id&quot;</span><span class="p">]</span>
                <span class="c1"># If old_stable_id not seen before in the temp dictionaries, then basically add.</span>
                <span class="k">if</span> <span class="n">row_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extinct_version</span><span class="p">:</span>
                    <span class="n">extinct_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">last_active_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Add the version into the set.</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_version&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extinct_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]:</span>
                    <span class="n">extinct_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_version&quot;</span><span class="p">])</span>
                    <span class="c1"># Save the last active version</span>
                    <span class="n">last_active_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># If old_version is already seen before.</span>
                    <span class="c1"># Replace the value in the database with the last_active_version&#39;s associated rows.</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="s2">&quot;old_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_active_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">][</span><span class="s2">&quot;new_version&quot;</span><span class="p">]</span>
                    <span class="n">changed_old</span><span class="p">,</span> <span class="n">changed_new</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;old_version&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;new_version&quot;</span><span class="p">]</span>

                <span class="c1"># If new_version is seen, then basically remove it.</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;new_version&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">extinct_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]:</span>
                    <span class="n">extinct_version</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span> <span class="o">-=</span> <span class="p">{</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;new_version&quot;</span><span class="p">]}</span>

            <span class="c1"># If inspect is on, then add the changed parameters.</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="p">:</span>
                <span class="n">corrected_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">changed_old</span><span class="p">,</span> <span class="n">changed_new</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="c1"># If inspect is on, then add these columns as new ones into the existing one.</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="p">:</span>
            <span class="n">ce</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">corrected_entries</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;unfixed_old_version&quot;</span><span class="p">,</span> <span class="s2">&quot;unfixed_new_version&quot;</span><span class="p">])</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">ce</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="DatabaseManager.create_external_db">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_external_db">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_external_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve Ensembl-external-ID relationships and/or database statistics.</span>

<span class="sd">        This consolidates a complex SQL join—spanning Ensembl core tables *gene*, *transcript*, *translation* and</span>
<span class="sd">        the cross-reference tables *xref*, *object_xref*, *identity_xref*, *external_db*, and *external_synonym*—into a</span>
<span class="sd">        single pandas dataframe. It enables downstream analyses such as mapping Ensembl gene models to</span>
<span class="sd">        UniProt, RefSeq, or CCDS identifiers, or summarising which external sources are represented in a given Ensembl</span>
<span class="sd">        release.  The result type and granularity are controlled by *filter_mode*, allowing either the raw relationship</span>
<span class="sd">        rows or a per-database count to be returned.</span>

<span class="sd">        The query executed is conceptually equivalent to the (simplified) MySQL statement below,</span>
<span class="sd">        though the actual SQL is constructed programmatically for flexibility and performance:</span>

<span class="sd">        .. code-block:: sql</span>

<span class="sd">            SELECT g.stable_id, t.stable_id, tr.stable_id, x.dbprimary_acc, edb.db_name, es.synonym, ix.*</span>
<span class="sd">            FROM gene g</span>
<span class="sd">            JOIN transcript t USING (gene_id)</span>
<span class="sd">            JOIN translation tr USING (transcript_id)</span>
<span class="sd">            JOIN object_xref ox ON (g.gene_id = ox.ensembl_id AND ox.ensembl_object_type = &quot;Gene&quot;)</span>
<span class="sd">            JOIN xref x ON (ox.xref_id = x.xref_id)</span>
<span class="sd">            LEFT JOIN external_db edb ON (x.external_db_id = edb.external_db_id)</span>
<span class="sd">            LEFT JOIN identity_xref ix ON (ox.object_xref_id = ix.object_xref_id)</span>
<span class="sd">            LEFT JOIN external_synonym es ON (x.xref_id = es.xref_id)</span>
<span class="sd">            LIMIT 10;</span>

<span class="sd">        When tighter genomic scoping is required the *gene* table can be prefixed with *coord_system* and *seq_region*:</span>

<span class="sd">        .. code-block:: sql</span>

<span class="sd">            FROM coord_system cs</span>
<span class="sd">            JOIN seq_region  sr USING (coord_system_id)</span>
<span class="sd">            JOIN gene        g  USING (seq_region_id)</span>

<span class="sd">        You can experiment interactively against the public Ensembl MySQL mirror:</span>

<span class="sd">        .. code-block:: bash</span>

<span class="sd">            mysql --user=anonymous --host=ensembldb.ensembl.org -D homo_sapiens_core_105_38 -A</span>
<span class="sd">            # Schema reference:</span>
<span class="sd">            # https://m.ensembl.org/info/docs/api/core/core_schema.html</span>

<span class="sd">        Args:</span>
<span class="sd">            filter_mode (str): Controls both the **row subset** and the **output schema**. Must be one of:</span>

<span class="sd">                * ``&quot;all&quot;`` - return **every** mapping found in MySQL, no post-filtering applied.</span>
<span class="sd">                * ``&quot;relevant&quot;`` - return only mappings whose external database is marked *Include: true* in the</span>
<span class="sd">                    :py:meth:`ExternalDatabases.give_list_for_case` YAML configuration.</span>
<span class="sd">                * ``&quot;database&quot;`` - return a two-column summary (``name_db``, ``count``) for **all** external databases.</span>
<span class="sd">                * ``&quot;relevant-database&quot;`` - as above, but restricted to databases flagged *Include: true*.</span>
<span class="sd">                    The special values ``&quot;relevant&quot;`` and ``&quot;relevant-database&quot;`` implicitly consult the cached</span>
<span class="sd">                    :py:attr:`external_inst` to honour the user&#39;s curated allow-list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                * For ``&quot;all&quot;`` / ``&quot;relevant&quot;`` - six-column frame</span>
<span class="sd">                    ``[&quot;release&quot;, &quot;graph_id&quot;, &quot;id_db&quot;, &quot;name_db&quot;, &quot;ensembl_identity&quot;, &quot;xref_identity&quot;]`` holding one</span>
<span class="sd">                    row per Ensembl→external identifier edge. ``graph_id`` is the Ensembl stable ID (+version), while</span>
<span class="sd">                    the two *identity* columns store Smith-Waterman percent identities (*float16*) for QC.</span>
<span class="sd">                * For ``&quot;database&quot;`` / ``&quot;relevant-database&quot;`` - two-column frame</span>
<span class="sd">                    ``[&quot;name_db&quot;, &quot;count&quot;]`` giving how many distinct ``graph_id`` values each external database</span>
<span class="sd">                    touches. ``count`` is an ``int64``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *filter_mode* is not one of the accepted literals **or** if the YAML allow-list claims a</span>
<span class="sd">                database that is absent from the retrieved mappings—indicating the configuration and MySQL data are</span>
<span class="sd">                out of sync.</span>

<span class="sd">        Notes:</span>
<span class="sd">            *Synonym handling* - any synonym brought in from ``external_synonym`` is prefixed with</span>
<span class="sd">            :py:data:`DB.synonym_id_nodes_prefix`, and its ``name_db`` is likewise prefixed so that synonym nodes remain</span>
<span class="sd">            distinguishable during graph building.</span>
<span class="sd">            *Caching* - the heavy MySQL queries are executed only if the processed frame is not already present in the</span>
<span class="sd">            manager&#39;s per-organism HDF5 cache; otherwise the cached frame is read from disk, ensuring repeat calls are</span>
<span class="sd">            inexpensive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the necessary tables from the server</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;save_after_calculation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">}</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;idsraw_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
        <span class="n">ox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span>
            <span class="s2">&quot;object_xref&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ensembl_object_type&quot;</span><span class="p">,</span> <span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="s2">&quot;object_xref_id&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">m</span>
        <span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;xref&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="s2">&quot;external_db_id&quot;</span><span class="p">,</span> <span class="s2">&quot;dbprimary_acc&quot;</span><span class="p">,</span> <span class="s2">&quot;display_label&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">m</span><span class="p">)</span>
        <span class="n">ed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;external_db&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;external_db_id&quot;</span><span class="p">,</span> <span class="s2">&quot;db_name&quot;</span><span class="p">,</span> <span class="s2">&quot;db_display_name&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">m</span><span class="p">)</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;identity_xref&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ensembl_identity&quot;</span><span class="p">,</span> <span class="s2">&quot;xref_identity&quot;</span><span class="p">,</span> <span class="s2">&quot;object_xref_id&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">m</span><span class="p">)</span>
        <span class="n">es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;external_synonym&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="s2">&quot;synonym&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">m</span><span class="p">)</span>

        <span class="c1"># Make entities in synonyms table appended to the xref file as additional lines</span>
        <span class="n">es</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_one&quot;</span><span class="p">)</span>
        <span class="n">es</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;display_label&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">es</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;synonym&quot;</span><span class="p">:</span> <span class="s2">&quot;display_label&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">es</span><span class="p">[</span><span class="s2">&quot;display_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">synonym_id_nodes_prefix</span> <span class="o">+</span> <span class="n">es</span><span class="p">[</span><span class="s2">&quot;display_label&quot;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">es</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Merge the tables as requested</span>
        <span class="n">comb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">a</span><span class="p">,</span>
            <span class="n">ox</span><span class="p">[</span><span class="n">ox</span><span class="p">[</span><span class="s2">&quot;ensembl_object_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">lower</span><span class="p">()],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_id&quot;</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;one_to_many&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">comb</span> <span class="o">=</span> <span class="n">comb</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_many&quot;</span><span class="p">)</span>
        <span class="n">comb</span> <span class="o">=</span> <span class="n">comb</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ed</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;external_db_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_one&quot;</span><span class="p">)</span>
        <span class="n">comb</span> <span class="o">=</span> <span class="n">comb</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;object_xref_id&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_one&quot;</span><span class="p">)</span>

        <span class="c1"># Remove unnecessary columns and reset the index.</span>
        <span class="n">stable_id_version</span><span class="p">,</span> <span class="n">usecols_core</span><span class="p">,</span> <span class="n">usecols_asso</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">_determine_usecols_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="n">ids_only</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">usecols_asso</span> <span class="o">+</span> <span class="n">usecols_core</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">stable_id_version</span><span class="p">))</span>
        <span class="n">comb</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">,</span> <span class="s2">&quot;object_xref_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ensembl_object_type&quot;</span><span class="p">,</span> <span class="s2">&quot;xref_id&quot;</span><span class="p">,</span> <span class="s2">&quot;external_db_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ids_only</span><span class="p">,</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">comb</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Processing the merged dataframe</span>

        <span class="c1"># Constants for the processing</span>
        <span class="n">identities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ensembl_identity&quot;</span><span class="p">,</span> <span class="s2">&quot;xref_identity&quot;</span><span class="p">]</span>
        <span class="n">db_id</span> <span class="o">=</span> <span class="s2">&quot;id_db&quot;</span>
        <span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;name_db&quot;</span>
        <span class="n">id_graph</span> <span class="o">=</span> <span class="s2">&quot;graph_id&quot;</span>
        <span class="n">count_col</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">comb_renamer</span><span class="p">(</span><span class="n">col_list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">col_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">db_id</span><span class="p">,</span> <span class="n">col_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">db_name</span><span class="p">}</span>

        <span class="c1"># Create &quot;ID.Version&quot;</span>
        <span class="c1"># No need for version_uniformize as the gene_ids are obtained from create_id</span>
        <span class="n">comb_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_ver_from_df</span><span class="p">(</span><span class="n">comb</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">]))</span>
        <span class="c1"># Basically split below columns as separate rows and rename the columns.</span>
        <span class="n">comb_3_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;display_label&quot;</span><span class="p">,</span> <span class="s2">&quot;db_display_name&quot;</span><span class="p">]</span>
        <span class="n">comb_4_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dbprimary_acc&quot;</span><span class="p">,</span> <span class="s2">&quot;db_name&quot;</span><span class="p">]</span>
        <span class="n">comb_3</span><span class="p">,</span> <span class="n">comb_4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">comb_3</span><span class="p">[</span><span class="n">id_graph</span><span class="p">],</span> <span class="n">comb_4</span><span class="p">[</span><span class="n">id_graph</span><span class="p">]</span> <span class="o">=</span> <span class="n">comb_temp</span><span class="p">,</span> <span class="n">comb_temp</span>
        <span class="n">comb_3</span><span class="p">[</span><span class="n">comb_3_columns</span> <span class="o">+</span> <span class="n">identities</span><span class="p">]</span> <span class="o">=</span> <span class="n">comb</span><span class="p">[</span><span class="n">comb_3_columns</span> <span class="o">+</span> <span class="n">identities</span><span class="p">]</span>
        <span class="n">comb_4</span><span class="p">[</span><span class="n">comb_4_columns</span> <span class="o">+</span> <span class="n">identities</span><span class="p">]</span> <span class="o">=</span> <span class="n">comb</span><span class="p">[</span><span class="n">comb_4_columns</span> <span class="o">+</span> <span class="n">identities</span><span class="p">]</span>
        <span class="n">comb_3</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">comb_renamer</span><span class="p">(</span><span class="n">comb_3_columns</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
        <span class="n">comb_4</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">comb_renamer</span><span class="p">(</span><span class="n">comb_4_columns</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
        <span class="n">comb_3</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">comb_4</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">comb_3</span><span class="p">,</span> <span class="n">comb_4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">id_graph</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="n">res</span><span class="p">[</span><span class="n">db_id</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">db_name</span><span class="p">,</span> <span class="n">id_graph</span><span class="p">,</span> <span class="n">db_id</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Add the release information at the leftmost place</span>
        <span class="n">res</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;release&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">))))</span>

        <span class="c1"># Convert some columns type for convenience.</span>
        <span class="n">res</span><span class="p">[</span><span class="n">identities</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">identities</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="n">identities</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">identities</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;release&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;release&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>

        <span class="c1"># Drop duplicates if exists. Note that it is not trivial, there are many duplicated lines after adding</span>
        <span class="c1"># these columns as rows. Because, for some of them, comb_X_columns are actually the same.</span>
        <span class="n">res</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Change the synonym IDs&#39; database name</span>
        <span class="n">to_add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">DB</span><span class="o">.</span><span class="n">synonym_id_nodes_prefix</span> <span class="k">if</span> <span class="n">i</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">db_id</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">synonym_id_nodes_prefix</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_add</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span>
        <span class="c1"># Unless you specifically look at synonyms, they will not mean the same thing as the counterparts.</span>
        <span class="c1"># They will be used as the bridging point in the pathfinder algorithm only.</span>

        <span class="k">if</span> <span class="n">filter_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;relevant&quot;</span><span class="p">,</span> <span class="s2">&quot;relevant-database&quot;</span><span class="p">]:</span>
            <span class="c1"># In order to prevent the search space to be too big and to prevent unnecessary data to be kept in the disk</span>
            <span class="c1"># and in the memory.</span>
            <span class="n">isin_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_inst</span><span class="o">.</span><span class="n">give_list_for_case</span><span class="p">(</span><span class="n">give_type</span><span class="o">=</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>
            <span class="n">available_databases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">il</span> <span class="ow">in</span> <span class="n">available_databases</span> <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="n">isin_list</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inconsistency between external yaml file and current state of DatabaseManager.&quot;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">isin_list</span><span class="p">)]</span>

        <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;relevant&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">elif</span> <span class="n">filter_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;relevant-database&quot;</span><span class="p">]:</span>
            <span class="n">databases</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">db_name</span><span class="p">])</span><span class="o">.</span><span class="n">most_common</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">db_name</span><span class="p">,</span> <span class="n">count_col</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">databases</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span></div>


<div class="viewcode-block" id="DatabaseManager.create_database_content">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_database_content">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_database_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">just_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve and optionally cache external-database metadata for every assembly, release, and form.</span>

<span class="sd">        The helper iterates over *all* genome assemblies defined in</span>
<span class="sd">        :py:data:`idtrack._db.DB.assembly_mysqlport_priority`, every available Ensembl release for each assembly,</span>
<span class="sd">        and every identifier *form* supported by the package, downloading the ``external_database`` table for</span>
<span class="sd">        each combination.  The resulting frames are concatenated, enriched with ``assembly``, ``release``,</span>
<span class="sd">        ``form``, and ``organism`` columns, and returned to the caller.  When ``just_download`` is ``True`` the</span>
<span class="sd">        downloads are still performed (ensuring they are cached on disk for future runs) but an **empty**</span>
<span class="sd">        dataframe is returned to avoid unnecessary memory use.</span>

<span class="sd">        Args:</span>
<span class="sd">            just_download (bool):</span>
<span class="sd">                * **False** - concatenate intermediate results and return the union dataframe (default).</span>
<span class="sd">                * **True** - download and cache each frame but return an empty dataframe.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: External-database relationships augmented with assembly, release, form, and organism</span>
<span class="sd">                columns.  Empty when ``just_download`` is ``True``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># For all assemblies possible.</span>
            <span class="n">dm_assembly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_assembly</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">last_possible_ensembl_release</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dm_assembly</span><span class="o">.</span><span class="n">available_form_of_interests</span><span class="p">:</span>  <span class="c1"># For all assemblies possible.</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dm_assembly</span><span class="o">.</span><span class="n">available_releases</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Database content is being created for &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">`, assembly `</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">`, form `</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">`, ensembl release `</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">`&quot;</span>
                    <span class="p">)</span>
                    <span class="n">df_temp</span> <span class="o">=</span> <span class="n">dm_assembly</span><span class="o">.</span><span class="n">change_release</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">change_form</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;external_database&quot;</span><span class="p">)</span>
                    <span class="n">df_temp</span><span class="p">[</span><span class="s2">&quot;assembly&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="n">df_temp</span><span class="p">[</span><span class="s2">&quot;release&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">df_temp</span><span class="p">[</span><span class="s2">&quot;form&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">just_download</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_temp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">just_download</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;organism&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">organism</span>
            <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="DatabaseManager.create_release_id">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_release_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_release_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return deduplicated stable-identifier/version pairs for the current form and release.</span>

<span class="sd">        Raw identifiers are fetched via :py:meth:`DatabaseManager.get_db`, normalised with</span>
<span class="sd">        :py:meth:`DatabaseManager.version_fix`, trimmed to the canonical columns, and sanity-checked.  Two</span>
<span class="sd">        integrity rules are enforced: (1) the delimiter</span>
<span class="sd">        :py:data:`idtrack._db.DB.id_ver_delimiter` must **not** appear inside any stable identifier, and</span>
<span class="sd">        (2) every stable identifier must be unique after deduplication.  Violations raise</span>
<span class="sd">        :py:class:`ValueError`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Two-column dataframe ``[{form}_stable_id, {form}_version]`` with duplicates removed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the delimiter is present inside any stable identifier or if identifiers are not</span>
<span class="sd">                unique after deduplication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbm_the_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;idsraw_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dbm_the_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_fix</span><span class="p">(</span><span class="n">dbm_the_ids</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">)</span>
        <span class="n">dbm_the_ids</span> <span class="o">=</span> <span class="n">dbm_the_ids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dbm_the_ids</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">id_ver_delimiter</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The delimiter is in Ensembl IDs.&quot;</span><span class="p">)</span>

        <span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbm_the_ids</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_stable_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The stable IDs are not unique&quot;</span><span class="p">)</span>

        <span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dbm_the_ids</span></div>


<div class="viewcode-block" id="DatabaseManager.check_if_change_assembly_works">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.check_if_change_assembly_works">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_if_change_assembly_works</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_manager</span><span class="p">:</span> <span class="s2">&quot;DatabaseManager&quot;</span><span class="p">,</span> <span class="n">target_assembly</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate whether *db_manager* can be cloned to operate on *target_assembly*.</span>

<span class="sd">        A lightweight health-check that calls :py:meth:`DatabaseManager.change_assembly` inside a</span>
<span class="sd">        ``try/except`` block and converts the outcome to a boolean flag rather than letting the exception</span>
<span class="sd">        propagate.  It allows batch workflows to skip assemblies that are unavailable or invalid without</span>
<span class="sd">        interrupting processing.</span>

<span class="sd">        Args:</span>
<span class="sd">            db_manager (DatabaseManager): Manager instance to probe.</span>
<span class="sd">            target_assembly (int): Genome-assembly code to test (a key of</span>
<span class="sd">                :py:data:`idtrack._db.DB.assembly_mysqlport_priority`).</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: ``True`` if the assembly switch succeeds without raising :py:class:`ValueError`; ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">change_assembly</span><span class="p">(</span><span class="n">target_assembly</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="DatabaseManager.create_external_all">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_external_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_external_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">groupby</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">DataFrameGroupBy</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download and collate cross-reference mappings from every supported genome assembly.</span>

<span class="sd">        The manager cycles through every genome assembly recognised for the current organism (ordered by</span>
<span class="sd">        :py:data:`idtrack._db.DB.assembly_mysqlport_priority`), fetches the *external_relevant* mapping table</span>
<span class="sd">        for each via :py:meth:`~DatabaseManager.get_db`, labels every row with its source assembly, and finally</span>
<span class="sd">        concatenates the tables.  Because this helper is intended for **ad-hoc inspection only**, it bypasses</span>
<span class="sd">        the :py:meth:`~DatabaseManager.get_db` caching layer and therefore **never writes** the result to the</span>
<span class="sd">        local repository.</span>

<span class="sd">        Args:</span>
<span class="sd">            return_mode (str): Strategy for handling rows that appear in more than one assembly.</span>

<span class="sd">                - ``&quot;all&quot;``</span>
<span class="sd">                    Keep one copy of every unique</span>
<span class="sd">                    ``(release, graph_id, id_db, name_db, ensembl_identity, xref_identity, assembly)``</span>
<span class="sd">                    combination.  Duplicates are resolved *within* each assembly only.</span>

<span class="sd">                - ``&quot;unique&quot;``</span>
<span class="sd">                    Keep one copy of every unique</span>
<span class="sd">                    ``(release, graph_id, id_db, name_db, ensembl_identity, xref_identity)`` combination *across*</span>
<span class="sd">                    **all** assemblies, preferring the assembly with the highest</span>
<span class="sd">                    priority. *(Currently no downstream use case.)*</span>

<span class="sd">                - ``&quot;duplicated&quot;``</span>
<span class="sd">                    Return **only** the rows that occur in more than one assembly as a</span>
<span class="sd">                    :py:class:`pandas.core.groupby.generic.DataFrameGroupBy`, keyed by the same column set used for</span>
<span class="sd">                    ``&quot;unique&quot;``. *(Currently no downstream use case.)*</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[pandas.DataFrame, pandas.core.groupby.generic.DataFrameGroupBy]:</span>
<span class="sd">                - If *return_mode* is ``&quot;all&quot;`` or ``&quot;unique&quot;``,</span>
<span class="sd">                    a de-duplicated cross-reference table with the</span>
<span class="sd">                    columns ``release``, ``graph_id``, ``id_db``, ``name_db``, ``ensembl_identity``, ``xref_identity``,</span>
<span class="sd">                    and ``assembly``.</span>
<span class="sd">                - If *return_mode* is ``&quot;duplicated&quot;``,</span>
<span class="sd">                    a group-by view containing only duplicated entries.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *return_mode* is not ``&quot;all&quot;``, ``&quot;unique&quot;``, or ``&quot;duplicated&quot;``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_inst</span><span class="o">.</span><span class="n">give_list_for_case</span><span class="p">(</span><span class="n">give_type</span><span class="o">=</span><span class="s2">&quot;assembly&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">assembly_priority</span> <span class="o">=</span> <span class="p">[</span><span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Priority&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ass</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">assembly_priority</span><span class="p">,</span> <span class="n">ass</span><span class="p">))]:</span>  <span class="c1"># sort according to priority</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_change_assembly_works</span><span class="p">(</span><span class="n">db_manager</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_assembly</span><span class="o">=</span><span class="n">i</span><span class="p">):</span>
                <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_assembly</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">df_temp</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;external_relevant&quot;</span><span class="p">)</span>
                <span class="n">df_temp</span><span class="p">[</span><span class="s2">&quot;assembly&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_temp</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">compare_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s2">&quot;assembly&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_identity&quot;</span><span class="p">)</span>
        <span class="p">]</span>  <span class="c1"># &#39;ensembl_identity&#39;, &#39;xref_identity&#39;</span>
        <span class="n">compare_columns_2</span> <span class="o">=</span> <span class="n">compare_columns</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;assembly&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">return_mode</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="c1"># Drop duplicate rows that have all the columns the same with another row in the dataframe.</span>
            <span class="c1"># This also looks for &#39;assembly&#39; columns so it is possible to say assemlies are evaluated separately.</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">compare_columns_2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">elif</span> <span class="n">return_mode</span> <span class="o">==</span> <span class="s2">&quot;unique&quot;</span><span class="p">:</span>
            <span class="c1"># Unlike above, this does not also look for &#39;assembly&#39; columns, so an entry found in the higher priority</span>
            <span class="c1"># assembly will be kept but the others will be removed.</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">compare_columns</span><span class="p">)</span>
            <span class="c1"># Note that: after transition to new assembly. ensembl does not assign new versions etc to the older</span>
            <span class="c1"># keep the most priority one.</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">elif</span> <span class="n">return_mode</span> <span class="o">==</span> <span class="s2">&quot;duplicated&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">compare_columns</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
            <span class="n">dfg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">compare_columns</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dfg</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Undefined parameter for &#39;return_mode&#39;: </span><span class="si">{</span><span class="n">return_mode</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseManager.create_version_info">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.create_version_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_version_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine whether each Ensembl release stores identifiers with or without version suffixes.</span>

<span class="sd">        Ensembl stable identifiers can appear either *with* a ``.version`` facet (e.g. *ENSG00000139618.17*)</span>
<span class="sd">        or *without* it (e.g. *YAL001C* in *S. cerevisiae*).  For robust cross-release tracking the package</span>
<span class="sd">        needs to know which convention applies to every release of the current organism.  The method loops</span>
<span class="sd">        over :py:attr:`available_releases`, downloads the raw identifier table for *self.form*, and inspects</span>
<span class="sd">        the ``&lt;form&gt;_version`` column:</span>

<span class="sd">        * **All values NaN** → the release uses *unversioned* identifiers.</span>
<span class="sd">        * **No values NaN**  → the release uses *versioned* identifiers.</span>
<span class="sd">        * **Mixed NaN / non-NaN** → unsupported; raises :py:class:`NotImplementedError`.</span>

<span class="sd">        The outcome is encoded as a Boolean flag per release and later consumed by</span>
<span class="sd">        :py:meth:`~DatabaseManager.check_version_info` to decide whether version strings should be kept,</span>
<span class="sd">        stripped, or synthesised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Two-column table with:</span>
<span class="sd">                * ``ensembl_release`` - integer release number.</span>
<span class="sd">                * ``version_info``   - ``True`` if *all* identifiers **lack** a version suffix, ``False`` if</span>
<span class="sd">                    *all* identifiers **include** a version suffix.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If any individual release contains a mixture of versioned and unversioned</span>
<span class="sd">                identifiers, indicating an inconsistent upstream annotation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ver</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_releases</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">db_manager_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_release</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">df_ids</span> <span class="o">=</span> <span class="n">db_manager_temp</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;idsraw_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store_raw_always</span><span class="p">)</span>
            <span class="n">_vv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df_ids</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">_version&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_vv</span><span class="p">):</span>
                <span class="n">with_version</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">_vv</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Some identifiers with versions that are NaN, some are not.&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">with_version</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">ver</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">with_version</span><span class="p">])</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ver</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ensembl_release&quot;</span><span class="p">,</span> <span class="s2">&quot;version_info&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="DatabaseManager.get_db">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.get_db">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_db</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df_indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">create_even_if_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_after_calculation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">overwrite_even_if_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve or create a cached data table defined by an indicator string.</span>

<span class="sd">        This method is the central gateway for *all* tabular resources managed by</span>
<span class="sd">        :py:class:`~DatabaseManager`.  It interprets a compact *indicator* string,</span>
<span class="sd">        decides whether the requested table already exists in the local HDF5</span>
<span class="sd">        repository, and either loads the cached copy or triggers the appropriate</span>
<span class="sd">        builder (``create_*`` helper) to download/assemble it.  A consistent naming</span>
<span class="sd">        convention is maintained so that subsequent calls with the same indicator</span>
<span class="sd">        transparently reuse the on-disk cache, ensuring reproducible builds and</span>
<span class="sd">        minimal network traffic.</span>

<span class="sd">        **Supported base indicators**</span>

<span class="sd">        * ``external`` — cross-reference database registry; optional qualifier</span>
<span class="sd">            ``relevant`` | ``database`` | ``relevant-database`` narrows the view.</span>
<span class="sd">        * ``idsraw`` — raw Ensembl identifiers for a given form *(``gene``,</span>
<span class="sd">          ``transcript``, ``translation``)*; requires the form as qualifier.</span>
<span class="sd">        * ``ids`` — release-specific identifier table (no qualifier).</span>
<span class="sd">        * ``externalcontent`` — summary of per-database content.</span>
<span class="sd">        * ``relationcurrent`` — current gene/ID relationships.</span>
<span class="sd">        * ``relationarchive`` — historical gene/ID relationships across releases.</span>
<span class="sd">        * ``idhistory`` — full ID history; qualifier ``narrow`` restricts to current IDs.</span>
<span class="sd">        * ``versioninfo`` — version comparison across releases.</span>
<span class="sd">        * ``availabledatabases`` — list of locally cacheable resources.</span>

<span class="sd">        Additional indicators may be introduced by subclass extensions; consult the</span>
<span class="sd">        module documentation for the authoritative list.</span>

<span class="sd">        Args:</span>
<span class="sd">            df_indicator (str): Compact descriptor of the table to retrieve.  Must</span>
<span class="sd">                follow the ``base[qualifier]`` pattern described above.</span>
<span class="sd">            create_even_if_exist (bool): Force a rebuild/download even if</span>
<span class="sd">                a cached copy is present.  Defaults to ``False``.</span>
<span class="sd">            save_after_calculation (bool): Persist a newly created table</span>
<span class="sd">                to the local HDF5 store.  Has no effect when the table is merely</span>
<span class="sd">                loaded from disk.  Defaults to ``True``.</span>
<span class="sd">            overwrite_even_if_exist (bool): When saving, replace an</span>
<span class="sd">                existing HDF5 key with the same hierarchy (file-internal path).</span>
<span class="sd">                Defaults to ``False``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame | pandas.Series: The requested dataset.  The exact</span>
<span class="sd">            shape, index, and column layout depend on ``df_indicator``; see the</span>
<span class="sd">            indicator list above for semantic details.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *df_indicator* is malformed, references an unsupported</span>
<span class="sd">                resource, or its qualifier violates the expected pattern (e.g.,</span>
<span class="sd">                missing form for ``idsraw``).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">check_exist_as_diff_release</span><span class="p">(</span><span class="n">_df_type</span><span class="p">,</span> <span class="n">_df_indicator</span><span class="p">):</span>
            <span class="c1"># Get the file name associated with table_key and columns of interest.</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="n">_df_type</span><span class="p">,</span> <span class="n">_df_indicator</span><span class="p">)</span>

            <span class="c1"># The below pattern is based on file_name function with some modifications.</span>
            <span class="c1"># Organism name and form is excluded as it does not change the resulting file.</span>
            <span class="n">_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ens([0-9]+)_</span><span class="si">{</span><span class="n">_df_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">_df_indicator</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">_file_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">hs</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">_file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">_keys</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">_downloaded_rels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="nb">int</span><span class="p">(</span><span class="n">_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_keys</span> <span class="k">if</span> <span class="n">_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">i</span><span class="p">)})</span>

            <span class="k">for</span> <span class="n">_dr</span> <span class="ow">in</span> <span class="n">_downloaded_rels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_dr</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_dr</span><span class="p">,</span> <span class="n">_downloaded_rels</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_downloaded_rels</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">remove_redundant_exist</span><span class="p">(</span><span class="n">_df_type</span><span class="p">,</span> <span class="n">_df_indicator</span><span class="p">,</span> <span class="n">_keep_rel</span><span class="p">,</span> <span class="n">_all_rel_lst</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_arl</span> <span class="ow">in</span> <span class="n">_all_rel_lst</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_arl</span> <span class="o">!=</span> <span class="n">_keep_rel</span><span class="p">:</span>
                    <span class="n">_hi</span><span class="p">,</span> <span class="n">_fi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="n">_df_type</span><span class="p">,</span> <span class="n">_df_indicator</span><span class="p">,</span> <span class="n">ensembl_release</span><span class="o">=</span><span class="n">_arl</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">hs</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">_fi</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_hi</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Following file is being removed: `</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">_fi</span><span class="p">)</span><span class="si">}</span><span class="s2">` with key `</span><span class="si">{</span><span class="n">_hi</span><span class="si">}</span><span class="s2">`. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;This could cause hdf5 file to not reclaim the emptied disk space.&quot;</span>
                        <span class="p">)</span>

        <span class="c1"># Split the df_indicator with &quot;_&quot;, to get the extra parameters.</span>
        <span class="c1"># Main point of naming and df_indicator is to include the paramters in the file_names</span>
        <span class="c1"># for exporting and importing without writing explicit methods of read/write for each case.</span>
        <span class="n">split_ind</span> <span class="o">=</span> <span class="n">df_indicator</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">main_ind</span> <span class="o">=</span> <span class="n">split_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">param1_ind</span> <span class="o">=</span> <span class="n">split_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># For &#39;availabledatabases&#39; accept different files explained in the below functions.</span>
        <span class="k">if</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;availabledatabases&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xr1</span><span class="p">,</span> <span class="n">xr1_a</span> <span class="o">=</span> <span class="n">check_exist_as_diff_release</span><span class="p">(</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">)</span>
            <span class="n">remove_redundant_exist</span><span class="p">(</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">,</span> <span class="n">xr1</span><span class="p">,</span> <span class="n">xr1_a</span><span class="p">)</span>
            <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">,</span> <span class="n">ensembl_release</span><span class="o">=</span><span class="n">xr1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;versioninfo&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xr1</span><span class="p">,</span> <span class="n">xr1_a</span> <span class="o">=</span> <span class="n">check_exist_as_diff_release</span><span class="p">(</span><span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">)</span>
            <span class="n">remove_redundant_exist</span><span class="p">(</span><span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">,</span> <span class="n">xr1</span><span class="p">,</span> <span class="n">xr1_a</span><span class="p">)</span>
            <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">,</span> <span class="n">ensembl_release</span><span class="o">=</span><span class="n">xr1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">main_ind</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;relationarchive&quot;</span><span class="p">,</span> <span class="s2">&quot;relationcurrent&quot;</span><span class="p">):</span>
            <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get the file name associated with table_key and columns of interest.</span>
            <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="n">df_indicator</span><span class="p">)</span>

        <span class="c1"># If the file name is not accessible for reading, or if the hdf5 file does not contain the table,</span>
        <span class="c1"># or explicitly prompt to do so, then download the table.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span> <span class="ow">or</span> <span class="n">create_even_if_exist</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">hs</span><span class="o">.</span><span class="n">check_h5_key</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;external&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_external_db</span><span class="p">(</span><span class="n">filter_mode</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;external&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;relevant&quot;</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;relevant-database&quot;</span><span class="p">]:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_external_db</span><span class="p">(</span><span class="n">filter_mode</span><span class="o">=</span><span class="n">param1_ind</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;idsraw&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">param1_ind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_form_of_interests</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;idsraw&#39; should be used together with one &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;of followings: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_form_of_interests</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_ids</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">param1_ind</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;ids&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_release_id</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;externalcontent&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_database_content</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;relationcurrent&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_relation_current</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;relationarchive&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_relation_archive</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;idhistory&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_id_history</span><span class="p">(</span><span class="n">narrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;idhistory&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="o">==</span> <span class="s2">&quot;narrow&quot;</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_id_history</span><span class="p">(</span><span class="n">narrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;versioninfo&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_version_info</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">main_ind</span> <span class="o">==</span> <span class="s2">&quot;availabledatabases&quot;</span> <span class="ow">and</span> <span class="n">param1_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_available_databases</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected entry for &#39;df_indicator&#39;.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise, just read the file that is already in the directory.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">read_exported</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># If prompt, save the dataframe in requested format.</span>
        <span class="k">if</span> <span class="n">save_after_calculation</span><span class="p">:</span>
            <span class="n">hs</span><span class="o">.</span><span class="n">export_disk</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">overwrite_even_if_exist</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="DatabaseManager.file_name">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.file_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ensembl_release</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve HDF5 hierarchy key and absolute file path for a dataframe request.</span>

<span class="sd">        This internal helper centralises every rule that :py:class:`DatabaseManager` uses to build HDF5</span>
<span class="sd">        *hierarchy* keys and their corresponding on-disk filenames, ensuring that any two call-sites</span>
<span class="sd">        confronted with the same combination of organism, genome assembly, Ensembl release, dataframe</span>
<span class="sd">        *kind*, and optional column subset produce **identical** results.  By funnelling every I/O</span>
<span class="sd">        operation through this method the wider package avoids silent cache misses, duplicate downloads,</span>
<span class="sd">        and hard-to-trace inconsistencies in downstream analytics.  Public code is expected to invoke</span>
<span class="sd">        higher-level wrappers such as :py:meth:`DatabaseManager.get_db`; use this routine only when</span>
<span class="sd">        implementing new caching utilities or in low-level tests.</span>

<span class="sd">        Args:</span>
<span class="sd">            df_type (str): Category of dataframe whose name is required. Accepted values are</span>
<span class="sd">                ``&quot;processed&quot;``, ``&quot;mysql&quot;``, and ``&quot;common&quot;``; any other string triggers :py:class:`ValueError`.</span>
<span class="sd">            ensembl_release (int, optional): Ensembl release to encode in the filename.  If *None*, the</span>
<span class="sd">                current :py:attr:`DatabaseManager.ensembl_release` is used instead.</span>
<span class="sd">            kwargs: Additional keyword arguments forwarded to the helper that handles the selected</span>
<span class="sd">                *df_type* (currently only ``usecols`` for the *mysql* path).</span>
<span class="sd">            args: Positional arguments interpreted according to *df_type*:</span>

<span class="sd">                - **processed** - ``df_indicator`` (str): symbolic label such as ``&quot;idhistory&quot;`` or</span>
<span class="sd">                  ``&quot;idsraw_gene&quot;``.  The manager appends :py:attr:`DatabaseManager.form` so that artefacts</span>
<span class="sd">                  for different biological forms do not collide.</span>

<span class="sd">                - **mysql** - ``table_key`` (str): raw MySQL table name (e.g. ``&quot;gene&quot;``, ``&quot;exon&quot;``).</span>
<span class="sd">                  An optional ``usecols`` (list[str]) must then be supplied via *kwargs*; the column list</span>
<span class="sd">                  is embedded in the hierarchy using the delimiter held in</span>
<span class="sd">                  :py:attr:`DatabaseManager._column_sep`.</span>

<span class="sd">                - **common** - ``df_indicator`` (str): same as the processed case **but without** the form</span>
<span class="sd">                  suffix, allowing cross-form artefacts (e.g. ``&quot;availabledatabases&quot;``) to share a single key.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[str, str]: Two-element tuple ``(hierarchy_key, file_path)`` where *hierarchy_key* is</span>
<span class="sd">                the internal node path (e.g. ``&quot;ens111_mysql_gene_COL_gene_id&quot;``) and *file_path* is the</span>
<span class="sd">                absolute path to ``&lt;local_repository&gt;/&lt;organism&gt;_assembly-&lt;assembly&gt;.h5``.  The path is</span>
<span class="sd">                **not** created on disk—callers remain responsible for reading or writing the HDF5 file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *df_type* is not one of the accepted categories or if the positional/keyword</span>
<span class="sd">                argument combination does not satisfy the expectations for that category (e.g. missing</span>
<span class="sd">                ``table_key`` when *df_type* is ``&quot;mysql&quot;``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ensembl_release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensembl_release</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ensembl_release</span> <span class="k">else</span> <span class="n">ensembl_release</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">file_name_processed</span><span class="p">(</span><span class="n">df_indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ens</span><span class="si">{</span><span class="n">ensembl_release</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_indicator</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">file_name_mysql</span><span class="p">(</span><span class="n">table_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">usecols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">col_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_sep</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">usecols</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">usecols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ens</span><span class="si">{</span><span class="n">ensembl_release</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">table_key</span><span class="si">}{</span><span class="n">col_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">file_name_noform</span><span class="p">(</span><span class="n">df_indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ens</span><span class="si">{</span><span class="n">ensembl_release</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_indicator</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">df_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="s2">&quot;common&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter is not in specified format: df_type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;processed&quot;</span><span class="p">:</span>
            <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">file_name_processed</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span><span class="p">:</span>
            <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">file_name_noform</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">file_name_mysql</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hierarchy</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_repository</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">organism</span><span class="si">}</span><span class="s2">_assembly-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_assembly</span><span class="si">}</span><span class="s2">.h5&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DatabaseManager.id_ver_from_df">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.id_ver_from_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">id_ver_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbm_the_ids</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble fully qualified node names from a *stable-ID / version* DataFrame.</span>

<span class="sd">        This convenience routine converts a two-column frame—usually produced by</span>
<span class="sd">        :py:meth:`DatabaseManager.get_db` with the *ids* form—into the canonical node</span>
<span class="sd">        labels used throughout ID-track graphs (e.g. ``ENSG00000000001.1``).  It first</span>
<span class="sd">        validates that the input columns match :py:data:`self._identifiers`</span>
<span class="sd">        (typically ``[&quot;gene_stable_id&quot;, &quot;gene_version&quot;]`` or analogous for the</span>
<span class="sd">        current ``form``), then delegates per-row processing to</span>
<span class="sd">        :py:meth:`DatabaseManager.node_dict_maker` and</span>
<span class="sd">        :py:meth:`DatabaseManager.node_name_maker`.  The resulting list may be fed</span>
<span class="sd">        directly into downstream graph builders or written to disk for later reuse.</span>

<span class="sd">        Args:</span>
<span class="sd">            dbm_the_ids (pandas.DataFrame): Two-column frame containing the stable</span>
<span class="sd">                identifiers and their Ensembl version numbers.  The column order and</span>
<span class="sd">                names **must** exactly match ``self._identifiers``; otherwise an</span>
<span class="sd">                exception is raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str]: Ordered list where each element is either</span>
<span class="sd">                ``&quot;&lt;ID&gt;.&lt;version&gt;&quot;`` when a valid numeric version is present or simply</span>
<span class="sd">                ``&quot;&lt;ID&gt;&quot;`` when the version is *None* / *NaN* / an alternative marker</span>
<span class="sd">                (see :py:data:`idtrack._db.DB.alternative_versions`).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If ``dbm_the_ids`` does not contain the expected column</span>
<span class="sd">                names stored in :py:data:`self._identifiers`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Column names of the &#39;dbm_the_ids&#39; is not as expected. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifiers</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">gri_generator</span> <span class="o">=</span> <span class="p">(</span><span class="n">DatabaseManager</span><span class="o">.</span><span class="n">node_dict_maker</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dbm_the_ids</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">DatabaseManager</span><span class="o">.</span><span class="n">node_name_maker</span><span class="p">,</span> <span class="n">gri_generator</span><span class="p">))</span></div>


<div class="viewcode-block" id="DatabaseManager.node_name_maker">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.node_name_maker">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">node_name_maker</span><span class="p">(</span><span class="n">node_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Concatenate *ID* and *Version* into a single node label.</span>

<span class="sd">        Given the miniature dictionary returned by</span>
<span class="sd">        :py:meth:`DatabaseManager.node_dict_maker`, this helper builds the string</span>
<span class="sd">        representation that uniquely identifies a biological entity within the graph</span>
<span class="sd">        layer.  When a numeric version is available, it appends that value to the</span>
<span class="sd">        stable ID using :py:data:`idtrack._db.DB.id_ver_delimiter` (``&quot;.&quot;`` by</span>
<span class="sd">        default).  For organisms or datasets lacking versioned identifiers, it falls</span>
<span class="sd">        back to the bare stable ID to preserve compatibility.</span>

<span class="sd">        Args:</span>
<span class="sd">            node_dict (dict[str, Any]): Mapping with exactly two keys, ``&quot;ID&quot;`` and</span>
<span class="sd">                ``&quot;Version&quot;``, as produced by</span>
<span class="sd">                :py:meth:`DatabaseManager.node_dict_maker`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Either ``&quot;&lt;ID&gt;.&lt;version&gt;&quot;`` or ``&quot;&lt;ID&gt;&quot;`` depending on whether a</span>
<span class="sd">                non-null, non-alternative version is present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_dict</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">node_dict</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">node_dict</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">DB</span><span class="o">.</span><span class="n">id_ver_delimiter</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_dict</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node_dict</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="DatabaseManager.node_dict_maker">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.node_dict_maker">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">node_dict_maker</span><span class="p">(</span><span class="n">id_entry</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version_entry</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a normalized *ID/Version* dictionary from raw column values.</span>

<span class="sd">        This helper creates the canonical structure consumed by</span>
<span class="sd">        :py:meth:`DatabaseManager.node_name_maker` and higher-level graph utilities,</span>
<span class="sd">        ensuring that version numbers are strictly integers whenever possible.  It</span>
<span class="sd">        also recognises special placeholders defined in</span>
<span class="sd">        :py:data:`idtrack._db.DB.alternative_versions` (e.g. ``&quot;Retired&quot;`` or</span>
<span class="sd">        ``&quot;Void&quot;``) and passes them through unchanged so that downstream code can</span>
<span class="sd">        handle deprecated or missing entries appropriately.</span>

<span class="sd">        Args:</span>
<span class="sd">            id_entry (str): Stable identifier portion preceding the delimiter</span>
<span class="sd">                (e.g. ``&quot;ENSG00000000001&quot;``).</span>
<span class="sd">            version_entry (Any): Raw version value following the delimiter</span>
<span class="sd">                (e.g. ``1`` in ``&quot;ENSG00000000001.1&quot;``).  May be *float*, *int*,</span>
<span class="sd">                *str*, *None*, *NaN*, or an alternative placeholder such as</span>
<span class="sd">                ``&quot;Retired&quot;``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: ``{&quot;ID&quot;: id_entry, &quot;Version&quot;: version_entry}`` with</span>
<span class="sd">            *Version* coerced to *int* when it represents a whole number.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If ``version_entry`` is numeric but contains a fractional</span>
<span class="sd">                component (e.g. ``1.2``), indicating a malformed identifier that cannot</span>
<span class="sd">                be represented as an integer version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">version_entry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">version_entry</span><span class="p">)</span> <span class="ow">and</span> <span class="n">version_entry</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">alternative_versions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_entry</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="n">version_entry</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version is floating: </span><span class="si">{</span><span class="p">(</span><span class="n">id_entry</span><span class="p">,</span><span class="w"> </span><span class="n">version_entry</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version_entry</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_entry</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="n">id_entry</span><span class="p">,</span> <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="n">version_entry</span><span class="p">}</span></div>


<div class="viewcode-block" id="DatabaseManager.version_uniformize">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.version_uniformize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">version_uniformize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">version_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalise a *Version* column so every entry is either an ``int`` or ``NaN``.</span>

<span class="sd">        This post-processing helper finalises the output of :py:meth:`DatabaseManager.create_ids`.</span>
<span class="sd">        Ensembl releases differ: some assign an explicit integer version to every stable identifier,</span>
<span class="sd">        whereas others omit the suffix entirely.  Downstream code expects a *uniform* dtype, so this</span>
<span class="sd">        routine coerces the designated column to a proper integer when *all* entries are present or</span>
<span class="sd">        fills the entire column with ``np.nan`` when *none* are.  Mixed presence is forbidden because</span>
<span class="sd">        it would break the ID-version pairing logic used by :py:meth:`DatabaseManager.node_name_maker`.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): Frame returned by :py:meth:`create_ids`; must already contain a</span>
<span class="sd">                column named *version_str*.</span>
<span class="sd">            version_str (str): Name of the column that holds version information (e.g. ``&quot;gene_version&quot;``).</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Same object *df* with *version_str* either cast to ``int64`` or overwritten</span>
<span class="sd">                with ``np.nan`` for every row.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If some rows have a version and others do not, indicating an Ensembl</span>
<span class="sd">                release with inconsistent schema.  Such a release is currently unsupported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contains_na</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">contains_na</span><span class="p">):</span>
            <span class="c1"># If there is no version information associated with stable_ids. For some organisms like S. cerevisiae</span>
            <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">contains_na</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Some identifiers with versions that are NaN, some are not.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="DatabaseManager.version_fix_incomplete">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.version_fix_incomplete">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">version_fix_incomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_fx</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">id_col_fx</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ver_col_fx</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up version columns when *some* identifiers are entirely missing.</span>

<span class="sd">        Ensembl *translation* tables occasionally encode parent IDs without a version while descendants</span>
<span class="sd">        retain one, producing frames where *id_col_fx* is ``NaN`` but *ver_col_fx* contains a number.</span>
<span class="sd">        This helper splits the frame, delegates to :py:meth:`version_fix` for each subset, then stitches</span>
<span class="sd">        the pieces back together so that every row obeys a single “with/without/add version” policy.</span>

<span class="sd">        Args:</span>
<span class="sd">            df_fx (pandas.DataFrame): Data to harmonise.  The frame **must** include *id_col_fx* and *ver_col_fx*.</span>
<span class="sd">            id_col_fx (str): Column holding the *stable* part of the identifier (e.g. ``&quot;translation_id&quot;``).</span>
<span class="sd">            ver_col_fx (str): Column holding the integer version suffix.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Frame whose *ver_col_fx* is consistent with the organism-level policy</span>
<span class="sd">                determined by :py:meth:`check_version_info`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the columns that do not have any id</span>
        <span class="n">na_cols_fx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df_fx</span><span class="p">[</span><span class="n">id_col_fx</span><span class="p">])</span>

        <span class="c1"># Split the dataframe to process separately</span>
        <span class="n">df_fm1</span><span class="p">,</span> <span class="n">df_fm2</span> <span class="o">=</span> <span class="n">df_fx</span><span class="p">[</span><span class="n">na_cols_fx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">df_fx</span><span class="p">[</span><span class="o">~</span><span class="n">na_cols_fx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">version_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_version_info</span><span class="p">()</span>
        <span class="n">df_fm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_fix</span><span class="p">(</span><span class="n">df_fm1</span><span class="p">,</span> <span class="n">ver_col_fx</span><span class="p">,</span> <span class="n">version_info</span><span class="o">=</span><span class="s2">&quot;without_version&quot;</span><span class="p">)</span>
        <span class="n">df_fm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_fix</span><span class="p">(</span><span class="n">df_fm2</span><span class="p">,</span> <span class="n">ver_col_fx</span><span class="p">,</span> <span class="n">version_info</span><span class="o">=</span><span class="n">version_info</span><span class="p">)</span>

        <span class="c1"># Concatenate the results and return.</span>
        <span class="n">df_fx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_fm1</span><span class="p">,</span> <span class="n">df_fm2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_fx</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_fx</span></div>


<div class="viewcode-block" id="DatabaseManager.version_fix">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.version_fix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">version_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">version_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply a *global* ID-version policy to a DataFrame.</span>

<span class="sd">        Depending on the organism and its historical annotation quirks, identifiers may (1) **never**</span>
<span class="sd">        include a version, (2) **always** include a version, or (3) require a *synthetic* version when</span>
<span class="sd">        mixing cross-release data.  The *version_info* flag encodes that policy:</span>

<span class="sd">        * ``&quot;without_version&quot;`` — strip all versions (set column to ``NaN``).</span>
<span class="sd">        * ``&quot;with_version&quot;``    — cast column to ``int64`` (all values must exist).</span>
<span class="sd">        * ``&quot;add_version&quot;``     — fill missing entries with :py:data:`DB.first_version`.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): Frame whose *version_str* column needs harmonising.</span>
<span class="sd">            version_str (str): Name of the column that stores version numbers.</span>
<span class="sd">            version_info (Optional[str]): One of ``&quot;add_version&quot;``, ``&quot;without_version&quot;``, or</span>
<span class="sd">                ``&quot;with_version&quot;``.  When ``None`` (default) the method calls</span>
<span class="sd">                :py:meth:`check_version_info` to determine the correct policy automatically.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: Same object *df* with *version_str* updated in-place.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If *version_info* is not recognised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If version_info is not entered, just re-calculate.</span>
        <span class="n">version_info</span> <span class="o">=</span> <span class="n">version_info</span> <span class="k">if</span> <span class="n">version_info</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_version_info</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">version_info</span> <span class="o">==</span> <span class="s2">&quot;add_version&quot;</span><span class="p">:</span>
            <span class="c1"># Set the constant value of DB.first_version as the Version.</span>
            <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">first_version</span>

        <span class="k">elif</span> <span class="n">version_info</span> <span class="o">==</span> <span class="s2">&quot;without_version&quot;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">elif</span> <span class="n">version_info</span> <span class="o">==</span> <span class="s2">&quot;with_version&quot;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">version_str</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Undefined choice for &#39;version_info&#39;.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="DatabaseManager.check_version_info">
<a class="viewcode-back" href="../../reference.html#idtrack._database_manager.DatabaseManager.check_version_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_version_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Infer whether the organism&#39;s Ensembl IDs come **with**, **without**, or **mixed** versions.</span>

<span class="sd">        The method scans all releases available for the current genome assembly and inspects the boolean</span>
<span class="sd">        flag in the ``version_info`` column of a pre-computed table (``get_db(&quot;versioninfo&quot;)``).  Three</span>
<span class="sd">        mutually exclusive scenarios exist:</span>

<span class="sd">        * All releases lack version suffixes: ``&quot;without_version&quot;``</span>
<span class="sd">        * All releases include suffixes: ``&quot;with_version&quot;``</span>
<span class="sd">        * A mixture of both states: ``&quot;add_version&quot;`` (synthetic versions will be injected)</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: One of ``&quot;without_version&quot;``, ``&quot;with_version&quot;``, or ``&quot;add_version&quot;``.  Callers use the</span>
<span class="sd">                string to decide how to standardise identifier columns.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the *version_info* column in the source table is not strictly boolean, signalling</span>
<span class="sd">                a corrupted download or schema drift.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vi_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;versioninfo&quot;</span><span class="p">)</span>
        <span class="n">narrowed</span> <span class="o">=</span> <span class="n">vi_df</span><span class="p">[</span><span class="s2">&quot;version_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">narrowed</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data type of &#39;version_info&#39; column must be boolean.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">narrowed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">narrowed</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;without_version&quot;</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">narrowed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;with_version&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;add_version&quot;</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Kemal Inecik.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>