

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>idtrack._track_tests &mdash; idtrack 0.0.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom_settings.css?v=15bcc2cf" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8c5712d9"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            idtrack
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code_of_conduct.html">Contributor Covenant Code of Conduct</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">idtrack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">idtrack._track_tests</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for idtrack._track_tests</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># Kemal Inecik</span>
<span class="c1"># k.inecik@gmail.com</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">idtrack._db</span><span class="w"> </span><span class="kn">import</span> <span class="n">DB</span><span class="p">,</span> <span class="n">EmptyConversionMetricsError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">idtrack._track</span><span class="w"> </span><span class="kn">import</span> <span class="n">Track</span>


<div class="viewcode-block" id="TrackTests">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TrackTests</span><span class="p">(</span><span class="n">Track</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Developer-facing integrity-test harness for :py:class:`~idtrack.Track`.</span>

<span class="sd">    This module defines :py:class:`TrackTests`, a mix-in that adds an extensive</span>
<span class="sd">    white-box test suite to a populated :py:class:`idtrack.Track` instance.  The</span>
<span class="sd">    class is **for developers only**; it should never be used in production</span>
<span class="sd">    pipelines.  Every public method beginning with ``is_`` returns a boolean</span>
<span class="sd">    that tells whether a specific invariant holds.  Methods beginning with</span>
<span class="sd">    ``history_`` execute heavier, end-to-end conversions and collect rich</span>
<span class="sd">    statistics. The class is intended to be *mixin-ed* into a concrete Track</span>
<span class="sd">    subclass—or instantiated standalone—**after** the underlying graph and</span>
<span class="sd">    lookup tables have been fully built.  It performs purely read-only</span>
<span class="sd">    operations and therefore imposes no risk of mutating state.</span>

<span class="sd">    All test methods share the following contract:</span>

<span class="sd">    * They never raise on failure—*return-value only*—so they can be run in</span>
<span class="sd">      bulk without interrupting your session.</span>
<span class="sd">    * A return value of ``True`` means the invariant holds; ``False`` means</span>
<span class="sd">      a violation was detected.</span>
<span class="sd">    * Where useful, a *verbose* flag gives a tqdm progress bar so long-</span>
<span class="sd">      running checks remain user-friendly.</span>

<span class="sd">    Typical use::</span>

<span class="sd">        tests = TrackTests(...)</span>
<span class="sd">        tests.is_id_functions_consistent_ensembl()  # Raises if inconsistent.</span>

<span class="sd">    Note:</span>
<span class="sd">        The class is *not* designed for production; instantiate it only in test</span>
<span class="sd">        suites or interactive debugging sessions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the test harness.</span>

<span class="sd">        All positional and keyword arguments are forwarded verbatim to</span>
<span class="sd">        :py:class:`~idtrack.Track.__init__`.  Besides constructing the underlying</span>
<span class="sd">        graph, the initializer sets up a dedicated :py:data:`logging.Logger`</span>
<span class="sd">        named ``&quot;track_tests&quot;`` so individual test routines can emit structured</span>
<span class="sd">        diagnostics without polluting the main application log.</span>

<span class="sd">        Args:</span>
<span class="sd">            args: Positional arguments accepted by :py:class:`~idtrack.Track.__init__`.</span>
<span class="sd">            kwargs: Keyword arguments accepted by :py:class:`~idtrack.Track.__init__`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># Sub-class initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;track_tests&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="TrackTests.is_id_functions_consistent_ensembl">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.is_id_functions_consistent_ensembl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_id_functions_consistent_ensembl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure Ensembl ID-list helpers agree with the SQL back-end.</span>

<span class="sd">        For every release listed in ``graph.graph[&quot;confident_for_release&quot;]``</span>
<span class="sd">        the test compares two independent sources of Ensembl-gene IDs for the</span>
<span class="sd">        *current genome assembly*:</span>

<span class="sd">        1. IDs retrieved directly from MySQL via</span>
<span class="sd">           :py:class:`~idtrack.DatabaseManager`.</span>
<span class="sd">        2. IDs returned by :py:meth:`idtrack.Track.get_id_list` from the graph.</span>

<span class="sd">        A mismatch means either the graph was built incompletely or the</span>
<span class="sd">        helper functions drift out of sync with the database schema.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: If ``True`` (default) show a tqdm progress-bar while</span>
<span class="sd">                iterating through the releases.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: ``True`` when **all** releases produce identical sets; else</span>
<span class="sd">            ``False`` (a descriptive warning is logged).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assembly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;genome_assembly&quot;</span><span class="p">]</span>
        <span class="c1"># Others should not have consistent as only the main assembly is added fully.</span>
        <span class="c1"># In other assemblies, the Ensembl IDs are added if there is an external connection.</span>
        <span class="n">switch</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;confident_for_release&quot;</span><span class="p">],</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">loop_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ens_rel</span> <span class="ow">in</span> <span class="n">loop_obj</span><span class="p">:</span>
                <span class="n">loop_obj</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Item:</span><span class="si">{</span><span class="n">ens_rel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">check_if_change_assembly_works</span><span class="p">(</span>
                    <span class="n">db_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">change_release</span><span class="p">(</span><span class="n">ens_rel</span><span class="p">),</span> <span class="n">target_assembly</span><span class="o">=</span><span class="n">assembly</span>
                <span class="p">):</span>
                    <span class="n">db_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">change_release</span><span class="p">(</span><span class="n">ens_rel</span><span class="p">)</span><span class="o">.</span><span class="n">change_assembly</span><span class="p">(</span><span class="n">assembly</span><span class="p">)</span>
                    <span class="n">ids_from</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">db_from</span><span class="o">.</span><span class="n">id_ver_from_df</span><span class="p">(</span><span class="n">db_from</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;ids&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>

                    <span class="n">ids_from_graph</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_id_list</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">nts_assembly</span><span class="p">[</span><span class="n">assembly</span><span class="p">][</span><span class="n">DB</span><span class="o">.</span><span class="n">backbone_form</span><span class="p">],</span> <span class="n">assembly</span><span class="p">,</span> <span class="n">ens_rel</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">ids_from</span> <span class="o">!=</span> <span class="n">ids_from_graph</span><span class="p">:</span>
                        <span class="n">switch</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Inconsistent results for ID list functions (ensembl), at release `</span><span class="si">{</span><span class="n">ens_rel</span><span class="si">}</span><span class="s2">`.&quot;</span>
                        <span class="p">)</span>

        <span class="k">return</span> <span class="n">switch</span></div>


<div class="viewcode-block" id="TrackTests.is_id_functions_consistent_ensembl_2">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.is_id_functions_consistent_ensembl_2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_id_functions_consistent_ensembl_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cross-check Ensembl ID *range* helpers against raw edge data.</span>

<span class="sd">        For every **backbone** Ensembl-gene node the routine computes the list</span>
<span class="sd">        of active release ranges in two distinct ways:</span>

<span class="sd">        1. **Raw computation** - by flattening</span>
<span class="sd">           ``graph.combined_edges_genes`` and compacting the releases with</span>
<span class="sd">           :py:meth:`idtrack.Track.list_to_ranges`.</span>
<span class="sd">        2. **Cached lookup** - via the lazily built dictionary</span>
<span class="sd">           ``graph.get_active_ranges_of_id``.</span>

<span class="sd">        The two lists must match exactly.  A divergence would indicate that</span>
<span class="sd">        the cached helper is out of sync with the authoritative edge</span>
<span class="sd">        structure.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: If ``True`` (default) wrap the iteration in a tqdm bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: ``True`` if *all* gene nodes pass; ``False`` after the first</span>
<span class="sd">            failure (a warning is emitted).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">the_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;node_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">DB</span><span class="o">.</span><span class="n">nts_ensembl</span><span class="p">[</span><span class="n">DB</span><span class="o">.</span><span class="n">backbone_form</span><span class="p">]</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">alternative_versions</span>
            <span class="p">):</span>
                <span class="n">the_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">assembly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;genome_assembly&quot;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">the_ids</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="k">as</span> <span class="n">loop_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">loop_obj</span><span class="p">:</span>
                <span class="n">loop_obj</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Item:</span><span class="si">{</span><span class="n">ti</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># (1) raw recomputation</span>
                <span class="n">data1_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">combined_edges_genes</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span>
                <span class="n">data1_</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">k</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data1_raw</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">data1_raw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data1_raw</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">assembly</span><span class="p">})</span>
                <span class="n">data1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">list_to_ranges</span><span class="p">(</span><span class="n">data1_</span><span class="p">)</span>
                <span class="c1"># (2) cached view</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;confident_for_release&quot;</span><span class="p">])]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_active_ranges_of_id</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="n">data1</span> <span class="o">!=</span> <span class="n">data2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inconsistency between ID range functions: `</span><span class="si">{</span><span class="n">ti</span><span class="p">,</span><span class="w"> </span><span class="n">data1</span><span class="p">,</span><span class="w"> </span><span class="n">data2</span><span class="p">,</span><span class="w"> </span><span class="n">data1_raw</span><span class="si">}</span><span class="s2">`.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TrackTests.is_range_functions_robust">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.is_range_functions_robust">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_range_functions_robust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect overlapping release ranges among sibling Ensembl IDs.</span>

<span class="sd">        A *base* Ensembl-gene ID is the stable identifier that groups multiple</span>
<span class="sd">        versioned Ensembl-gene records (siblings).  The gene-history model</span>
<span class="sd">        requires that the release ranges of sibling IDs **never overlap** -</span>
<span class="sd">        each release must be covered by *exactly one* child stable ID.</span>

<span class="sd">        This method traverses every base-gene node and checks that condition.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: If ``True`` (default) display a tqdm progress-bar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: ``True`` when no overlaps are found; ``False`` otherwise.</span>
<span class="sd">            Each offending base ID triggers a warning with the conflicting</span>
<span class="sd">            ranges.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;node_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">DB</span><span class="o">.</span><span class="n">nts_base_ensembl</span><span class="p">[</span><span class="n">DB</span><span class="o">.</span><span class="n">backbone_form</span><span class="p">]:</span>
                <span class="n">base_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">switch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">base_ids</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="k">as</span> <span class="n">loop_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loop_obj</span><span class="p">:</span>
                <span class="n">loop_obj</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Item:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">id_family</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">id_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_active_ranges_of_id</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">id_family</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">id_ranges</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">r12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_intersecting_ranges</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r12</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For Base Ensembl ID </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: Two associated Ensembl IDs cover the same area&quot;</span><span class="p">)</span>
                        <span class="n">switch</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">switch</span></div>


<div class="viewcode-block" id="TrackTests.is_base_is_range_correct">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.is_base_is_range_correct">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_base_is_range_correct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify consistency of *base-gene* active-range calculations.</span>

<span class="sd">        Each &quot;base Ensembl gene&quot; node (``node_type == &#39;base_ensembl_gene&#39;``)</span>
<span class="sd">        has an *active release range*—the list of Ensembl releases during</span>
<span class="sd">        which descendants of the gene were present.  There are two</span>
<span class="sd">        independent ways to obtain this information:</span>

<span class="sd">        1. **High-level helper**</span>
<span class="sd">           ``graph.get_active_ranges_of_base_id_alternative`` - a cached</span>
<span class="sd">           convenience wrapper.</span>
<span class="sd">        2. **Low-level reconstruction** by aggregating the *combined_edges*</span>
<span class="sd">           table and converting the set of releases into compact</span>
<span class="sd">           ``[start, end]`` slices via ``graph.list_to_ranges``.</span>

<span class="sd">        This test iterates through **all** base-gene nodes and asserts that</span>
<span class="sd">        the two methods deliver byte-identical results.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose (bool): If *True* (default) show a tqdm progress</span>
<span class="sd">                bar that updates with the current node under inspection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: ``True`` if *every* base-gene has matching ranges; ``False``</span>
<span class="sd">            as soon as a single mismatch is encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># Gather all base-gene identifiers up-front to avoid repeated lookups.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;node_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;base_ensembl_gene&quot;</span><span class="p">:</span>
                <span class="n">base_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">switch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">base_ids</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="k">as</span> <span class="n">loop_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="n">loop_obj</span><span class="p">:</span>
                <span class="n">loop_obj</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Item:</span><span class="si">{</span><span class="n">bi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># 1. High-level cached helper. get_base_id_range form function</span>
                <span class="n">bi_fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_active_ranges_of_base_id_alternative</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span>
                <span class="c1"># 2. Low-level reconstruction from edge metadata. get range directly from graph</span>
                <span class="n">rd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">combined_edges</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span>
                <span class="n">bi_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">list_to_ranges</span><span class="p">(</span><span class="nb">sorted</span><span class="p">({</span><span class="n">s</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rd</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rd</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">rd</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">r</span><span class="p">]}))</span>
                <span class="c1"># Replace &quot;inf&quot; sentinel with highest known release.  The</span>
                <span class="c1"># helper already performs this normalisation so we mimic it</span>
                <span class="c1"># here for a fair comparison.</span>
                <span class="n">bi_fun</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;confident_for_release&quot;</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">bi_fun</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="n">bi_dir</span> <span class="o">!=</span> <span class="n">bi_fun</span><span class="p">:</span>
                    <span class="n">switch</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">switch</span></div>


<div class="viewcode-block" id="TrackTests.is_combined_edges_dicts_overlapping_and_complete">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.is_combined_edges_dicts_overlapping_and_complete">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_combined_edges_dicts_overlapping_and_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check edge-dictionary partitioning invariants.</span>

<span class="sd">        The Track graph materialises three *edge caches*—``combined_edges``</span>
<span class="sd">        and its two specialised siblings—each storing adjacency and release</span>
<span class="sd">        metadata for a different subset of nodes:</span>

<span class="sd">        * ``combined_edges`` - all nodes, including backbone genes.</span>
<span class="sd">        * ``combined_edges_genes`` - stable Ensembl genes (non-assembly-specific).</span>
<span class="sd">        * ``combined_edges_assembly_specific_genes`` - genes that exist only</span>
<span class="sd">          on a single assembly.</span>

<span class="sd">        The design contract says:</span>

<span class="sd">        1. **Disjointness** - No node key may appear in more than one</span>
<span class="sd">           dictionary.</span>
<span class="sd">        2. **Completeness** - The *union* of the dictionaries must cover all</span>
<span class="sd">           graph nodes **except** those that represent *alternative database</span>
<span class="sd">           versions* (e.g. &quot;EnsemblMetazoa&quot;) which are intentionally kept</span>
<span class="sd">           separate.</span>

<span class="sd">        This routine enforces both rules.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: ``True`` if the dictionaries are pair-wise disjoint **and**</span>
<span class="sd">            collectively cover every eligible node; ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">the_dicts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">combined_edges</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">combined_edges_genes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">combined_edges_assembly_specific_genes</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># 1. Disjointness - if any intersection is non-empty the invariant is violated.</span>
        <span class="k">for</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">iterable</span><span class="o">=</span><span class="n">the_dicts</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">d2</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># There are some overlapping identifiers.</span>

        <span class="c1"># 2. Completeness - every node (minus alternative DB versions) must be represented in exactly one cache.</span>
        <span class="n">covered_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">the_dicts</span><span class="p">))</span>
        <span class="n">uncovered_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span> <span class="o">-</span> <span class="n">covered_nodes</span>
        <span class="k">for</span> <span class="n">un</span> <span class="ow">in</span> <span class="n">uncovered_nodes</span><span class="p">:</span>
            <span class="n">node_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">un</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;Version&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_data</span> <span class="ow">or</span> <span class="n">node_data</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">alternative_versions</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># There are identifiers that is not covered with these dicts.</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TrackTests.is_edge_with_same_nts_only_at_backbone_nodes">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.is_edge_with_same_nts_only_at_backbone_nodes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_edge_with_same_nts_only_at_backbone_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assert *same-node-type* edges exist **only** between backbone genes.</span>

<span class="sd">        The graph is a *multilayer* network where nodes of different</span>

<span class="sd">        This method traverses every base-gene node and checks that condition.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: ``True`` when no overlaps are found; ``False`` otherwise.</span>
<span class="sd">            Each offending base ID triggers a warning with the conflicting</span>
<span class="sd">            ranges.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">n1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">nts1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n1</span><span class="p">][</span><span class="n">DB</span><span class="o">.</span><span class="n">node_type_str</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">n2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">n1</span><span class="p">):</span>
                <span class="n">nts2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n2</span><span class="p">][</span><span class="n">DB</span><span class="o">.</span><span class="n">node_type_str</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">nts1</span> <span class="o">==</span> <span class="n">nts2</span> <span class="ow">and</span> <span class="n">nts1</span> <span class="o">!=</span> <span class="n">DB</span><span class="o">.</span><span class="n">external_search_settings</span><span class="p">[</span><span class="s2">&quot;nts_backbone&quot;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TrackTests.is_id_functions_consistent_external">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.is_id_functions_consistent_external">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_id_functions_consistent_external</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check external-ID list helpers against the raw MySQL tables.</span>

<span class="sd">        For **every** combination of *assembly*, *Ensembl release* (limited to</span>
<span class="sd">        :py:attr:`graph.graph[&quot;confident_for_release&quot;]`) and *external</span>
<span class="sd">        database* this test performs the following steps:</span>

<span class="sd">        1. Query the authoritative list of external IDs directly from the</span>
<span class="sd">           MySQL snapshot via :py:class:`~idtrack.database_manager.DatabaseManager`.</span>
<span class="sd">        2. Ask the in-memory graph for the same list via</span>
<span class="sd">           :py:meth:`idtrack.Track.get_id_list`.</span>
<span class="sd">        3. Normalise node names through</span>
<span class="sd">           :py:meth:`idtrack.Track.node_name_alternatives` to cope with the</span>
<span class="sd">           occasional “_1” suffix.</span>
<span class="sd">        4. Compare the two sets.  A mismatch is logged and the method returns</span>
<span class="sd">           ``False`` immediately.</span>

<span class="sd">        The exhaustive traversal is expensive (minutes for large genomes) but</span>
<span class="sd">        ensures the graph`s indexing helpers never drift from the actual</span>
<span class="sd">        database content.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: If *True* (default) display a tqdm progress bar and emit</span>
<span class="sd">                log messages at INFO level.  When *False* the method runs</span>
<span class="sd">                silently.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: *True* when every single comparison matched, *False* as soon</span>
<span class="sd">            as an inconsistency is encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">narrow_external</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;narrow_external&quot;</span><span class="p">]</span>
        <span class="n">misplace_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;misplaced_external_entry&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">assembly</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">available_genome_assemblies</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;confident_for_release&quot;</span><span class="p">],</span>
                <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Assembly </span><span class="si">{</span><span class="n">assembly</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">,</span>
                <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">loop_obj</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">release</span> <span class="ow">in</span> <span class="n">loop_obj</span><span class="p">:</span>
                    <span class="n">loop_obj</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Item:</span><span class="si">{</span><span class="n">release</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">check_if_change_assembly_works</span><span class="p">(</span>
                        <span class="n">db_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">change_release</span><span class="p">(</span><span class="n">release</span><span class="p">),</span> <span class="n">target_assembly</span><span class="o">=</span><span class="n">assembly</span>
                    <span class="p">):</span>
                        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">change_release</span><span class="p">(</span><span class="n">release</span><span class="p">)</span><span class="o">.</span><span class="n">change_assembly</span><span class="p">(</span><span class="n">assembly</span><span class="p">)</span>
                        <span class="n">ex_rel_d</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">f</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">change_form</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;external_relevant&quot;</span> <span class="k">if</span> <span class="n">narrow_external</span> <span class="k">else</span> <span class="s2">&quot;external&quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">available_forms</span>
                        <span class="p">}</span>

                        <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">available_external_databases_assembly</span><span class="p">[</span><span class="n">assembly</span><span class="p">]:</span>
                            <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">external_database_connection_form</span><span class="p">[</span><span class="n">database</span><span class="p">]</span>
                            <span class="n">ex_rel</span> <span class="o">=</span> <span class="n">ex_rel_d</span><span class="p">[</span><span class="n">form</span><span class="p">]</span>

                            <span class="n">from_dm_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ex_rel</span><span class="p">[</span><span class="s2">&quot;id_db&quot;</span><span class="p">][</span><span class="n">ex_rel</span><span class="p">[</span><span class="s2">&quot;name_db&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">database</span><span class="p">])</span>
                            <span class="n">from_dm</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">from_dm_</span><span class="p">:</span>
                                <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node_name_alternatives</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>
                                <span class="n">from_dm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l1</span> <span class="k">if</span> <span class="n">l2</span> <span class="k">else</span> <span class="n">nd</span><span class="p">)</span>
                            <span class="n">from_gr</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_id_list</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">assembly</span><span class="p">,</span> <span class="n">release</span><span class="p">))</span>

                            <span class="k">if</span> <span class="n">from_gr</span> <span class="o">!=</span> <span class="n">from_dm</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="ow">in</span> <span class="n">misplace_entries</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">from_dm</span> <span class="o">-</span> <span class="n">from_gr</span><span class="p">)]):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Inconsistent results for ID list functions (external) &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;for: database, assembl, ensembl release: </span><span class="si">{</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="w"> </span><span class="n">assembly</span><span class="p">,</span><span class="w"> </span><span class="n">release</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TrackTests.how_many_corresponding_path_ensembl">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.how_many_corresponding_path_ensembl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">how_many_corresponding_path_ensembl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">from_release</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">from_assembly</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">to_release</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">go_external</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count history paths between two Ensembl releases.</span>

<span class="sd">        The method iterates over **all** Ensembl-gene stable IDs that exist in</span>
<span class="sd">        *from_release*/*from_assembly*.  For every ID that is present in the</span>
<span class="sd">        graph it calls :py:meth:`idtrack.Track.get_possible_paths` and records</span>
<span class="sd">        how many distinct paths the searcher finds to *to_release*.</span>

<span class="sd">        The routine is **non-destructive**; it merely provides a quick way to</span>
<span class="sd">        gauge the `density` of the history graph or to spot releases where</span>
<span class="sd">        path-finding was unexpectedly difficult.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_release: Source Ensembl release number.</span>
<span class="sd">            from_assembly: Source genome assembly code.</span>
<span class="sd">            to_release: Target Ensembl release number.</span>
<span class="sd">            go_external: If *True* history paths are allowed to temporarily</span>
<span class="sd">                leave the Ensembl lineage via external databases.</span>
<span class="sd">            verbose: Show a tqdm progress bar (default *True*).</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[list[Union[str, int, None]]]: A list of two-element sub-lists</span>
<span class="sd">            ``[stable_id, n_paths]`` where ``n_paths`` is</span>

<span class="sd">                *   an *int* ≥ 0 when the ID was in the graph, or</span>
<span class="sd">                *   *None* when the source ID was absent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">change_release</span><span class="p">(</span><span class="n">from_release</span><span class="p">)</span><span class="o">.</span><span class="n">change_assembly</span><span class="p">(</span><span class="n">from_assembly</span><span class="p">)</span>
        <span class="n">ids_from</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">db_from</span><span class="o">.</span><span class="n">id_ver_from_df</span><span class="p">(</span><span class="n">db_from</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;ids&quot;</span><span class="p">,</span> <span class="n">save_after_calculation</span><span class="o">=</span><span class="kc">False</span><span class="p">))))</span>
        <span class="n">to_reverse</span> <span class="o">=</span> <span class="n">from_release</span> <span class="o">&gt;</span> <span class="n">to_release</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">ids_from</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="k">as</span> <span class="n">loop_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">from_id</span> <span class="ow">in</span> <span class="n">loop_obj</span><span class="p">:</span>
                <span class="n">loop_obj</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Item:</span><span class="si">{</span><span class="n">from_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">from_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                    <span class="n">lfr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_possible_paths</span><span class="p">(</span>
                            <span class="n">from_id</span><span class="p">,</span> <span class="n">from_release</span><span class="p">,</span> <span class="n">to_release</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">to_reverse</span><span class="p">,</span> <span class="n">go_external</span><span class="o">=</span><span class="n">go_external</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lfr</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">from_id</span><span class="p">,</span> <span class="n">lfr</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="TrackTests.history_travel_testing">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.history_travel_testing">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">history_travel_testing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">from_release</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">from_assembly</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">from_database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">to_release</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">to_database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">go_external</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">prioritize_to_one_filter</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">convert_using_release</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">from_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose_detailed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">return_ensembl_alternative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run an end-to-end Ensembl-history conversion and collect granular QA metrics.</span>

<span class="sd">        The routine samples identifiers from *from_database*/*from_release*</span>
<span class="sd">        (optionally down-sampling via *from_fraction*) and converts each one to</span>
<span class="sd">        *to_database*/*to_release* using :py:meth:`idtrack.Track.convert`.  It</span>
<span class="sd">        is intentionally **non-fatal**: every failure mode is caught, logged</span>
<span class="sd">        and tallied so that large regression suites can run unattended.  All</span>
<span class="sd">        results are returned in a single nested *metrics* dictionary whose</span>
<span class="sd">        structure mirrors the printable report produced by</span>
<span class="sd">        :py:meth:`format_history_travel_testing_report`.</span>

<span class="sd">        The statistics fall into **four conceptual groups**; each counter not only records an absolute event</span>
<span class="sd">        count but also serves as a red-flag indicator for specific classes of mapping pathology.  Use the</span>
<span class="sd">        guidelines below to interpret the numbers and decide whether a run is *healthy*, *questionable*, or</span>
<span class="sd">        *action-required*.</span>

<span class="sd">        * **Failure / anomaly counters**</span>

<span class="sd">          * ``history_voyage_failed_gracefully`` - the converter raised :py:data:`EmptyConversionMetricsError`.</span>
<span class="sd">          * ``history_voyage_failed_unknown`` - any *other* unexpected exception.</span>
<span class="sd">          * ``query_not_in_the_graph`` - source ID absent from the graph.</span>
<span class="sd">          * ``lost_item`` - traversal finished but produced **no** final IDs.</span>
<span class="sd">          * ``lost_item_but_the_same_id_exists`` - special case of *lost_item*</span>
<span class="sd">            when the target and source DB are both Ensembl-gene and the target</span>
<span class="sd">            ID still exists in the graph.</span>
<span class="sd">          * ``found_ids_not_accurate`` - at least one returned target ID is not</span>
<span class="sd">            part of the authoritative *ids_to* reference set.</span>

<span class="sd">        * **Mapping quality**</span>

<span class="sd">          * ``one_to_one_ids`` - queries that resolved to *exactly* one target ID.</span>
<span class="sd">          * ``one_to_multiple_ids`` - queries with &gt; 1 admissible targets.</span>
<span class="sd">          * ``one_to_multiple_final_conversion`` - subset of the above where</span>
<span class="sd">            *exactly one* traversal path was found (heuristics eliminated alternatives).</span>

<span class="sd">        * **Collision analysis**</span>

<span class="sd">          The list ``clashing_id_type == [clash_one_one, clash_multi_multi,</span>
<span class="sd">          clash_multi_one]`` classifies *target IDs* that were reached by</span>
<span class="sd">          more than one query:</span>

<span class="sd">          * ``clash_one_one`` - every colliding query was 1→1.</span>
<span class="sd">          * ``clash_multi_multi`` - every colliding query was 1→many.</span>
<span class="sd">          * ``clash_multi_one`` - mixture of 1→1 and 1→many queries (most</span>
<span class="sd">            alarming category).</span>

<span class="sd">        * **Timings &amp; book-keeping**</span>

<span class="sd">          * ``time`` - wall-clock runtime in seconds.</span>
<span class="sd">          * ``conversion`` - per-query mapping result for *all* successful traversals.</span>
<span class="sd">          * ``converted_item_dict`` / ``converted_item_dict_reversed`` - raw</span>
<span class="sd">            per-ID caches used to derive the higher-level counters above.</span>
<span class="sd">          * ``parameters`` - echo of the function arguments.</span>
<span class="sd">          * ``ids`` - the sampled *from* and reference *to* ID sets.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_release (int): Ensembl release number of the *source* IDs.</span>
<span class="sd">            from_assembly (int): Genome assembly code of the source IDs.</span>
<span class="sd">            from_database (str): Node-type / database of the source IDs.</span>
<span class="sd">            to_release (int): Ensembl release number of the *target* IDs.</span>
<span class="sd">            to_database (str): Node-type / database to convert **into**.</span>
<span class="sd">            go_external (bool): Permit temporary detours through external IDs when native Ensembl history edges break.</span>
<span class="sd">            prioritize_to_one_filter (bool): Prefer 1→1 mappings over 1→many when multiple paths exist.</span>
<span class="sd">            convert_using_release (bool): Pass *from_release* straight into</span>
<span class="sd">                :py:meth:`idtrack.Track.convert` instead of letting it infer the starting point.</span>
<span class="sd">            from_fraction (float): Fraction (0 &lt; x ≤ 1) of the</span>
<span class="sd">                *ids_from* population to sample; speeds up smoke tests.</span>
<span class="sd">            verbose (bool): Show tqdm progress bar (coarse).</span>
<span class="sd">            verbose_detailed (bool): Embed live metric counters in the tqdm postfix.</span>
<span class="sd">            return_ensembl_alternative (bool): Forwarded to :py:meth:`idtrack.Track.convert`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If either database argument refers to an Ensembl</span>
<span class="sd">                node-type (must use backbone helpers instead) or if</span>
<span class="sd">                *from_fraction* is outside the open interval (0, 1].</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Nested *metrics* dictionary with the layout described above.</span>
<span class="sd">                Use :py:meth:`format_history_travel_testing_report` for a</span>
<span class="sd">                human-readable summary.</span>

<span class="sd">        Notes:</span>
<span class="sd">            * All counters are **absolute counts** - divide by</span>
<span class="sd">              ``len(metrics[&#39;ids&#39;][&#39;from&#39;])`` to obtain rates.</span>
<span class="sd">            * The collision analysis is inspired by the *clash statistics*</span>
<span class="sd">              logic implemented at the end of the function and helps spot</span>
<span class="sd">              discrepant “unique” IDs that suddenly become ambiguous. Keeping</span>
<span class="sd">              all three clash counters at zero is the gold standard for a</span>
<span class="sd">              healthy build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">from_database</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">nts_ensembl</span> <span class="ow">or</span> <span class="n">to_database</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">nts_ensembl</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="n">ids_from</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_id_list</span><span class="p">(</span><span class="n">from_database</span><span class="p">,</span> <span class="n">from_assembly</span><span class="p">,</span> <span class="n">from_release</span><span class="p">))</span>
        <span class="n">ids_to</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_id_list</span><span class="p">(</span><span class="n">to_database</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;genome_assembly&quot;</span><span class="p">],</span> <span class="n">to_release</span><span class="p">))</span>
        <span class="n">ids_to_s</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids_to</span><span class="p">}</span> <span class="k">if</span> <span class="n">to_database</span> <span class="ow">in</span> <span class="n">DB</span><span class="o">.</span><span class="n">nts_assembly_reverse</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Input sampling</span>
        <span class="k">if</span> <span class="n">from_fraction</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">from_fraction</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">from_faction_count</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids_from</span><span class="p">)</span> <span class="o">*</span> <span class="n">from_fraction</span><span class="p">)</span>
            <span class="n">ids_from</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">ids_from</span><span class="p">,</span> <span class="n">from_faction_count</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># Metric scaffold</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;from_release&quot;</span><span class="p">:</span> <span class="n">from_release</span><span class="p">,</span>
            <span class="s2">&quot;from_assembly&quot;</span><span class="p">:</span> <span class="n">from_assembly</span><span class="p">,</span>
            <span class="s2">&quot;from_database&quot;</span><span class="p">:</span> <span class="n">from_database</span><span class="p">,</span>
            <span class="s2">&quot;to_release&quot;</span><span class="p">:</span> <span class="n">to_release</span><span class="p">,</span>
            <span class="s2">&quot;to_database&quot;</span><span class="p">:</span> <span class="n">to_database</span><span class="p">,</span>
            <span class="s2">&quot;go_external&quot;</span><span class="p">:</span> <span class="n">go_external</span><span class="p">,</span>
            <span class="s2">&quot;from_fraction&quot;</span><span class="p">:</span> <span class="n">from_fraction</span><span class="p">,</span>
            <span class="s2">&quot;prioritize_to_one_filter&quot;</span><span class="p">:</span> <span class="n">prioritize_to_one_filter</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
            <span class="s2">&quot;ids&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">ids_from</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">ids_to</span><span class="p">},</span>
            <span class="s2">&quot;lost_item&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;one_to_one_ids&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;query_not_in_the_graph&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;history_voyage_failed_gracefully&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;history_voyage_failed_unknown&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;lost_item_but_the_same_id_exists&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;found_ids_not_accurate&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;conversion&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;one_to_multiple_ids&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;one_to_multiple_final_conversion&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;converted_item_dict&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;converted_item_dict_reversed&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>

        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">ids_from</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Mapping&quot;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="k">as</span> <span class="n">loop_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">the_id</span> <span class="ow">in</span> <span class="n">loop_obj</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose_detailed</span><span class="p">:</span>
                    <span class="n">loop_obj</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Item:</span><span class="si">{</span><span class="n">the_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Item:</span><span class="si">{</span><span class="n">the_id</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;one_to_one_ids&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">,&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;one_to_multiple_ids&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">,&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;lost_item&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">,&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;found_ids_not_accurate&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">,&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;query_not_in_the_graph&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;history_voyage_failed_unknown&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">loop_obj</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Conversion attempt</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">convert_using_release</span><span class="p">:</span>
                        <span class="n">converted_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
                            <span class="n">from_id</span><span class="o">=</span><span class="n">the_id</span><span class="p">,</span>
                            <span class="n">from_release</span><span class="o">=</span><span class="n">from_release</span><span class="p">,</span>
                            <span class="n">to_release</span><span class="o">=</span><span class="n">to_release</span><span class="p">,</span>
                            <span class="n">final_database</span><span class="o">=</span><span class="n">to_database</span><span class="p">,</span>
                            <span class="n">go_external</span><span class="o">=</span><span class="n">go_external</span><span class="p">,</span>
                            <span class="n">prioritize_to_one_filter</span><span class="o">=</span><span class="n">prioritize_to_one_filter</span><span class="p">,</span>
                            <span class="n">return_ensembl_alternative</span><span class="o">=</span><span class="n">return_ensembl_alternative</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">converted_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
                            <span class="n">from_id</span><span class="o">=</span><span class="n">the_id</span><span class="p">,</span>
                            <span class="n">from_release</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">to_release</span><span class="o">=</span><span class="n">to_release</span><span class="p">,</span>
                            <span class="n">final_database</span><span class="o">=</span><span class="n">to_database</span><span class="p">,</span>
                            <span class="n">go_external</span><span class="o">=</span><span class="n">go_external</span><span class="p">,</span>
                            <span class="n">prioritize_to_one_filter</span><span class="o">=</span><span class="n">prioritize_to_one_filter</span><span class="p">,</span>
                            <span class="n">return_ensembl_alternative</span><span class="o">=</span><span class="n">return_ensembl_alternative</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;converted_item_dict&quot;</span><span class="p">][</span><span class="n">the_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">converted_item</span>

                <span class="k">except</span> <span class="n">nx</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">NetworkXError</span><span class="p">:</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;query_not_in_the_graph&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">the_id</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="n">EmptyConversionMetricsError</span><span class="p">:</span>
                    <span class="n">full_tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;history_voyage_failed_gracefully&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">the_id</span><span class="p">,</span> <span class="n">full_tb</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">full_tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;history_voyage_failed_unknown&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">the_id</span><span class="p">,</span> <span class="n">full_tb</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="c1"># Metrics aggregation</span>
                <span class="k">if</span> <span class="n">converted_item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">to_database</span> <span class="o">==</span> <span class="n">from_database</span> <span class="o">==</span> <span class="s2">&quot;ensembl_gene&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">the_id</span><span class="p">][</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ids_to_s</span><span class="p">:</span>
                        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;lost_item_but_the_same_id_exists&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">the_id</span><span class="p">)</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;lost_item&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">the_id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">covr</span> <span class="o">=</span> <span class="p">{</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">converted_item</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">converted_item</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;final_conversion&quot;</span><span class="p">][</span><span class="s2">&quot;final_elements&quot;</span><span class="p">]}</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;conversion&quot;</span><span class="p">][</span><span class="n">the_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">covr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">covr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;one_to_one_ids&quot;</span><span class="p">][</span><span class="n">the_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">covr</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">covr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;one_to_multiple_ids&quot;</span><span class="p">][</span><span class="n">the_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">covr</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">converted_item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;one_to_multiple_final_conversion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">the_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span>

                    <span class="c1"># How much of the converted IDs show the same ID</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">covr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;converted_item_dict_reversed&quot;</span><span class="p">]:</span>
                            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;converted_item_dict_reversed&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">the_id</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;converted_item_dict_reversed&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">the_id</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">covr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids_to</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">the_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;found_ids_not_accurate&quot;</span><span class="p">]:</span>
                                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;found_ids_not_accurate&quot;</span><span class="p">][</span><span class="n">the_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;found_ids_not_accurate&quot;</span><span class="p">][</span><span class="n">the_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c1"># ── Clash statistics:</span>
        <span class="c1"># Each counter tracks how many *target* IDs were reached by more than</span>
        <span class="c1"># one *source* ID, broken down by the **type of mapping** that led to</span>
        <span class="c1"># the collision:</span>
        <span class="n">clash_multi_multi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># all colliding sources were 1→many mappings</span>
        <span class="n">clash_multi_one</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># mix of 1→many and 1→1 sources</span>
        <span class="n">clash_one_one</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># all colliding sources were clean 1→1</span>

        <span class="c1"># `converted_item_dict_reversed` maps every target ID to the list of</span>
        <span class="c1"># source IDs that converted to it (built earlier inside the big mapping</span>
        <span class="c1"># loop).  We inspect only those targets hit by ≥ 2 sources - a “clash”.</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cidr_val</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;converted_item_dict_reversed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># Skip non-clashing targets (exactly one source mapped here).</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cidr_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Does *any* of the sources belong to the 1→many bucket?</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">cv</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;one_to_multiple_ids&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">cidr_val</span><span class="p">])</span>
                <span class="c1"># Does *any* of the sources belong to the 1→1 bucket?</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">cv</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;one_to_one_ids&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">cidr_val</span><span class="p">])</span>
                <span class="c1"># Categorise clash by the mixture of mapping types.</span>
                <span class="k">if</span> <span class="n">s1</span> <span class="ow">and</span> <span class="n">s2</span><span class="p">:</span>  <span class="c1"># at least one 1→many **and** one 1→1</span>
                    <span class="n">clash_multi_one</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">s1</span><span class="p">:</span>  <span class="c1"># only 1→many sources present</span>
                    <span class="n">clash_multi_multi</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">s2</span><span class="p">:</span>  <span class="c1"># only 1→1 sources present</span>
                    <span class="n">clash_one_one</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;clashing_id_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">clash_one_one</span><span class="p">,</span> <span class="n">clash_multi_multi</span><span class="p">,</span> <span class="n">clash_multi_one</span><span class="p">]</span>

        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span>
        <span class="k">return</span> <span class="n">metrics</span></div>


<div class="viewcode-block" id="TrackTests.history_travel_testing_random_arguments_generator">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.history_travel_testing_random_arguments_generator">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">history_travel_testing_random_arguments_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict_forward</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">include_exclude_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a plausible random parameter set for :py:meth:`history_travel_testing`.</span>

<span class="sd">        The helper picks **compatible** source/target assemblies, releases and</span>
<span class="sd">        databases so the subsequent conversion test has a realistic chance to</span>
<span class="sd">        succeed.  When *strict_forward* is *True* the target release is</span>
<span class="sd">        guaranteed to be **≥** the source release (no time-travel back).</span>

<span class="sd">        Args:</span>
<span class="sd">            strict_forward: Enforce a non-decreasing release direction.</span>
<span class="sd">            include_exclude_list: Todo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Keys ``from_assembly``, ``from_release``, ``to_release``,</span>
<span class="sd">            ``from_database``, ``to_database`` ready to be splatted into</span>
<span class="sd">            :py:meth:`history_travel_testing`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">include_ensembl_1</span><span class="p">,</span> <span class="n">include_external_1</span><span class="p">,</span> <span class="n">include_ensembl_2</span><span class="p">,</span> <span class="n">include_external_2</span> <span class="o">=</span> <span class="n">include_exclude_list</span>
        <span class="n">only_backbone_tests_1</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">include_ensembl_1</span><span class="p">,</span> <span class="n">include_external_1</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">only_backbone_tests_2</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">include_ensembl_2</span><span class="p">,</span> <span class="n">include_external_2</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="n">from_assembly</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">assembly_mysqlport_priority</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">only_backbone_tests_1</span>
            <span class="k">else</span> <span class="n">DB</span><span class="o">.</span><span class="n">main_assembly</span>
        <span class="p">)</span>
        <span class="c1"># as the final release should be always the main assembly</span>
        <span class="n">to_assembly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;genome_assembly&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">only_backbone_tests_2</span> <span class="k">else</span> <span class="n">DB</span><span class="o">.</span><span class="n">main_assembly</span>
        <span class="n">the_key1</span><span class="p">,</span> <span class="n">the_key2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">the_key1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">the_key2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">the_key1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_dataset_source_generator</span><span class="p">(</span>
                <span class="n">from_assembly</span><span class="p">,</span>
                <span class="n">include_ensembl</span><span class="o">=</span><span class="n">include_ensembl_1</span><span class="p">,</span>
                <span class="n">include_external</span><span class="o">=</span><span class="n">include_external_1</span><span class="p">,</span>
                <span class="n">only_backbone_tests</span><span class="o">=</span><span class="n">only_backbone_tests_1</span><span class="p">,</span>
                <span class="n">for_final_database</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">the_key1</span> <span class="o">!=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">the_key2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_dataset_source_generator</span><span class="p">(</span>
                    <span class="n">to_assembly</span><span class="p">,</span>
                    <span class="n">include_ensembl</span><span class="o">=</span><span class="n">include_ensembl_2</span><span class="p">,</span>
                    <span class="n">include_external</span><span class="o">=</span><span class="n">include_external_2</span><span class="p">,</span>
                    <span class="n">for_final_database</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">only_backbone_tests</span><span class="o">=</span><span class="n">only_backbone_tests_2</span><span class="p">,</span>
                    <span class="n">release_lower_limit</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">strict_forward</span> <span class="k">else</span> <span class="n">the_key1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">the_key1</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">the_key2</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Recalculating parameters.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;from_assembly&quot;</span><span class="p">:</span> <span class="n">from_assembly</span><span class="p">,</span>
            <span class="s2">&quot;from_release&quot;</span><span class="p">:</span> <span class="n">the_key1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;to_release&quot;</span><span class="p">:</span> <span class="n">the_key2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;from_database&quot;</span><span class="p">:</span> <span class="n">the_key1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;to_database&quot;</span><span class="p">:</span> <span class="n">the_key2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="TrackTests.history_travel_testing_random">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.history_travel_testing_random">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">history_travel_testing_random</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">from_fraction</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">include_ensembl_source</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">include_external_source</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">include_ensembl_destination</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">include_external_destination</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose_detailed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">strict_forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">convert_using_release</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">prioritize_to_one_filter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">return_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convenience wrapper around :py:meth:`history_travel_testing`.</span>

<span class="sd">        The routine generates a *random* but internally consistent test case</span>
<span class="sd">        via :py:meth:`history_travel_testing_random_arguments_generator`, logs</span>
<span class="sd">        the chosen parameters (unless *verbose* is *False*) and delegates the</span>
<span class="sd">        heavy lifting to :py:meth:`history_travel_testing`.</span>

<span class="sd">        Args:</span>
<span class="sd">            from_fraction: Fraction of IDs to sample from the source set.</span>
<span class="sd">            strict_forward: Forwarded to the argument generator.</span>
<span class="sd">            convert_using_release: Forwarded to</span>
<span class="sd">                :py:meth:`history_travel_testing`.</span>
<span class="sd">            prioritize_to_one_filter: Forwarded to</span>
<span class="sd">                :py:meth:`history_travel_testing`.</span>
<span class="sd">            verbose: Show coarse progress information.</span>
<span class="sd">            verbose_detailed: Include extended per-ID counters in the progress bar.</span>
<span class="sd">            return_result: Todo.</span>
<span class="sd">            include_ensembl_source: Todo.</span>
<span class="sd">            include_external_source: Todo.</span>
<span class="sd">            include_ensembl_destination: Todo.</span>
<span class="sd">            include_external_destination: Todo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The *metrics* dictionary returned by</span>
<span class="sd">            :py:meth:`history_travel_testing`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">include_exclude_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">include_ensembl_source</span><span class="p">,</span>
            <span class="n">include_external_source</span><span class="p">,</span>
            <span class="n">include_ensembl_destination</span><span class="p">,</span>
            <span class="n">include_external_destination</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_travel_testing_random_arguments_generator</span><span class="p">(</span>
            <span class="n">strict_forward</span><span class="o">=</span><span class="n">strict_forward</span><span class="p">,</span> <span class="n">include_exclude_list</span><span class="o">=</span><span class="n">include_exclude_list</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">printable1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_history_travel_testing_report_header</span><span class="p">(</span><span class="n">parameters</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">printable1</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_travel_testing</span><span class="p">(</span>
            <span class="o">**</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">go_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">prioritize_to_one_filter</span><span class="o">=</span><span class="n">prioritize_to_one_filter</span><span class="p">,</span>
            <span class="n">convert_using_release</span><span class="o">=</span><span class="n">convert_using_release</span><span class="p">,</span>
            <span class="n">from_fraction</span><span class="o">=</span><span class="n">from_fraction</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">verbose_detailed</span><span class="o">=</span><span class="n">verbose_detailed</span><span class="p">,</span>
            <span class="n">return_ensembl_alternative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">printable2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">format_history_travel_testing_report</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">include_header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">printable2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="TrackTests.is_final_external_conversion_robust">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.is_final_external_conversion_robust">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_final_external_conversion_robust</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">convert_using_release</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ens_rel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">from_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">prioritize_to_one_filter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate Ensembl→external conversion against MySQL ground truth.</span>

<span class="sd">        A random external database is chosen for **every** genome assembly. For</span>
<span class="sd">        the selected combination the method grabs the authoritative mapping</span>
<span class="sd">        table (graph-ID → external ID set) from MySQL and converts the same</span>
<span class="sd">        graph-IDs with :py:meth:`idtrack.Track.convert`.</span>

<span class="sd">        Args:</span>
<span class="sd">            convert_using_release: Whether to pin the *from_release* when</span>
<span class="sd">                calling the converter.  Keeping this *True* usually speeds up</span>
<span class="sd">                the search and mimics user-facing behaviour.</span>
<span class="sd">            verbose: Print the current assembly/database/release being tested.</span>
<span class="sd">            prioritize_to_one_filter: Todo.</span>
<span class="sd">            ens_rel: Todo.</span>
<span class="sd">            from_fraction: Todo.</span>
<span class="sd">            database: Todo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: *True* if every converted set equals the MySQL reference,</span>
<span class="sd">                *False* upon the first deviation.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Todo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">issues_t1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">issues_t2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">issues_t3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">assembly</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">main_assembly</span>

        <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ens_rel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Random database and Ensembl release.&quot;</span><span class="p">)</span>
            <span class="n">database</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ens_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_dataset_source_generator</span><span class="p">(</span>
                <span class="n">include_ensembl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">include_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">only_backbone_tests</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">for_final_database</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">assembly</span><span class="o">=</span><span class="n">assembly</span><span class="p">,</span>
                <span class="n">form</span><span class="o">=</span><span class="n">DB</span><span class="o">.</span><span class="n">backbone_form</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">check_if_change_assembly_works</span><span class="p">(</span>
            <span class="n">db_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">change_release</span><span class="p">(</span><span class="n">ens_rel</span><span class="p">),</span> <span class="n">target_assembly</span><span class="o">=</span><span class="n">assembly</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">change_release</span><span class="p">(</span><span class="n">ens_rel</span><span class="p">)</span><span class="o">.</span><span class="n">change_assembly</span><span class="p">(</span><span class="n">assembly</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">get_db</span><span class="p">(</span><span class="s2">&quot;external_relevant&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name_db&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">database</span><span class="p">]</span>
        <span class="n">base_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;graph_id&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_dict</span><span class="p">:</span>
                <span class="n">base_dict</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;graph_id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">base_dict</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;graph_id&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;id_db&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assembly: </span><span class="si">{</span><span class="n">assembly</span><span class="si">}</span><span class="s2">, Database: </span><span class="si">{</span><span class="n">database</span><span class="si">}</span><span class="s2">, Release: </span><span class="si">{</span><span class="n">ens_rel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_travel_testing</span><span class="p">(</span>
            <span class="n">from_fraction</span><span class="o">=</span><span class="n">from_fraction</span><span class="p">,</span>
            <span class="n">from_release</span><span class="o">=</span><span class="n">ens_rel</span><span class="p">,</span>
            <span class="n">from_assembly</span><span class="o">=</span><span class="n">assembly</span><span class="p">,</span>
            <span class="n">from_database</span><span class="o">=</span><span class="n">DB</span><span class="o">.</span><span class="n">nts_assembly</span><span class="p">[</span><span class="n">assembly</span><span class="p">][</span><span class="n">DB</span><span class="o">.</span><span class="n">backbone_form</span><span class="p">],</span>
            <span class="n">to_release</span><span class="o">=</span><span class="n">ens_rel</span><span class="p">,</span>
            <span class="n">to_database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
            <span class="n">go_external</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">prioritize_to_one_filter</span><span class="o">=</span><span class="n">prioritize_to_one_filter</span><span class="p">,</span>
            <span class="n">convert_using_release</span><span class="o">=</span><span class="n">convert_using_release</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">verbose_detailed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">from_id</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ids&quot;</span><span class="p">][</span><span class="s2">&quot;from&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">from_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;conversion&quot;</span><span class="p">]:</span>
                <span class="n">issues_t3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">from_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">issue_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="n">database</span><span class="p">,</span>
                    <span class="s2">&quot;asym&quot;</span><span class="p">:</span> <span class="n">assembly</span><span class="p">,</span>
                    <span class="s2">&quot;ens_rel&quot;</span><span class="p">:</span> <span class="n">ens_rel</span><span class="p">,</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">from_id</span><span class="p">,</span>
                    <span class="s2">&quot;converted&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;conversion&quot;</span><span class="p">][</span><span class="n">from_id</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">from_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_dict</span><span class="p">:</span>
                    <span class="n">issues_t2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">issue_dict</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;conversion&quot;</span><span class="p">][</span><span class="n">from_id</span><span class="p">]}</span> <span class="o">!=</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">base_dict</span><span class="p">[</span><span class="n">from_id</span><span class="p">]}:</span>
                    <span class="n">issue_dict</span><span class="p">[</span><span class="s2">&quot;base_expectation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_dict</span><span class="p">[</span><span class="n">from_id</span><span class="p">]</span>
                    <span class="n">issues_t1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">issue_dict</span><span class="p">)</span>

        <span class="c1"># make sure issues_t3 is not found in base_dict_from_id</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">issues_t1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">issues_t2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="n">issues_t1</span><span class="p">,</span> <span class="n">issues_t2</span><span class="p">,</span> <span class="n">issues_t3</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="n">issues_t1</span><span class="p">,</span> <span class="n">issues_t2</span><span class="p">,</span> <span class="n">issues_t3</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span></div>


<div class="viewcode-block" id="TrackTests.random_dataset_source_generator">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.random_dataset_source_generator">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">random_dataset_source_generator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">assembly</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">include_external</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">include_ensembl</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">for_final_database</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">only_backbone_tests</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">release_lower_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">form</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pick a random (&lt;database&gt;, &lt;assembly&gt;, &lt;release&gt;) tuple.</span>

<span class="sd">        The function guarantees that the triple actually exists in the graph</span>
<span class="sd">        and - if *release_lower_limit* is provided - honours the minimum</span>
<span class="sd">        release constraint.</span>

<span class="sd">        Args:</span>
<span class="sd">            assembly: NCBI assembly code (integer).</span>
<span class="sd">            include_ensembl: Whether Ensembl backbone databases may be returned</span>
<span class="sd">                as *database*.</span>
<span class="sd">            release_lower_limit: Smallest permissible Ensembl release number</span>
<span class="sd">                for the returned triple.  *None* disables the filter.</span>
<span class="sd">            form: Restrict the draw to a particular connection *form*</span>
<span class="sd">                (protein/coding/gene).  *None* means no restriction.</span>
<span class="sd">            only_backbone_tests: Todo.</span>
<span class="sd">            include_external: Todo.</span>
<span class="sd">            for_final_database: Todo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple | None: ``(&lt;database&gt;, &lt;assembly&gt;, &lt;release&gt;)`` or *None* when</span>
<span class="sd">            no matching release exists.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Todo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_backbone_tests</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">include_external</span><span class="p">:</span>
                <span class="n">all_possible_sources</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">available_external_databases_assembly</span><span class="p">[</span><span class="n">assembly</span><span class="p">]))</span>
                <span class="n">all_possible_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_possible_sources</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;synonym_id&quot;</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_possible_sources</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">form</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_possible_sources</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_possible_sources</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">external_database_connection_form</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">form</span>
                <span class="p">]</span>

            <span class="k">if</span> <span class="n">include_ensembl</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">for_final_database</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">form</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">all_possible_sources</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">nts_assembly</span><span class="p">[</span><span class="n">assembly</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_possible_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">nts_assembly</span><span class="p">[</span><span class="n">assembly</span><span class="p">][</span><span class="n">form</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">include_ensembl</span> <span class="ow">and</span> <span class="p">(</span><span class="n">form</span> <span class="o">==</span> <span class="n">DB</span><span class="o">.</span><span class="n">backbone_form</span> <span class="ow">or</span> <span class="n">form</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">all_possible_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">nts_ensembl</span><span class="p">[</span><span class="n">DB</span><span class="o">.</span><span class="n">backbone_form</span><span class="p">])</span>
                <span class="n">all_possible_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">nts_base_ensembl</span><span class="p">[</span><span class="n">DB</span><span class="o">.</span><span class="n">backbone_form</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">all_possible_sources</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There is nothing as possible sources.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_possible_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">DB</span><span class="o">.</span><span class="n">nts_ensembl</span><span class="p">[</span><span class="n">DB</span><span class="o">.</span><span class="n">backbone_form</span><span class="p">]]</span>

        <span class="n">selected_database</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_possible_sources</span><span class="p">)</span>
        <span class="n">possible_releases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">available_releases_given_database_assembly</span><span class="p">[(</span><span class="n">selected_database</span><span class="p">,</span> <span class="n">assembly</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">release_lower_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">possible_releases</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">possible_releases</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">release_lower_limit</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_releases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">selected_release</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">possible_releases</span><span class="p">))</span>
            <span class="n">the_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">selected_database</span><span class="p">,</span> <span class="n">assembly</span><span class="p">,</span> <span class="n">selected_release</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">the_key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TrackTests.is_node_consistency_robust">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.is_node_consistency_robust">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_node_consistency_robust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for illegal neighbour relationships and multi-edges.</span>

<span class="sd">        The graph may contain **exactly one** edge between nodes of *different*</span>
<span class="sd">        node-types.  Nodes of the *same* node-type are only allowed when that</span>
<span class="sd">        type is the Ensembl backbone (``ensembl_gene``).  Any deviation - a</span>
<span class="sd">        lateral same-type connection or &gt;1 multi-edge - is logged and aborts</span>
<span class="sd">        the test.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: Print offending nodes when a violation is detected.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: *True* when the graph satisfies the topology rules, *False*</span>
<span class="sd">            otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="k">as</span> <span class="n">loop_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loop_obj</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">ni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">DB</span><span class="o">.</span><span class="n">node_type_str</span><span class="p">]</span>
                    <span class="n">nj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">DB</span><span class="o">.</span><span class="n">node_type_str</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">ni</span> <span class="o">==</span> <span class="n">nj</span> <span class="ow">and</span> <span class="n">ni</span> <span class="o">!=</span> <span class="n">DB</span><span class="o">.</span><span class="n">nts_ensembl</span><span class="p">[</span><span class="n">DB</span><span class="o">.</span><span class="n">backbone_form</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Neighbor nodes (not backbone) has similar node type: `</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">`, `</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

                    <span class="k">elif</span> <span class="n">ni</span> <span class="o">!=</span> <span class="n">nj</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple edges between `</span><span class="si">{</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">ni</span><span class="si">}</span><span class="s2">` and `</span><span class="si">{</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">nj</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TrackTests.format_history_travel_testing_report_header">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.format_history_travel_testing_report_header">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_history_travel_testing_report_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Todo.</span>

<span class="sd">        Args:</span>
<span class="sd">            p (dict[str, Any]): Todo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Todo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;╔═ History-Travel-Testing Report ═╗&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Source  : </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_database&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(Assembly </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_assembly&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, Release </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_release&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Target  : </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to_database&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="sa">f</span><span class="s2">&quot;(Release </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to_release&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">header</span></div>


<div class="viewcode-block" id="TrackTests.format_history_travel_testing_report">
<a class="viewcode-back" href="../../reference.html#idtrack._track_tests.TrackTests.format_history_travel_testing_report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_history_travel_testing_report</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">include_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">line_separation_at_end</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Todo.</span>

<span class="sd">        Args:</span>
<span class="sd">            res (dict[str, Any]): Todo.</span>
<span class="sd">            include_header (bool): Todo. Defaults to False.</span>
<span class="sd">            line_separation_at_end (bool): Todo.. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Todo.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">cnt</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return length of list/dict at res[key] or zero if absent.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">block</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">include_header</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_history_travel_testing_report_header</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">header_extension</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;External: </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;go_external&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">   &quot;</span> <span class="sa">f</span><span class="s2">&quot;1→1-pref.: </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prioritize_to_one_filter&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Sample  : </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_fraction&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2"> of source IDs&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">header</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">header_extension</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">failure_rows</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Voyage failed (graceful)      &quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">(</span><span class="s2">&quot;history_voyage_failed_gracefully&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;Voyage failed (unknown)       &quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">(</span><span class="s2">&quot;history_voyage_failed_unknown&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;Query not in graph            &quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">(</span><span class="s2">&quot;query_not_in_the_graph&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;Lost item                     &quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">(</span><span class="s2">&quot;lost_item&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;Lost item, but ID exists      &quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">(</span><span class="s2">&quot;lost_item_but_the_same_id_exists&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;Found IDs not accurate        &quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">(</span><span class="s2">&quot;found_ids_not_accurate&quot;</span><span class="p">)),</span>
        <span class="p">]</span>

        <span class="n">clashes</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;clashing_id_type&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">mapping_rows</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;One→one IDs                   &quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">(</span><span class="s2">&quot;one_to_one_ids&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;One→many IDs                  &quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">(</span><span class="s2">&quot;one_to_multiple_ids&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;One→many (single conv.)       &quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">(</span><span class="s2">&quot;one_to_multiple_final_conversion&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;Successfully converted IDs    &quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">(</span><span class="s2">&quot;conversion&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;Clash one→one                 &quot;</span><span class="p">,</span> <span class="n">clashes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">&quot;Clash many→many               &quot;</span><span class="p">,</span> <span class="n">clashes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">&quot;Clash mixed                   &quot;</span><span class="p">,</span> <span class="n">clashes</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="p">]</span>

        <span class="n">report_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">header</span>
            <span class="o">+</span> <span class="n">block</span><span class="p">(</span><span class="s2">&quot;Failure / Anomaly Counts&quot;</span><span class="p">,</span> <span class="n">failure_rows</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">block</span><span class="p">(</span><span class="s2">&quot;Mapping Statistics&quot;</span><span class="p">,</span> <span class="n">mapping_rows</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Total runtime: </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">line_separation_at_end</span><span class="p">:</span>
            <span class="n">report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">report_lines</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Kemal Inecik.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>